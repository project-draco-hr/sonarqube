{
  when(actionPlanDao.findByKey("ABCD")).thenReturn(new ActionPlanDto().setKey("ABCD"));
  when(resourceDao.getResource(any(ResourceQuery.class))).thenReturn(new ResourceDto().setKey("org.sonar.Sample").setId(1l));
  IssueDto issueDto=new IssueDto().setId(100L).setStatus(Issue.STATUS_OPEN).setRuleKey_unit_test_only("squid","s100");
  when(issueDao.selectIssues(any(IssueQuery.class))).thenReturn(newArrayList(issueDto));
  when(issueUpdater.plan(any(DefaultIssue.class),eq((ActionPlan)null),any(IssueChangeContext.class))).thenReturn(true);
  ArgumentCaptor<DefaultIssue> captor=ArgumentCaptor.forClass(DefaultIssue.class);
  actionPlanService.delete("ABCD",userSession);
  verify(actionPlanDao).delete("ABCD");
  verify(authorizationDao).isAuthorizedComponentKey(anyString(),anyInt(),eq(UserRole.ADMIN));
  verify(issueUpdater).plan(captor.capture(),eq((ActionPlan)null),any(IssueChangeContext.class));
  verify(issueStorage).save(newArrayList(captor.getAllValues()));
}
