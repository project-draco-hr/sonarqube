{
  MockUserSession.set().setGlobalPermissions(GlobalPermissions.QUALITY_PROFILE_ADMIN).setLogin("me");
  RuleKey templateRuleKey=RuleKey.of("java","S001");
  dao.insert(dbSession,RuleTesting.newTemplateRule(templateRuleKey));
  dbSession.commit();
  NewRule newRule=NewRule.createForCustomRule("MY_CUSTOM",templateRuleKey).setName("My custom").setHtmlDescription("Some description").setSeverity(Severity.MAJOR).setStatus(RuleStatus.READY).setParameters(ImmutableMap.of("regex","a.*"));
  RuleKey customRuleKey=service.create(newRule);
  dbSession.clearCache();
  RuleDto rule=dao.getNullableByKey(dbSession,customRuleKey);
  assertThat(rule).isNotNull();
}
