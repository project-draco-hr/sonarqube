{
  org.sonar.api.measures.Metric<?> m=metricFinder.findByKey(measure.metric().key());
  if (m == null) {
    throw new IllegalStateException("Unknow metric with key: " + measure.metric().key());
  }
  Measure measureToSave=new Measure(m);
  setValueAccordingToMetricType(measure,m,measureToSave);
  if (measure.inputFile() != null) {
    Formula formula=measure.metric() instanceof org.sonar.api.measures.Metric ? ((org.sonar.api.measures.Metric)measure.metric()).getFormula() : null;
    if (formula instanceof SumChildDistributionFormula && !Scopes.isHigherThanOrEquals(Scopes.FILE,((SumChildDistributionFormula)formula).getMinimumScopeToPersist())) {
      measureToSave.setPersistenceMode(PersistenceMode.MEMORY);
    }
    sensorContext.saveMeasure(measure.inputFile(),measureToSave);
  }
 else {
    sensorContext.saveMeasure(measureToSave);
  }
}
