{
  MockUserSession.set().setLogin("admin").addProjectPermissions(UserRole.ADMIN,project.key());
  assertThat(tester.get(RoleDao.class).selectUserPermissions(session,user.getLogin(),project.getId())).isEmpty();
  assertThat(index.getByKey(project.getKey())).isNull();
  service.addPermission(params(user.getLogin(),null,project.key(),UserRole.USER));
  session.commit();
  assertThat(tester.get(RoleDao.class).selectUserPermissions(session,user.getLogin(),project.getId())).hasSize(1);
  assertThat(index.getByKey(project.getKey())).isNotNull();
}
