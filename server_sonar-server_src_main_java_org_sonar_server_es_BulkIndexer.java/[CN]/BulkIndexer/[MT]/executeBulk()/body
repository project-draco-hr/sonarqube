{
  final BulkRequestBuilder req=this.bulkRequest;
  this.bulkRequest=client.prepareBulk().setRefresh(false);
  semaphore.acquireUninterruptibly();
  req.execute(new ActionListener<BulkResponse>(){
    @Override public void onResponse(    BulkResponse response){
      semaphore.release();
      counter.addAndGet(response.getItems().length);
      List<ActionRequest> retries=Lists.newArrayList();
      for (      BulkItemResponse item : response.getItems()) {
        if (item.isFailed()) {
          ActionRequest retry=req.request().requests().get(item.getItemId());
          retries.add(retry);
        }
      }
      if (!retries.isEmpty()) {
        LOGGER.warn(String.format("%d index requests failed. Trying again.",retries.size()));
        BulkRequestBuilder retryBulk=client.prepareBulk();
        for (        ActionRequest retry : retries) {
          retryBulk.request().add(retry);
        }
        BulkResponse retryBulkResponse=retryBulk.get();
        if (retryBulkResponse.hasFailures()) {
          LOGGER.error("New attempt to index documents failed");
          for (int index=0; index < retryBulkResponse.getItems().length; index++) {
            BulkItemResponse item=retryBulkResponse.getItems()[index];
            if (item.isFailed()) {
              StringBuilder sb=new StringBuilder();
              String msg=sb.append("\n[").append(index).append("]: index [").append(item.getIndex()).append("], type [").append(item.getType()).append("], id [").append(item.getId()).append("], message [").append(item.getFailureMessage()).append("]").toString();
              LOGGER.error(msg);
            }
          }
        }
 else {
          LOGGER.info("New index attempt succeeded");
        }
      }
    }
    @Override public void onFailure(    Throwable e){
      semaphore.release();
      LOGGER.error("Fail to execute bulk index request: " + req,e);
    }
  }
);
}
