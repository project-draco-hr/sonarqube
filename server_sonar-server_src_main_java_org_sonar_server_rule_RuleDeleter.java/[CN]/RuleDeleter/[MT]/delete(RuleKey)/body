{
  DbSession dbSession=dbClient.openSession(false);
  try {
    RuleDto rule=dbClient.ruleDao().selectOrFailByKey(dbSession,ruleKey);
    if (rule.getTemplateId() == null && !rule.getRepositoryKey().equals(RuleDoc.MANUAL_REPOSITORY)) {
      throw new IllegalStateException("Only custom rules and manual rules can be deleted");
    }
    if (rule.getTemplateId() != null) {
      ruleActivator.deactivate(dbSession,rule);
    }
    rule.setStatus(RuleStatus.REMOVED);
    rule.setUpdatedAt(system2.now());
    dbClient.ruleDao().update(dbSession,rule);
    dbSession.commit();
    ruleIndexer.index();
  }
  finally {
    dbSession.close();
  }
}
