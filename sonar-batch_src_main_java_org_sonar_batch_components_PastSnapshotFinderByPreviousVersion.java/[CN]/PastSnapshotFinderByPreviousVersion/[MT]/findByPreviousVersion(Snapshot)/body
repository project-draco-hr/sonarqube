{
  String currentVersion=projectSnapshot.getVersion();
  Integer resourceId=projectSnapshot.getResourceId();
  String hql="from " + Event.class.getSimpleName() + " where name<>:version AND category='Version' AND resourceId=:resourceId ORDER BY date DESC";
  List<Event> events=session.createQuery(hql).setParameter("version",currentVersion).setParameter("resourceId",resourceId).setMaxResults(1).getResultList();
  if (events.isEmpty()) {
    return new PastSnapshot(CoreProperties.TIMEMACHINE_MODE_PREVIOUS_VERSION);
  }
  Event previousVersionEvent=events.get(0);
  Snapshot snapshot=session.getSingleResult(Snapshot.class,"id",previousVersionEvent.getSnapshot().getId());
  return new PastSnapshot(CoreProperties.TIMEMACHINE_MODE_PREVIOUS_VERSION,snapshot.getCreatedAt(),snapshot).setModeParameter(snapshot.getVersion());
}
