{
  String hql="from " + Snapshot.class.getSimpleName() + " where version<>:version AND version IS NOT NULL AND resourceId=:resourceId AND status=:status AND qualifier<>:lib order by createdAt desc";
  List<Snapshot> snapshots=session.createQuery(hql).setParameter("version",projectSnapshot.getVersion()).setParameter("resourceId",projectSnapshot.getResourceId()).setParameter("status",Snapshot.STATUS_PROCESSED).setParameter("lib",Qualifiers.LIBRARY).setMaxResults(1).getResultList();
  PastSnapshot result;
  if (snapshots.isEmpty()) {
    result=new PastSnapshot(CoreProperties.TIMEMACHINE_MODE_PREVIOUS_VERSION);
  }
 else {
    Snapshot snapshot=snapshots.get(0);
    Date targetDate=snapshot.getCreatedAt();
    result=new PastSnapshot(CoreProperties.TIMEMACHINE_MODE_PREVIOUS_VERSION,targetDate,snapshot).setModeParameter(snapshot.getVersion());
  }
  return result;
}
