{
  DbSession batchSession=mock(DbSession.class);
  when(mybatis.openSession(true)).thenReturn(batchSession);
  when(ruleDao.selectBySubCharacteristicId(2,batchSession)).thenReturn(newArrayList(new RuleDto().setSubCharacteristicId(10).setRemediationFunction("LINEAR_OFFSET").setRemediationCoefficient("2h").setRemediationOffset("5min").setDefaultSubCharacteristicId(2).setDefaultRemediationFunction("LINEAR_OFFSET").setDefaultRemediationCoefficient("4h").setDefaultRemediationOffset("15min")));
  when(dao.selectById(2,batchSession)).thenReturn(subCharacteristicDto);
  service.delete(2);
  verify(ruleDao).update(ruleCaptor.capture(),eq(batchSession));
  RuleDto ruleDto=ruleCaptor.getValue();
  assertThat(ruleDto.getUpdatedAt()).isEqualTo(now);
  assertThat(ruleDto.getDefaultSubCharacteristicId()).isNull();
  assertThat(ruleDto.getDefaultRemediationFunction()).isNull();
  assertThat(ruleDto.getDefaultRemediationCoefficient()).isNull();
  assertThat(ruleDto.getDefaultRemediationOffset()).isNull();
  assertThat(ruleDto.getSubCharacteristicId()).isEqualTo(10);
  assertThat(ruleDto.getRemediationFunction()).isEqualTo("LINEAR_OFFSET");
  assertThat(ruleDto.getRemediationCoefficient()).isEqualTo("2h");
  assertThat(ruleDto.getRemediationOffset()).isEqualTo("5min");
  verify(dao).update(characteristicCaptor.capture(),eq(batchSession));
  CharacteristicDto characteristicDto=characteristicCaptor.getValue();
  assertThat(characteristicDto.getId()).isEqualTo(2);
  assertThat(characteristicDto.isEnabled()).isFalse();
  assertThat(characteristicDto.getUpdatedAt()).isEqualTo(now);
  verify(ruleRegistry).reindex(ruleCaptor.getAllValues(),batchSession);
}
