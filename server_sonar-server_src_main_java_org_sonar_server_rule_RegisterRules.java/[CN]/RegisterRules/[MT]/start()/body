{
  TimeProfiler profiler=new TimeProfiler().start("Register rules");
  DbSession session=dbClient.openSession(false);
  try {
    Map<RuleKey,RuleDto> allRules=loadRules(session);
    Map<String,CharacteristicDto> allCharacteristics=loadCharacteristics(session);
    RulesDefinition.Context context=defLoader.load();
    for (    RulesDefinition.ExtendedRepository repoDef : getRepositories(context)) {
      if (languages.get(repoDef.language()) != null) {
        for (        RulesDefinition.Rule ruleDef : repoDef.rules()) {
          registerRule(ruleDef,allRules,allCharacteristics,session);
        }
        session.commit();
      }
    }
    List<RuleDto> activeRules=processRemainingDbRules(allRules.values(),session);
    removeActiveRulesOnStillExistingRepositories(session,activeRules,context);
    session.commit();
  }
  finally {
    session.close();
    profiler.stop();
  }
}
