{
  List<RuleDto> customRules=newArrayList();
  List<RuleDto> removedRules=newArrayList();
  for (  RuleDto rule : existingRules) {
    if (rule.getTemplateId() != null) {
      customRules.add(rule);
    }
 else     if (rule.getStatus() != RuleStatus.REMOVED) {
      removeRule(session,removedRules,rule);
    }
  }
  for (  RuleDto customRule : customRules) {
    RuleDto template=dbClient.ruleDao().selectTemplate(customRule,session);
    if (template != null && template.getStatus() != RuleStatus.REMOVED) {
      if (updateCustomRuleFromTemplateRule(customRule,template)) {
        dbClient.ruleDao().update(session,customRule);
      }
    }
 else {
      removeRule(session,removedRules,customRule);
    }
  }
  session.commit();
  return removedRules;
}
