{
  checkPermission(UserSession.get());
  SqlSession session=myBatis.openSession(false);
  QProfileResult result=new QProfileResult();
  try {
    ValidationMessages messages=ValidationMessages.create();
    RulesProfile importedProfile=xmlProfileParser.parse(new StringReader(xmlBackup),messages);
    processValidationMessages(messages,result);
    if (importedProfile != null) {
      DatabaseSession hibernateSession=sessionFactory.getSession();
      checkProfileDoesNotExists(importedProfile,deleteExisting,hibernateSession);
      hibernateSession.saveWithoutFlush(importedProfile);
      hibernateSession.commit();
      QProfile newProfile=qProfileLookup.profile(importedProfile.getId(),session);
      if (newProfile == null) {
        throw new BadRequestException("Restore of the profile has failed.");
      }
      dryRunCache.reportGlobalModification(session);
      session.commit();
      result.setProfile(newProfile);
    }
  }
  finally {
    MyBatis.closeQuietly(session);
  }
  return result;
}
