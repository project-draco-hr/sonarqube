{
  Bucket bucket=buckets.get(resource);
  if (bucket != null) {
    return bucket;
  }
  if (lock.isLocked() && !ResourceUtils.isLibrary(resource)) {
    LOG.warn("The following resource has not been registered before saving data: " + resource);
  }
  bucket=new Bucket(resource);
  Bucket parentBucket=null;
  Resource parent=resource.getParent();
  if (parent != null) {
    parentBucket=getOrAddBucket(parent);
  }
 else   if (!ResourceUtils.isLibrary(resource)) {
    parentBucket=buckets.get(currentProject);
  }
  bucket.setParent(parentBucket);
  buckets.put(resource,bucket);
  boolean excluded=checkExclusion(resource,parentBucket);
  if (!excluded) {
    persistence.saveResource(currentProject,resource);
  }
  return bucket;
}
