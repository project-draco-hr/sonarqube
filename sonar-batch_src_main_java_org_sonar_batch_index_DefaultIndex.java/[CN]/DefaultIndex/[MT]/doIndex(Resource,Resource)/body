{
  Bucket bucket=getBucket(resource);
  if (bucket != null) {
    return bucket;
  }
  if (StringUtils.isBlank(resource.getKey())) {
    LOG.warn("Unable to index a resource without key " + resource);
    return null;
  }
  checkLock(resource);
  Resource parent=null;
  if (!ResourceUtils.isLibrary(resource)) {
    parent=(Resource)ObjectUtils.defaultIfNull(parentReference,currentProject);
  }
  Bucket parentBucket=getBucket(parent,true);
  if (parentBucket == null && parent != null) {
    LOG.warn("Resource ignored, parent is not indexed: " + resource);
    return null;
  }
  resource.setEffectiveKey(ComponentKeys.createEffectiveKey(currentProject,resource));
  bucket=new Bucket(resource).setParent(parentBucket);
  buckets.put(resource,bucket);
  boolean excluded=checkExclusion(resource,parentBucket);
  if (!excluded) {
    Resource parentSnapshot=parentBucket != null ? parentBucket.getResource() : null;
    Snapshot snapshot=persistence.saveResource(currentProject,resource,parentSnapshot);
    if (ResourceUtils.isPersistable(resource) && !Qualifiers.LIBRARY.equals(resource.getQualifier())) {
      graph.addComponent(resource,snapshot);
    }
  }
  return bucket;
}
