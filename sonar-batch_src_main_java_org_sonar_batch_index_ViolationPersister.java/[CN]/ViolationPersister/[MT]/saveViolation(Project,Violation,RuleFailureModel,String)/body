{
  Snapshot snapshot=resourcePersister.saveResource(project,violation.getResource());
  RuleFailureModel model=createModel(violation);
  if (pastViolation != null) {
    model.setCreatedAt(pastViolation.getCreatedAt());
    model.setPermanentId(pastViolation.getPermanentId());
    model.setSwitchedOff(pastViolation.isSwitchedOff());
  }
 else {
    model.setCreatedAt(snapshot.getCreatedAt());
  }
  model.setSnapshotId(snapshot.getId());
  model.setChecksum(checksum);
  session.saveWithoutFlush(model);
  if (model.getPermanentId() == null) {
    model.setPermanentId(model.getId());
    session.saveWithoutFlush(model);
  }
  violation.setMessage(model.getMessage());
  violation.setCreatedAt(model.getCreatedAt());
  violation.setSwitchedOff(model.isSwitchedOff());
}
