{
  Snapshot snapshot=resourcePersister.saveResource(project,violation.getResource());
  if (snapshot == null) {
    return;
  }
  RuleFailureModel model;
  if (oldModel != null) {
    model=session.reattach(RuleFailureModel.class,oldModel.getId());
    model=mergeModel(violation,oldModel);
  }
 else {
    model=createModel(violation);
  }
  model.setSnapshotId(snapshot.getId());
  session.save(model);
}
