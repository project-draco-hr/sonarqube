{
  RulesProfile profile=getSession().getEntity(RulesProfile.class,profileId);
  if (profile != null && !profile.getProvided()) {
    RulesProfile oldParent=getParentProfile(profile);
    RulesProfile newParent=getProfile(profile.getLanguage(),parentName);
    if (isCycle(profile,newParent)) {
      return;
    }
    if (oldParent != null) {
      for (      ActiveRule activeRule : oldParent.getActiveRules()) {
        deactivate(profile,activeRule.getRule());
      }
    }
    if (newParent != null) {
      for (      ActiveRule activeRule : newParent.getActiveRules()) {
        activateOrChange(profile,activeRule);
      }
    }
    profile.setParentName(newParent == null ? null : newParent.getName());
    getSession().saveWithoutFlush(profile);
    getSession().commit();
  }
}
