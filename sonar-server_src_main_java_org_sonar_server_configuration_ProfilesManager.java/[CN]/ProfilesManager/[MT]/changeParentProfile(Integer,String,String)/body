{
  ValidationMessages messages=ValidationMessages.create();
  RulesProfile profile=getSession().getEntity(RulesProfile.class,profileId);
  if (profile != null && !profile.getProvided()) {
    RulesProfile oldParent=getParentProfile(profile);
    RulesProfile newParent=getProfile(profile.getLanguage(),parentName);
    if (isCycle(profile,newParent)) {
      messages.addWarningText("Please do not select a child profile as parent.");
      return messages;
    }
    if (oldParent != null) {
      for (      ActiveRule activeRule : oldParent.getActiveRules()) {
        deactivate(profile,activeRule.getRule(),userLogin);
      }
    }
    if (newParent != null) {
      for (      ActiveRule activeRule : newParent.getActiveRules()) {
        activateOrChange(profile,activeRule,userLogin);
      }
    }
    profile.setParentName(newParent == null ? null : newParent.getName());
    getSession().saveWithoutFlush(profile);
    getSession().commit();
  }
  return messages;
}
