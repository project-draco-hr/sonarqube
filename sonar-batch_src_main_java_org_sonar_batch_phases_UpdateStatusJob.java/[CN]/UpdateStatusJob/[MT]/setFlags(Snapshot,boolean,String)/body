{
  String hql="UPDATE " + Snapshot.class.getSimpleName() + " SET last=:last";
  if (status != null) {
    hql+=", status=:status ";
  }
  hql+=" WHERE root_snapshot_id=:rootId OR id=:rootId OR (path LIKE :path AND root_snapshot_id=:pathRootId)";
  Query query=session.createQuery(hql);
  if (status != null) {
    query.setParameter("status",status);
    snapshot.setStatus(status);
  }
  query.setParameter("last",last);
  query.setParameter("rootId",snapshot.getId());
  query.setParameter("path",snapshot.getPath() + snapshot.getId() + ".%");
  query.setParameter("pathRootId",snapshot.getRootId() == null ? snapshot.getId() : snapshot.getRootId());
  query.executeUpdate();
  session.commit();
  snapshot.setLast(last);
}
