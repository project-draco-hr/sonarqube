{
  Collection<Object> deletedComponentKeys=issueCache.componentKeys();
  for (  BatchComponent resource : resourceCache.all()) {
    String componentKey=resource.resource().getEffectiveKey();
    Iterable<DefaultIssue> issues=issueCache.byComponent(componentKey);
    writer.writeComponentIssues(resource.batchId(),Iterables.transform(issues,new Function<DefaultIssue,BatchReport.Issue>(){
      private BatchReport.Issue.Builder builder=BatchReport.Issue.newBuilder();
      @Override public BatchReport.Issue apply(      DefaultIssue input){
        return toReportIssue(builder,input);
      }
    }
));
    deletedComponentKeys.remove(componentKey);
  }
  int count=exportIssuesOfDeletedComponents(deletedComponentKeys,writer);
  exportMetadata(writer,count);
}
