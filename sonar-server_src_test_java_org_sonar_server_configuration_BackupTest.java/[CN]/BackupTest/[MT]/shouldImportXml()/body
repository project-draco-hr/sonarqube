{
  Backup backup=new Backup(Arrays.asList(new MetricsBackup(null),new PropertiesBackup(null),new RulesBackup((DatabaseSession)null),new ProfilesBackup((DatabaseSession)null)));
  String xml=getFileFromClasspath("backup-restore-valid.xml");
  SonarConfig sonarConfig=backup.getSonarConfigFromXml(xml);
  assertTrue(CollectionUtils.isEqualCollection(sonarConfig.getMetrics(),getMetrics()));
  assertTrue(CollectionUtils.isEqualCollection(sonarConfig.getProperties(),getProperties()));
  for (  Metric metric : sonarConfig.getMetrics()) {
    assertNotNull(metric.getEnabled());
    assertTrue(metric.getEnabled());
    assertNotNull(metric.getUserManaged());
    assertTrue(metric.getUserManaged());
  }
  Collection<RulesProfile> profiles=sonarConfig.getProfiles();
  assertEquals(2,profiles.size());
  Iterator<RulesProfile> profilesIter=profiles.iterator();
  RulesProfile testProfile=profilesIter.next();
  assertEquals("test name",testProfile.getName());
  assertEquals(true,testProfile.getDefaultProfile());
  assertEquals("test language",testProfile.getLanguage());
  assertEquals(1,testProfile.getActiveRules().size());
  ActiveRule testActiveRule=testProfile.getActiveRules().get(0);
  assertEquals(RulePriority.MAJOR,testActiveRule.getSeverity());
  assertNotNull(testActiveRule.getRule());
  assertEquals("test key",testActiveRule.getRule().getKey());
  assertEquals("test plugin",testActiveRule.getRule().getRepositoryKey());
  assertThat(testActiveRule.getInheritanceStatus(),is(ActiveRuleInheritanceStatus.NO));
  assertEquals(1,testActiveRule.getActiveRuleParams().size());
  ActiveRuleParam testActiveRuleParam=testActiveRule.getActiveRuleParams().get(0);
  assertEquals("test value",testActiveRuleParam.getValue());
  assertNotNull(testActiveRuleParam.getRuleParam());
  assertEquals("test param key",testActiveRuleParam.getRuleParam().getKey());
  assertEquals(1,testProfile.getAlerts().size());
  Alert testAlert=testProfile.getAlerts().get(0);
  assertEquals(Alert.OPERATOR_GREATER,testAlert.getOperator());
  assertEquals("testError",testAlert.getValueError());
  assertEquals("testWarn",testAlert.getValueWarning());
  assertNotNull(testAlert.getMetric());
  assertEquals("test key",testAlert.getMetric().getKey());
  testProfile=profilesIter.next();
  assertEquals("test2 name",testProfile.getName());
  assertEquals("test name",testProfile.getParentName());
  testActiveRule=testProfile.getActiveRules().get(0);
  assertThat(testActiveRule.getInheritanceStatus(),is(ActiveRuleInheritanceStatus.OVERRIDDEN));
  Collection<Rule> rules=sonarConfig.getRules();
  assertThat(rules.size(),is(1));
  Rule rule=rules.iterator().next();
  assertThat(rule.getParent().getRepositoryKey(),is("test plugin"));
  assertThat(rule.getParent().getKey(),is("test key"));
  assertThat(rule.getRepositoryKey(),is("test plugin"));
  assertThat(rule.getKey(),is("test key2"));
  assertThat(rule.getConfigKey(),is("test config key"));
  assertThat(rule.getName(),is("test name"));
  assertThat(rule.getDescription(),is("test description"));
  assertThat(rule.getSeverity(),is(RulePriority.INFO));
  assertThat(rule.getParams().size(),is(1));
  RuleParam param=rule.getParams().get(0);
  assertThat(param.getKey(),is("test param key"));
  assertThat(param.getDefaultValue(),is("test param value"));
}
