{
  DbSession dbSession=db.openSession(false);
  try {
    RuleIndex ruleIndex=index.get(RuleIndex.class);
    BulkChangeResult result=new BulkChangeResult();
    RuleResult ruleSearchResult=ruleIndex.search(ruleQuery,new QueryOptions().setScroll(true));
    Iterator<Rule> rules=ruleSearchResult.scroll();
    while (rules.hasNext()) {
      Rule rule=rules.next();
      ActiveRuleKey key=ActiveRuleKey.of(profile,rule.key());
      List<ActiveRuleChange> changes=deactivate(dbSession,key);
      result.addChanges(changes);
      result.incrementSucceeded();
    }
    dbSession.commit();
    return result;
  }
  finally {
    dbSession.close();
  }
}
