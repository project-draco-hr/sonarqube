{
  RuleIndex ruleIndex=index.get(RuleIndex.class);
  Multimap<String,String> results=ArrayListMultimap.create();
  DbSession dbSession=db.openSession(false);
  try {
    RuleResult result=ruleIndex.search(ruleQuery,new QueryOptions().setScroll(true));
    Iterator<Rule> rules=result.scroll();
    while (rules.hasNext()) {
      Rule rule=rules.next();
      ActiveRuleKey key=ActiveRuleKey.of(profile,rule.key());
      for (      ActiveRuleChange deActive : deactivate(dbSession,key)) {
        results.put(DEACTIVATED,deActive.getKey().ruleKey().toString());
      }
    }
    dbSession.commit();
  }
  finally {
    dbSession.close();
  }
  return results;
}
