{
  RuleIndex ruleIndex=index.get(RuleIndex.class);
  Multimap<String,String> results=ArrayListMultimap.create();
  DbSession dbSession=db.openSession(false);
  try {
    RuleResult result=ruleIndex.search(ruleQuery,new QueryOptions().setMaxLimit().setFieldsToReturn(ImmutableSet.of(RuleNormalizer.RuleField.IS_TEMPLATE.field())));
    for (    Rule rule : result.getHits()) {
      if (!rule.isTemplate()) {
        ActiveRuleKey key=ActiveRuleKey.of(profileKey,rule.key());
        RuleActivation activation=new RuleActivation(key);
        activation.setSeverity(severity);
        for (        ActiveRuleChange active : activate(dbSession,activation)) {
          results.put("activated",active.getKey().ruleKey().toString());
        }
      }
 else {
        results.put("ignored",rule.key().toString());
      }
    }
    dbSession.commit();
  }
  finally {
    dbSession.close();
  }
  return results;
}
