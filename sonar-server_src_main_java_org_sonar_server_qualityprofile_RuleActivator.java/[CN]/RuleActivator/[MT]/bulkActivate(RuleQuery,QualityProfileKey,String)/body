{
  BulkChangeResult result=new BulkChangeResult();
  RuleIndex ruleIndex=index.get(RuleIndex.class);
  DbSession dbSession=db.openSession(false);
  try {
    RuleResult ruleSearchResult=ruleIndex.search(ruleQuery,new QueryOptions().setScroll(true));
    Iterator<Rule> rules=ruleSearchResult.scroll();
    while (rules.hasNext()) {
      Rule rule=rules.next();
      try {
        ActiveRuleKey key=ActiveRuleKey.of(profileKey,rule.key());
        RuleActivation activation=new RuleActivation(key);
        activation.setSeverity(severity);
        List<ActiveRuleChange> changes=activate(dbSession,activation);
        result.addChanges(changes);
        result.incrementSucceeded();
      }
 catch (      BadRequestException e) {
        result.incrementFailed();
      }
    }
    dbSession.commit();
  }
  finally {
    dbSession.close();
  }
  return result;
}
