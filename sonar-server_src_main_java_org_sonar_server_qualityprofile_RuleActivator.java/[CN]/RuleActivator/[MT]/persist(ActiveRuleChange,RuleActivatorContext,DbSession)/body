{
  ActiveRuleDao dao=db.activeRuleDao();
  ActiveRuleDto activeRule=null;
  if (change.getType() == ActiveRuleChange.Type.ACTIVATED) {
    activeRule=ActiveRuleDto.createFor(context.profile(),context.rule());
    activeRule.setSeverity(change.getSeverity());
    if (change.getInheritance() != null) {
      activeRule.setInheritance(change.getInheritance().name());
    }
    dao.insert(dbSession,activeRule);
    for (    Map.Entry<String,String> param : change.getParameters().entrySet()) {
      if (param.getValue() != null) {
        ActiveRuleParamDto paramDto=ActiveRuleParamDto.createFor(context.ruleParamsByKeys().get(param.getKey()));
        paramDto.setValue(param.getValue());
        dao.addParam(dbSession,activeRule,paramDto);
      }
    }
  }
 else   if (change.getType() == ActiveRuleChange.Type.DEACTIVATED) {
    dao.deleteByKey(dbSession,change.getKey());
  }
 else   if (change.getType() == ActiveRuleChange.Type.UPDATED) {
    activeRule=context.activeRule();
    activeRule.setSeverity(change.getSeverity());
    if (change.getInheritance() != null) {
      activeRule.setInheritance(change.getInheritance().name());
    }
    dao.update(dbSession,activeRule);
    for (    Map.Entry<String,String> param : change.getParameters().entrySet()) {
      ActiveRuleParamDto activeRuleParamDto=context.activeRuleParamsAsMap().get(param.getKey());
      if (activeRuleParamDto == null) {
        if (param.getValue() != null) {
          activeRuleParamDto=ActiveRuleParamDto.createFor(context.ruleParamsByKeys().get(param.getKey()));
          activeRuleParamDto.setValue(param.getValue());
          dao.addParam(dbSession,activeRule,activeRuleParamDto);
        }
      }
 else {
        if (param.getValue() != null) {
          activeRuleParamDto.setValue(param.getValue());
          dao.updateParam(dbSession,activeRule,activeRuleParamDto);
        }
 else {
          dao.deleteParam(dbSession,activeRule,activeRuleParamDto);
        }
      }
    }
  }
  return activeRule;
}
