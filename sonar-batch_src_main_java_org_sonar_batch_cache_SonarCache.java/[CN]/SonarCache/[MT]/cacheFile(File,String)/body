{
  LOG.debug("Trying to cache file {} with filename {}",sourceFile.getAbsolutePath(),filename);
  File tmpFileName=null;
  try {
    if (!sourceFile.getParentFile().equals(getTmpDir())) {
      tmpFileName=getTemporaryFile();
      Files.move(sourceFile,tmpFileName);
    }
 else {
      tmpFileName=sourceFile;
    }
    String md5;
    FileInputStream fis=null;
    try {
      fis=new FileInputStream(tmpFileName);
      md5=DigestUtils.md5Hex(fis);
    }
  finally {
      Closeables.closeQuietly(fis);
    }
    File finalDir=new File(cacheLocation,md5);
    File finalFileName=new File(finalDir,filename);
    FileUtils.forceMkdir(finalDir);
    boolean rename=tmpFileName.renameTo(finalFileName);
    if (!rename) {
      if (!finalFileName.exists()) {
        LOG.warn("Unable to rename {} to {}",tmpFileName.getAbsolutePath(),finalFileName.getAbsolutePath());
        LOG.warn("A copy/delete will be tempted but with no garantee of atomicity");
        FileUtils.moveFile(tmpFileName,finalFileName);
      }
    }
    LOG.debug("File cached at {}",finalFileName.getAbsolutePath());
    return md5;
  }
  finally {
    FileUtils.deleteQuietly(tmpFileName);
  }
}
