{
  Measure result=null;
  double totalByMeasure=0;
  double totalMainMeasure=0;
  boolean hasApplicableChildren=false;
  for (  FormulaData childrenData : data.getChildren()) {
    Double fallbackMeasure=fallbackMetric != null ? MeasureUtils.getValue(childrenData.getMeasure(fallbackMetric),null) : null;
    Double childrenByMeasure=MeasureUtils.getValue(childrenData.getMeasure(byMetric),null);
    Double childrenMainMeasure=MeasureUtils.getValue(childrenData.getMeasure(mainMetric),fallbackMeasure);
    if (childrenMainMeasure != null && childrenByMeasure != null && childrenByMeasure > 0.0) {
      totalByMeasure+=childrenByMeasure;
      totalMainMeasure+=childrenMainMeasure;
      hasApplicableChildren=true;
    }
  }
  if (hasApplicableChildren) {
    result=new Measure(context.getTargetMetric(),(totalMainMeasure / totalByMeasure));
  }
  return result;
}
