{
  SnapshotDto referenceSnapshot;
  try {
    referenceSnapshot=dbClient.snapshotDao().getByKey(session,report.getSnapshotId());
  }
 catch (  Exception exception) {
    throw new IllegalStateException(String.format("Unexpected error while trying to retrieve snapshot of analysis %s",report),exception);
  }
  List<SnapshotDto> snapshots=dbClient.snapshotDao().findSnapshotAndChildrenOfProjectScope(session,referenceSnapshot);
  for (  SnapshotDto snapshot : snapshots) {
    SnapshotDto previousLastSnapshot=dbClient.snapshotDao().getLastSnapshot(session,snapshot);
    if (previousLastSnapshot != null) {
      dbClient.snapshotDao().updateSnapshotAndChildrenLastFlag(session,previousLastSnapshot,false);
      session.commit();
    }
  }
}
