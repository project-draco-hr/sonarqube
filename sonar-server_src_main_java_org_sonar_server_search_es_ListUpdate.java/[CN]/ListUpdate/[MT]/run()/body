{
  try {
    Map<String,Object> source=XContentMapValues.nodeMapValue(ctx.get("_source"),"source from context");
    Object fieldValue=source.get(field);
    if (fieldValue == null && value != null) {
      source.put(field,value);
    }
 else     if (!XContentMapValues.isArray(fieldValue) && value != null) {
      Map currentFieldValue=XContentMapValues.nodeMapValue(fieldValue,"current FieldValue");
      if (XContentMapValues.nodeStringValue(currentFieldValue.get(idField),null).equals(idValue)) {
        source.put(field,value);
      }
 else {
        source.put(field,ImmutableSet.of(fieldValue,value));
      }
    }
 else {
      Collection items=((Collection)fieldValue);
      Object target=null;
      for (      Object item : items) {
        Map<String,Object> fields=(Map<String,Object>)item;
        String itemIdValue=XContentMapValues.nodeStringValue(fields.get(idField),null);
        if (itemIdValue != null && itemIdValue.equals(idValue)) {
          target=item;
          break;
        }
      }
      if (target != null) {
        items.remove(target);
      }
      if (value != null) {
        items.add(value);
      }
      source.put(field,items);
    }
  }
 catch (  Exception e) {
    throw new IllegalStateException("failed to execute listUpdate script",e);
  }
  return null;
}
