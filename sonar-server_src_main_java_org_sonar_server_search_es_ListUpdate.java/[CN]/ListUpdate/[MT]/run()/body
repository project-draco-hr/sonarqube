{
  Map<String,Object> source=XContentMapValues.nodeMapValue(ctx.get("_source"),"source from context");
  Object fieldValue=source.get(field);
  if (fieldValue == null) {
    source.put(field,value);
  }
 else   if (!XContentMapValues.isArray(fieldValue)) {
    source.put(field,ImmutableSet.of(fieldValue,value));
  }
 else {
    Collection items=((Collection)fieldValue);
    for (    Object item : items) {
      Map<String,Object> fields=(Map<String,Object>)item;
      String itemIdValue=XContentMapValues.nodeStringValue(fields.get(idField),null);
      if (itemIdValue != null && itemIdValue.equals(idValue)) {
        items.remove(item);
      }
    }
    items.add(value);
    source.put(field,items);
  }
  return null;
}
