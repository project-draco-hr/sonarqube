{
  Charset sourcesEncoding=fileSystem.sourceCharset();
  List<File> files;
  List<File> dirs;
  if (isTest) {
    files=fileSystem.files(FileQuery.onTest().onLanguage(project.getLanguageKey()));
    dirs=fileSystem.testDirs();
  }
 else {
    files=fileSystem.files(FileQuery.onSource().onLanguage(project.getLanguageKey()));
    dirs=fileSystem.sourceDirs();
  }
  for (  File inputFile : files) {
    try {
      String componentKey=resolveComponent(inputFile,dirs,project,isTest);
      if (componentKey != null) {
        String relativePath=pathResolver.relativePath(dirs,inputFile).path();
        inclusionPatternInitializer.initializePatternsForPath(relativePath,componentKey);
        exclusionPatternInitializer.initializePatternsForPath(relativePath,componentKey);
        if (exclusionPatternInitializer.hasFileContentPattern()) {
          regexpScanner.scan(componentKey,inputFile,sourcesEncoding);
        }
      }
    }
 catch (    Exception e) {
      throw new SonarException("Unable to read the source file : '" + inputFile.getAbsolutePath() + "' with the charset : '"+ sourcesEncoding.name()+ "'.",e);
    }
  }
}
