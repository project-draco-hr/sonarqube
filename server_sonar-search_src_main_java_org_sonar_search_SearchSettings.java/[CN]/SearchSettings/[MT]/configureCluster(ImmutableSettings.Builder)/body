{
  int replicationFactor=0;
  if (inCluster()) {
    replicationFactor=1;
    if (isMaster()) {
      LOGGER.info("Elasticsearch cluster enabled. Master node.");
      builder.put("node.master",true);
    }
 else     if (!masterHosts.isEmpty()) {
      LOGGER.info("Elasticsearch cluster enabled. Node connecting to master: {}",masterHosts);
      builder.put("discovery.zen.ping.unicast.hosts",StringUtils.join(masterHosts,","));
      builder.put("node.master",false);
      builder.put("discovery.zen.minimum_master_nodes",1);
    }
 else {
      throw new MessageException(String.format("Not an Elasticsearch master nor slave. Please check properties %s and %s",ProcessConstants.CLUSTER_MASTER,ProcessConstants.CLUSTER_MASTER_HOST));
    }
  }
  builder.put(IndexMetaData.SETTING_NUMBER_OF_REPLICAS,replicationFactor);
  builder.put("cluster.name",clusterName);
  builder.put("cluster.routing.allocation.awareness.attributes","rack_id");
  builder.put("node.rack_id",props.value(ProcessConstants.CLUSTER_NODE_NAME,"unknown"));
  builder.put("node.name",props.value(ProcessConstants.CLUSTER_NODE_NAME));
}
