{
  when(userDao.selectByLogin(dbSession,USER_IDENTITY.getLogin())).thenReturn(null);
  when(userDao.selectOrFailByLogin(dbSession,USER_IDENTITY.getLogin())).thenReturn(ACTIVE_USER);
  TestIdentityProvider identityProvider=new TestIdentityProvider().setKey("github").setName("Github").setEnabled(true).setAllowsUsersToSignUp(false);
  thrown.expect(UnauthorizedException.class);
  thrown.expectMessage("'github' users are not allowed to sign up");
  underTest.authenticate(USER_IDENTITY,identityProvider,httpSession);
}
