{
  when(userDao.selectByExternalIdentity(dbSession,USER_IDENTITY.getId(),IDENTITY_PROVIDER.getKey())).thenReturn(Optional.<UserDto>absent());
  when(userDao.selectOrFailByExternalIdentity(dbSession,USER_IDENTITY.getId(),IDENTITY_PROVIDER.getKey())).thenReturn(ACTIVE_USER);
  TestIdentityProvider identityProvider=new TestIdentityProvider().setKey("github").setName("Github").setEnabled(true).setAllowsUsersToSignUp(false);
  thrown.expect(NotAllowUserToSignUpException.class);
  underTest.authenticate(USER_IDENTITY,identityProvider,httpSession);
}
