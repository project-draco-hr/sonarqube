{
  deprecatedViolations=mock(DeprecatedViolations.class);
  MetricFinder metricFinder=mock(MetricFinder.class);
  when(metricFinder.findByKey("ncloc")).thenReturn(CoreMetrics.NCLOC);
  ruleFinder=mock(RuleFinder.class);
  ProjectTree projectTree=mock(ProjectTree.class);
  ResourcePersister resourcePersister=mock(ResourcePersister.class);
  index=new DefaultIndex(resourcePersister,null,null,null,projectTree,metricFinder,mock(ScanGraph.class),deprecatedViolations,mock(ResourceKeyMigration.class),mock(MeasureCache.class));
  baseDir=temp.newFolder();
  project=new Project("project");
  when(projectTree.getProjectDefinition(project)).thenReturn(ProjectDefinition.create().setBaseDir(baseDir));
  moduleA=new Project("moduleA").setParent(project);
  when(projectTree.getProjectDefinition(moduleA)).thenReturn(ProjectDefinition.create().setBaseDir(new java.io.File(baseDir,"moduleA")));
  moduleB=new Project("moduleB").setParent(project);
  when(projectTree.getProjectDefinition(moduleB)).thenReturn(ProjectDefinition.create().setBaseDir(new java.io.File(baseDir,"moduleB")));
  moduleB1=new Project("moduleB1").setParent(moduleB);
  when(projectTree.getProjectDefinition(moduleB1)).thenReturn(ProjectDefinition.create().setBaseDir(new java.io.File(baseDir,"moduleB/moduleB1")));
  when(resourcePersister.saveResource(any(Project.class),any(Resource.class),any(Resource.class))).thenReturn(new BatchResource(1,mock(Resource.class),new Snapshot().setId(1),null));
  RulesProfile rulesProfile=RulesProfile.create();
  rule=Rule.create("repoKey","ruleKey","Rule");
  rule.setId(1);
  rulesProfile.activateRule(rule,null);
  index.setCurrentProject(project,mock(ModuleIssues.class));
  index.doStart(project);
}
