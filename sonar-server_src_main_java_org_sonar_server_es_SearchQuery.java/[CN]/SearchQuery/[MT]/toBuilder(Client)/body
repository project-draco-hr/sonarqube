{
  SearchRequestBuilder builder=client.prepareSearch(indices.toArray(new String[0])).setTypes(types.toArray(new String[0]));
  if (fieldCriteria.isEmpty() && notFieldCriteria.isEmpty() && StringUtils.isBlank(searchString)) {
    builder.setPostFilter(new MatchAllFilterBuilder());
  }
 else {
    BoolFilterBuilder boolFilter=boolFilter();
    Iterator<String> mustCriteriaIterator=fieldCriteria.keySet().iterator();
    while (mustCriteriaIterator.hasNext()) {
      String field=mustCriteriaIterator.next();
      if (fieldCriteria.get(field).size() > 1) {
        boolFilter.must(termsFilter(field,fieldCriteria.get(field)));
      }
 else {
        boolFilter.must(termFilter(field,fieldCriteria.get(field)));
      }
    }
    for (    String field : notFieldCriteria.keySet()) {
      if (notFieldCriteria.get(field).size() > 1) {
        boolFilter.mustNot(termsFilter(field,notFieldCriteria.get(field)));
      }
 else {
        boolFilter.mustNot(termFilter(field,notFieldCriteria.get(field)));
      }
    }
    if (StringUtils.isNotBlank(searchString)) {
      boolFilter.must(queryFilter(QueryBuilders.queryString(searchString).defaultOperator(Operator.AND).allowLeadingWildcard(false)));
    }
    builder.setPostFilter(boolFilter);
  }
  return builder;
}
