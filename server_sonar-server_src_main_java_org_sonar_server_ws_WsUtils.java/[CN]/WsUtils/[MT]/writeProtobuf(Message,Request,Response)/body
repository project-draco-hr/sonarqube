{
  OutputStream output=response.stream().output();
  try {
    if (request.getMediaType().equals(MediaTypes.PROTOBUF)) {
      response.stream().setMediaType(MediaTypes.PROTOBUF);
      msg.writeTo(output);
    }
 else {
      response.stream().setMediaType(MediaTypes.JSON);
      try (OutputStreamWriter writer=new OutputStreamWriter(output,StandardCharsets.UTF_8)){
        ProtobufJsonFormat.write(msg,JsonWriter.of(writer));
      }
     }
  }
 catch (  Exception e) {
    throw new IllegalStateException(format("Error while writing protobuf message %s",MessageFormatter.print(msg)),e);
  }
 finally {
    IOUtils.closeQuietly(output);
  }
}
