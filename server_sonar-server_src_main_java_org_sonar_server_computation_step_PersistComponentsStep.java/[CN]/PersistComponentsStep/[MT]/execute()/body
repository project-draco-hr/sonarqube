{
  DbSession session=dbClient.openSession(false);
  try {
    org.sonar.server.computation.component.Component root=treeRootHolder.getRoot();
    List<ComponentDto> existingComponents=dbClient.componentDao().selectComponentsFromProjectKey(session,root.getKey());
    Map<String,ComponentDto> existingComponentDtosByKey=componentDtosByKey(existingComponents);
    PersistComponentExecutor persistComponentExecutor=new PersistComponentExecutor(session,existingComponentDtosByKey,reportReader);
    persistComponentExecutor.recursivelyProcessComponent(root,null);
    session.commit();
  }
  finally {
    session.close();
  }
}
