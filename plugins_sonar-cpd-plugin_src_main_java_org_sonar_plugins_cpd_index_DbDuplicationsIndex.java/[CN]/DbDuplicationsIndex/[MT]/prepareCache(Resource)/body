{
  int resourceSnapshotId=getSnapshotIdFor(resource);
  String languageKey=resource.getLanguage().getKey();
  List<DuplicationUnitDto> units=dao.selectCandidates(resourceSnapshotId,lastSnapshotId,languageKey);
  cache.clear();
  for (  DuplicationUnitDto unit : units) {
    String hash=unit.getHash();
    String resourceKey=unit.getResourceKey();
    int indexInFile=unit.getIndexInFile();
    int startLine=unit.getStartLine();
    int endLine=unit.getEndLine();
    Block block=new Block(resourceKey,new ByteArray(hash),indexInFile,startLine,endLine);
    Collection<Block> sameHash=cache.get(block.getBlockHash());
    if (sameHash == null) {
      sameHash=Lists.newArrayList();
      cache.put(block.getBlockHash(),sameHash);
    }
    sameHash.add(block);
  }
}
