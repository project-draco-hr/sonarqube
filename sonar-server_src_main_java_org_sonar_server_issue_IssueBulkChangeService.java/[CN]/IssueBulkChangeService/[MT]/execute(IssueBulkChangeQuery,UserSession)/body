{
  LOG.debug("BulkChangeQuery : {}",issueBulkChangeQuery);
  verifyLoggedIn(userSession);
  IssueBulkChangeResult result=new IssueBulkChangeResult();
  IssueQueryResult issueQueryResult=issueFinder.find(IssueQuery.builder().issueKeys(issueBulkChangeQuery.issues()).pageSize(-1).requiredRole(UserRole.USER).build());
  List<Issue> issues=issueQueryResult.issues();
  List<Action> bulkActions=newArrayList();
  for (  String actionName : issueBulkChangeQuery.actions()) {
    Action action=getAction(actionName);
    if (action == null) {
      throw new IllegalArgumentException("The action : '" + actionName + "' is unknown");
    }
    action.verify(issueBulkChangeQuery.properties(actionName),issues,userSession);
    bulkActions.add(action);
  }
  IssueChangeContext issueChangeContext=IssueChangeContext.createUser(new Date(),userSession.login());
  for (  Issue issue : issues) {
    ActionContext actionContext=new ActionContext(issue,issueChangeContext);
    for (    Action action : bulkActions) {
      try {
        if (action.supports(issue) && action.execute(issueBulkChangeQuery.properties(action.key()),actionContext)) {
          result.addIssueChanged(issue);
        }
 else {
          result.addIssueNotChanged(issue);
        }
      }
 catch (      Exception e) {
        result.addIssueNotChanged(issue);
        LOG.info("An error occur when trying to apply the action : " + action.key() + " on issue : "+ issue.key()+ ". This issue has been ignored.",e);
      }
    }
    if (result.issuesChanged().contains(issue)) {
      issueStorage.save((DefaultIssue)issue);
      issueNotifications.sendChanges((DefaultIssue)issue,issueChangeContext,issueQueryResult);
    }
  }
  return result;
}
