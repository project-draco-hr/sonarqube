{
  Snapshot snapshot=persister.saveResource(project,violation.getResource());
  RuleFailureModel model=createModel(violation);
  if (referenceViolation != null) {
    model.setPermanentId(referenceViolation.getPermanentId());
  }
  model.setSnapshotId(snapshot.getId());
  session.saveWithoutFlush(model);
  if (model.getPermanentId() == null) {
    model.setPermanentId(model.getId());
    session.saveWithoutFlush(model);
  }
  violation.setMessage(model.getMessage());
}
