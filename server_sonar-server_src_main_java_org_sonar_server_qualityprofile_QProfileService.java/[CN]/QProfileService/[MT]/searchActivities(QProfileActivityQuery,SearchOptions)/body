{
  DbSession session=db.openSession(false);
  try {
    SearchResponse response=activityIndex.doSearch(query,options);
    Result<QProfileActivity> result=new Result<>(response);
    for (    SearchHit hit : response.getHits().getHits()) {
      QProfileActivity profileActivity=new QProfileActivity(hit.getSource());
      RuleDto ruleDto=db.ruleDao().getNullableByKey(session,profileActivity.ruleKey());
      profileActivity.ruleName(ruleDto != null ? ruleDto.getName() : null);
      String login=profileActivity.getLogin();
      if (login != null) {
        UserDto user=db.userDao().selectActiveUserByLogin(session,login);
        profileActivity.authorName(user != null ? user.getName() : null);
      }
      result.getHits().add(profileActivity);
    }
    return result;
  }
  finally {
    session.close();
  }
}
