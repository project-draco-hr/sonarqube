{
  DbSession session=db.openSession(false);
  try {
    SearchResponse response=activityIndex.doSearch(query,options);
    Result<QProfileActivity> result=new Result<>(response);
    for (    SearchHit hit : response.getHits().getHits()) {
      QProfileActivity profileActivity=new QProfileActivity(hit.getSource());
      Optional<RuleDto> ruleDto=db.ruleDao().selectByKey(session,profileActivity.ruleKey());
      profileActivity.ruleName(ruleDto.isPresent() ? ruleDto.get().getName() : null);
      String login=profileActivity.getLogin();
      if (login != null) {
        UserDto user=db.userDao().selectActiveUserByLogin(session,login);
        profileActivity.authorName(user != null ? user.getName() : null);
      }
      result.getHits().add(profileActivity);
    }
    return result;
  }
  finally {
    session.close();
  }
}
