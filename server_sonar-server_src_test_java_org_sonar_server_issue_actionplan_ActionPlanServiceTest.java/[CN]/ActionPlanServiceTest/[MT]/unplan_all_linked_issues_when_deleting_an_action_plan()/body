{
  when(actionPlanDao.selectByKey("ABCD")).thenReturn(new ActionPlanDto().setKey("ABCD").setProjectKey_unit_test_only(PROJECT_KEY));
  when(resourceDao.selectResource(any(ResourceQuery.class))).thenReturn(new ResourceDto().setKey(PROJECT_KEY).setId(1l));
  IssueDto issueDto=new IssueDto().setId(100L).setStatus(Issue.STATUS_OPEN).setRuleKey("squid","s100").setIssueCreationDate(new Date()).setType(IssueType.BUG);
  when(issueDao.selectByActionPlan(session,"ABCD")).thenReturn(newArrayList(issueDto));
  when(issueUpdater.plan(any(DefaultIssue.class),eq((ActionPlan)null),any(IssueChangeContext.class))).thenReturn(true);
  ArgumentCaptor<DefaultIssue> captor=ArgumentCaptor.forClass(DefaultIssue.class);
  actionPlanService.delete("ABCD",projectAdministratorUserSession);
  verify(actionPlanDao).delete("ABCD");
  verify(issueUpdater).plan(captor.capture(),eq((ActionPlan)null),any(IssueChangeContext.class));
  verify(issueStorage).save(newArrayList(captor.getAllValues()));
}
