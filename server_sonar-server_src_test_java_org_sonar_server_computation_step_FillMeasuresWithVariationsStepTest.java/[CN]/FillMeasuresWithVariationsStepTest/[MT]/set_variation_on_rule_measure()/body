{
  SnapshotDto period1ProjectSnapshot=createForProject(PROJECT_DTO);
  dbClient.snapshotDao().insert(session,period1ProjectSnapshot);
  RuleDto rule1=RuleTesting.newXooX1();
  RuleDto rule2=RuleTesting.newXooX2();
  dbClient.ruleDao().insert(session,rule1,rule2);
  dbClient.measureDao().insert(session,newMeasureDto(ISSUES_METRIC.getId(),PROJECT_DTO.getId(),period1ProjectSnapshot.getId(),60d));
  dbClient.measureDao().insert(session,newMeasureDto(ISSUES_METRIC.getId(),PROJECT_DTO.getId(),period1ProjectSnapshot.getId(),40d).setRuleId(rule1.getId()));
  dbClient.measureDao().insert(session,newMeasureDto(ISSUES_METRIC.getId(),PROJECT_DTO.getId(),period1ProjectSnapshot.getId(),20d).setRuleId(rule2.getId()));
  session.commit();
  periodsHolder.addPeriod(newPeriod(1,period1ProjectSnapshot));
  treeRootHolder.setRoot(PROJECT);
  measureRepository.add(PROJECT,toMetric(ISSUES_METRIC),Measure.newMeasureBuilder().create(80,null));
  measureRepository.add(PROJECT,toMetric(ISSUES_METRIC),Measure.newMeasureBuilder().forRule(rule1.getId()).create(45,null));
  measureRepository.add(PROJECT,toMetric(ISSUES_METRIC),Measure.newMeasureBuilder().forRule(rule2.getId()).create(35,null));
  sut.execute();
  assertThat(measureRepository.getRawMeasure(PROJECT,toMetric(ISSUES_METRIC)).get().getVariations().getVariation1()).isEqualTo(20d);
  assertThat(measureRepository.getRawMeasure(PROJECT,toMetric(ISSUES_METRIC),rule1).get().getVariations().getVariation1()).isEqualTo(5d);
  assertThat(measureRepository.getRawMeasure(PROJECT,toMetric(ISSUES_METRIC),rule2).get().getVariations().getVariation1()).isEqualTo(15d);
}
