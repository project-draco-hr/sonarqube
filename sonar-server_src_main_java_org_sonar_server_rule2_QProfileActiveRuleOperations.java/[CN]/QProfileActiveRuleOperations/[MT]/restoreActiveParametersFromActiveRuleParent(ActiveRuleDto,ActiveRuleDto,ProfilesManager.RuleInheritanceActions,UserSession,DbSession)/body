{
  List<ActiveRuleParamDto> parentParams=activeRuleDao.findParamsByActiveRule(parent,session);
  List<ActiveRuleParamDto> activeRuleParams=activeRuleDao.findParamsByActiveRule(activeRule,session);
  List<ActiveRuleParamDto> newParams=newArrayList();
  List<String> paramKeys=newArrayList();
  for (  ActiveRuleParamDto param : activeRuleParams) {
    final String key=param.getKey();
    ActiveRuleParamDto parentParam=Iterables.find(parentParams,new Predicate<ActiveRuleParamDto>(){
      @Override public boolean apply(      ActiveRuleParamDto activeRuleParamDto){
        return activeRuleParamDto.getKey().equals(key);
      }
    }
,null);
    if (parentParam != null && !Strings.isNullOrEmpty(parentParam.getValue())) {
      String oldValue=param.getValue();
      String newValue=parentParam.getValue();
      param.setValue(newValue);
      activeRuleDao.updateParam(activeRule,param,session);
      session.commit();
      newParams.add(param);
      actions.add(profilesManager.ruleParamChanged(activeRule.getProfileId(),activeRule.getId(),key,oldValue,newValue,getLoggedName(userSession)));
    }
 else {
      activeRuleDao.removeParam(activeRule,param,session);
      session.commit();
      actions.add(profilesManager.ruleParamChanged(activeRule.getProfileId(),activeRule.getId(),key,param.getValue(),null,getLoggedName(userSession)));
    }
    paramKeys.add(key);
  }
  for (  ActiveRuleParamDto parentParam : parentParams) {
    if (!paramKeys.contains(parentParam.getKey())) {
      ActiveRuleParamDto activeRuleParam=ActiveRuleParamDto.createFrom(parentParam).setKey(parentParam.getKey()).setValue(parentParam.getValue());
      activeRuleDao.addParam(activeRule,activeRuleParam,session);
      session.commit();
      newParams.add(activeRuleParam);
      actions.add(profilesManager.ruleParamChanged(activeRule.getProfileId(),activeRule.getId(),parentParam.getKey(),null,parentParam.getValue(),getLoggedName(userSession)));
    }
  }
  return newParams;
}
