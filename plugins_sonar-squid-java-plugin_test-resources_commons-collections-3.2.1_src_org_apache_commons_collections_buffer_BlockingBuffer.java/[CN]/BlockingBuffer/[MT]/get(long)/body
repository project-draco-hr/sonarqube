{
synchronized (lock) {
    final long expiration=System.currentTimeMillis() + timeout;
    long timeLeft=expiration - System.currentTimeMillis();
    while (timeLeft > 0 && collection.isEmpty()) {
      try {
        lock.wait(timeLeft);
        timeLeft=expiration - System.currentTimeMillis();
      }
 catch (      InterruptedException e) {
        PrintWriter out=new PrintWriter(new StringWriter());
        e.printStackTrace(out);
        throw new BufferUnderflowException("Caused by InterruptedException: " + out.toString());
      }
    }
    if (collection.isEmpty()) {
      throw new BufferUnderflowException("Timeout expired");
    }
    return getBuffer().get();
  }
}
