{
  PluginFileExtractor extractor=new PluginFileExtractor();
  metadataByKey=Maps.newHashMap();
  for (  ArtifactDownloader.RemotePluginLocation remoteLocation : remoteLocations) {
    if (isAccepted(remoteLocation.getPluginKey())) {
      File pluginFile=artifactDownloader.downloadPlugin(remoteLocation);
      PluginMetadata metadata=extractor.installInSameLocation(pluginFile,remoteLocation.isCore());
      if (StringUtils.isBlank(metadata.getBasePlugin()) || isAccepted(metadata.getBasePlugin())) {
        metadataByKey.put(metadata.getKey(),metadata);
      }
    }
  }
  classLoaders=new PluginClassloaders(Thread.currentThread().getContextClassLoader());
  pluginsByKey=classLoaders.init(metadataByKey.values());
}
