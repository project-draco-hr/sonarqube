{
  userSessionRule.login().setGlobalPermissions(GlobalPermissions.QUALITY_PROFILE_ADMIN);
  db.ruleDao().insert(dbSession,RuleTesting.newDto(RuleKey.of("xoo","R1")).setLanguage("xoo").setSeverity("MINOR"));
  dbSession.commit();
  ruleIndexer.index();
  QProfileResult result=service.create(QProfileName.createFor("xoo","New Profile"),ImmutableMap.of("XooProfileImporter","<xml/>"));
  QualityProfileDto profile=result.profile();
  assertThat(loader.getByKey(profile.getKey())).isNotNull();
  assertThat(loader.getByKey(profile.getKey()).getLanguage()).isEqualTo("xoo");
  assertThat(loader.getByKey(profile.getKey()).getName()).isEqualTo("New Profile");
  assertThat(db.activeRuleDao().selectByProfileKey(dbSession,profile.getKey())).hasSize(1);
  assertThat(tester.get(RuleIndex.class).searchAll(new RuleQuery().setQProfileKey(profile.getKey()).setActivation(true))).hasSize(1);
}
