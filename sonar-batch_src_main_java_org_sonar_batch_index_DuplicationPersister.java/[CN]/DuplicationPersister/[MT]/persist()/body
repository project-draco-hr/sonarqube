{
  try (DbSession session=mybatis.openSession(false)){
    MeasureMapper mapper=session.getMapper(MeasureMapper.class);
    Metric duplicationMetricWithId=metricFinder.findByKey(CoreMetrics.DUPLICATIONS_DATA_KEY);
    for (    Entry<List<DuplicationGroup>> entry : duplicationCache.entries()) {
      String effectiveKey=entry.key()[0].toString();
      Measure measure=new Measure(duplicationMetricWithId,DuplicationUtils.toXml(entry.value())).setPersistenceMode(PersistenceMode.DATABASE);
      BatchResource batchResource=resourceCache.get(effectiveKey);
      if (MeasurePersister.shouldPersistMeasure(batchResource.resource(),measure)) {
        MeasureModel measureModel=MeasurePersister.model(measure,ruleFinder,metricFinder).setSnapshotId(batchResource.snapshotId());
        mapper.insert(measureModel);
        session.commit();
      }
    }
  }
 catch (  Exception e) {
    throw new IllegalStateException("Unable to save some measures",e);
  }
}
