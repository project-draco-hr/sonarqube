{
  dbTester.prepareDbUnit(getClass(),"shared.xml");
  DbClient dbClient=new DbClient(dbTester.database(),dbTester.myBatis(),new ComponentDao());
  when(steps.orderedSteps()).thenReturn(Arrays.asList(projectStep1));
  doThrow(new UnsupportedOperationException()).when(projectStep1).execute(any(ComputationContext.class));
  ComputationService sut=new ComputationService(dbClient,steps,activityService,mock(ProjectSettingsFactory.class,Mockito.RETURNS_DEEP_STUBS));
  AnalysisReportDto report=AnalysisReportDto.newForTests(1L);
  report.setProjectKey("PROJECT_KEY");
  try {
    sut.process(report);
    fail();
  }
 catch (  UnsupportedOperationException e) {
    assertThat(report.getStatus()).isEqualTo(AnalysisReportDto.Status.FAILED);
    verify(activityService).write(any(DbSession.class),eq(Activity.Type.ANALYSIS_REPORT),any(AnalysisReportLog.class));
  }
}
