{
  when(steps.orderedSteps()).thenReturn(Arrays.asList(projectStep1));
  doThrow(new IllegalStateException("pb")).when(projectStep1).execute(any(ComputationContext.class));
  AnalysisReportDto dto=AnalysisReportDto.newForTests(1L).setProjectKey("P1").setUuid("U1");
  File zip=generateZip();
  try {
    sut.process(new ReportQueue.Item(dto,zip));
    fail();
  }
 catch (  IllegalStateException e) {
    assertThat(e.getMessage()).isEqualTo("pb");
    assertThat(dto.getStatus()).isEqualTo(AnalysisReportDto.Status.FAILED);
    assertThat(dto.getFinishedAt()).isNotNull();
  }
}
