{
  checkPermission();
  DbSession session=dbClient.openSession(false);
  try {
    DebtModel debtModel=new DebtModel();
    List<CharacteristicDto> characteristicDtos=dbClient.debtCharacteristicDao().selectEnabledCharacteristics(session);
    for (    CharacteristicDto characteristicDto : characteristicDtos) {
      if (characteristicDto.getParentId() == null) {
        debtModel.addRootCharacteristic(toDebtCharacteristic(characteristicDto));
        for (        CharacteristicDto sub : subCharacteristics(characteristicDto.getId(),characteristicDtos)) {
          debtModel.addSubCharacteristic(toDebtCharacteristic(sub),characteristicDto.getKey());
        }
      }
    }
    List<RuleDebt> rules=newArrayList();
    for (    RuleDto rule : dbClient.ruleDao().selectEnabledAndNonManual(session)) {
      if (languageKey == null || languageKey.equals(rule.getLanguage())) {
        RuleDebt ruleDebt=toRuleDebt(rule,debtModel);
        if (ruleDebt != null) {
          rules.add(ruleDebt);
        }
      }
    }
    return debtModelXMLExporter.export(debtModel,rules);
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
