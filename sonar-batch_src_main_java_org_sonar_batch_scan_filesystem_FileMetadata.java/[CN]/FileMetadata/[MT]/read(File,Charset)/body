{
  Reader reader=null;
  long currentOriginalOffset=0;
  List<Long> originalLineOffsets=new ArrayList<Long>();
  List<Object> lineHashes=new ArrayList<Object>();
  StringBuilder currentLineStr=new StringBuilder();
  int lines=0;
  char c=(char)-1;
  try {
    MessageDigest globalMd5Digest=DigestUtils.getMd5Digest();
    globalMd5Digest.reset();
    reader=new BufferedReader(new InputStreamReader(new FileInputStream(file),encoding));
    int i=reader.read();
    boolean afterCR=false;
    originalLineOffsets.add(0L);
    while (i != -1) {
      c=(char)i;
      if (c == BOM) {
        i=reader.read();
        continue;
      }
      currentOriginalOffset++;
      if (afterCR) {
        afterCR=false;
        if (c == LINE_FEED) {
          originalLineOffsets.set(originalLineOffsets.size() - 1,originalLineOffsets.get(originalLineOffsets.size() - 1) + 1);
          i=reader.read();
          continue;
        }
      }
      if (c == CARRIAGE_RETURN) {
        afterCR=true;
        c=LINE_FEED;
      }
      if (c == LINE_FEED) {
        lines++;
        originalLineOffsets.add(currentOriginalOffset);
        lineHashes.add(md5IgnoreWhitespace(currentLineStr));
        currentLineStr.setLength(0);
      }
 else {
        currentLineStr.append(c);
      }
      globalMd5Digest.update(charToBytesUTF(c));
      i=reader.read();
    }
    if (c != (char)-1) {
      lines++;
      lineHashes.add(md5IgnoreWhitespace(currentLineStr));
    }
    String filehash=Hex.encodeHexString(globalMd5Digest.digest());
    return new Metadata(lines,filehash,originalLineOffsets,lineHashes.toArray(new byte[0][]));
  }
 catch (  IOException e) {
    throw new IllegalStateException(String.format("Fail to read file '%s' with encoding '%s'",file.getAbsolutePath(),encoding),e);
  }
 finally {
    IOUtils.closeQuietly(reader);
  }
}
