{
  Optional<UserDto> user=authenticate(request,response);
  if (user.isPresent()) {
    ServerUserSession session=createForUser(dbClient,user.get());
    threadLocalSession.set(session);
    request.setAttribute(ACCESS_LOG_LOGIN,session.getLogin());
  }
 else {
    if (settings.getBoolean(CORE_FORCE_AUTHENTICATION_PROPERTY)) {
      throw new UnauthorizedException("User must be authenticated");
    }
    threadLocalSession.set(createForAnonymous(dbClient));
    request.setAttribute(ACCESS_LOG_LOGIN,"-");
  }
}
