{
  PluginMetadata metadata=mock(PluginMetadata.class);
  FakePlugin plugin=new FakePlugin();
  BatchPluginRepository pluginRepository=mock(BatchPluginRepository.class);
  when(pluginRepository.getPluginsByMetadata()).thenReturn(ImmutableMap.<PluginMetadata,Plugin>of(metadata,plugin));
  GlobalContainer container=spy(GlobalContainer.create(Collections.<String,String>emptyMap(),Lists.<Object>newArrayList(pluginRepository)));
  doNothing().when(container).executeTask(Collections.<String,String>emptyMap());
  container.doAfterStart();
  assertThat(container.getComponentsByType(Plugin.class)).containsOnly(plugin);
}
