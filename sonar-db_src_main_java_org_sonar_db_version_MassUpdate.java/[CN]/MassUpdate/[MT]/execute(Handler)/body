{
  if (select == null || update == null) {
    throw new IllegalStateException("SELECT or UPDATE requests are not defined");
  }
  progress.start();
  try {
    select.scroll(new Select.RowHandler(){
      @Override public void handle(      Select.Row row) throws SQLException {
        if (handler.handle(row,update)) {
          update.addBatch();
        }
        counter.getAndIncrement();
      }
    }
);
    if (((UpsertImpl)update).getBatchCount() > 0L) {
      update.execute().commit();
    }
    update.close();
    progress.log();
  }
  finally {
    progress.stop();
  }
}
