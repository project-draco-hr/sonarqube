{
  grantPermission();
  db.ruleDao().insert(dbSession,RuleTesting.newDto(RULE_KEY).setTags(Sets.newHashSet("security")).setSystemTags(Sets.newHashSet("java8","javadoc")));
  dbSession.commit();
  RuleUpdate update=new RuleUpdate(RULE_KEY).setTags(Sets.newHashSet("bug","java8"));
  updater.update(update,UserSession.get());
  dbSession.clearCache();
  RuleDto rule=db.ruleDao().getNullableByKey(dbSession,RULE_KEY);
  assertThat(rule.getTags()).containsOnly("bug");
  assertThat(rule.getSystemTags()).containsOnly("java8","javadoc");
  Set<String> tags=tester.get(RuleService.class).listTags();
  assertThat(tags).containsOnly("bug","java8","javadoc");
}
