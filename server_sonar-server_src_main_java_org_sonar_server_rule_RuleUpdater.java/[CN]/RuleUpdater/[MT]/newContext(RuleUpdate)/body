{
  DbSession dbSession=dbClient.openSession(false);
  try {
    Context context=new Context();
    context.rule=dbClient.ruleDao().getByKey(dbSession,change.getRuleKey());
    if (RuleStatus.REMOVED == context.rule.getStatus()) {
      throw new IllegalArgumentException("Rule with REMOVED status cannot be updated: " + change.getRuleKey());
    }
    String subCharacteristicKey=change.getDebtSubCharacteristicKey();
    if (subCharacteristicKey != null && !subCharacteristicKey.equals(RuleUpdate.DEFAULT_DEBT_CHARACTERISTIC)) {
      CharacteristicDto characteristicDto=dbClient.debtCharacteristicDao().selectByKey(subCharacteristicKey,dbSession);
      if (characteristicDto == null) {
        throw new IllegalArgumentException("Unknown debt sub-characteristic: " + subCharacteristicKey);
      }
      if (!characteristicDto.isEnabled()) {
        throw new IllegalArgumentException("Debt sub-characteristic is disabled: " + subCharacteristicKey);
      }
      if (characteristicDto.getParentId() == null) {
        throw new IllegalArgumentException("Not a sub-characteristic: " + subCharacteristicKey);
      }
      context.newCharacteristic=characteristicDto;
    }
    return context;
  }
  finally {
    dbSession.close();
  }
}
