{
  if (update.isChangeParameters() && update.isCustomRule()) {
    RuleDto customRule=context.rule;
    Integer templateId=customRule.getTemplateId();
    Preconditions.checkNotNull(templateId,"Rule '%s' has no persisted template!",customRule);
    Optional<RuleDto> templateRule=dbClient.ruleDao().selectById(templateId,dbSession);
    if (!templateRule.isPresent()) {
      throw new IllegalStateException(String.format("Template %s of rule %s does not exist",customRule.getTemplateId(),customRule.getKey()));
    }
    List<String> paramKeys=newArrayList();
    Multimap<RuleDto,ActiveRuleDto> activeRules=ArrayListMultimap.create();
    Multimap<ActiveRuleDto,ActiveRuleParamDto> activeRuleParams=ArrayListMultimap.create();
    for (    ActiveRuleDto activeRuleDto : dbClient.activeRuleDao().selectByRule(dbSession,customRule)) {
      activeRules.put(customRule,activeRuleDto);
      for (      ActiveRuleParamDto activeRuleParamDto : dbClient.activeRuleDao().selectParamsByActiveRuleKey(dbSession,activeRuleDto.getKey())) {
        activeRuleParams.put(activeRuleDto,activeRuleParamDto);
      }
    }
    deleteOrUpdateParameters(dbSession,update,customRule,paramKeys,activeRules,activeRuleParams);
  }
}
