{
  DbSession dbSession=tester.get(MyBatis.class).openSession(false);
  ActiveRuleDao activeRuleDao=tester.get(ActiveRuleDao.class);
  RuleKey ruleKey=RuleKey.of("javascript","S001");
  RuleDto ruleDto=newRuleDto(ruleKey);
  dao.insert(ruleDto,dbSession);
  RuleParamDto minParam=new RuleParamDto().setRuleId(ruleDto.getId()).setName("min").setType("STRING");
  dao.insert(minParam,dbSession);
  RuleParamDto maxParam=new RuleParamDto().setRuleId(ruleDto.getId()).setName("max").setType("STRING");
  dao.insert(maxParam,dbSession);
  ActiveRuleDto activeRule=new ActiveRuleDto().setInheritance("inherited").setProfileId(1).setRuleId(ruleDto.getId()).setSeverity(Severity.BLOCKER);
  activeRuleDao.insert(activeRule,dbSession);
  ActiveRuleParamDto activeRuleMinParam=new ActiveRuleParamDto().setActiveRuleId(activeRule.getId()).setKey(minParam.getName()).setValue("minimum").setRulesParameterId(minParam.getId());
  activeRuleDao.insert(activeRuleMinParam,dbSession);
  ActiveRuleParamDto activeRuleMaxParam=new ActiveRuleParamDto().setActiveRuleId(activeRule.getId()).setKey(maxParam.getName()).setValue("maximum").setRulesParameterId(maxParam.getId());
  activeRuleDao.insert(activeRuleMaxParam,dbSession);
  dbSession.commit();
  List<ActiveRuleParamDto> persistedDtos=activeRuleDao.selectParamsByActiveRuleId(activeRule.getId());
  assertThat(persistedDtos).hasSize(2);
  index.refresh();
  Hit hit=index.getByKey(ruleKey);
  assertThat(hit).isNotNull();
  index.search(new RuleQuery(),new QueryOptions());
  Map<String,Map> _activeRules=(Map<String,Map>)hit.getField(RuleNormalizer.RuleField.ACTIVE.key());
  assertThat(_activeRules).isNotNull().hasSize(1);
  Map<String,Object> _activeRule=(Map<String,Object>)Iterables.getFirst(_activeRules.values(),null);
  assertThat(_activeRule.get(RuleNormalizer.RuleField.SEVERITY.key())).isEqualTo(Severity.BLOCKER);
  Map<String,Map> _activeRuleParams=(Map<String,Map>)_activeRule.get(RuleNormalizer.RuleField.PARAMS.key());
  assertThat(_activeRuleParams).isNotNull().hasSize(2);
  Map<String,String> _activeRuleParamValue=(Map<String,String>)_activeRuleParams.get(maxParam.getName());
  assertThat(_activeRuleParamValue).isNotNull().hasSize(1);
  assertThat(_activeRuleParamValue.get(RuleNormalizer.RuleParamField.DEFAULT_VALUE.key())).isEqualTo("maximum");
}
