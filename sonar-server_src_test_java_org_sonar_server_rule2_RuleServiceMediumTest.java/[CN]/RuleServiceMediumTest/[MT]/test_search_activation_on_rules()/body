{
  QualityProfileDto qprofile1=QualityProfileDto.createFor("profile1","java");
  QualityProfileDto qprofile2=QualityProfileDto.createFor("profile2","java");
  tester.get(QualityProfileDao.class).insert(qprofile1,dbSession);
  tester.get(QualityProfileDao.class).insert(qprofile2,dbSession);
  RuleDto rule1=newRuleDto(RuleKey.of("test","rule1"));
  RuleDto rule2=newRuleDto(RuleKey.of("test","rule2"));
  tester.get(RuleDao.class).insert(rule1,dbSession);
  tester.get(RuleDao.class).insert(rule2,dbSession);
  ActiveRuleDto activeRule1=ActiveRuleDto.createFor(qprofile1,rule1).setSeverity(Severity.BLOCKER);
  ActiveRuleDto activeRule2=ActiveRuleDto.createFor(qprofile1,rule2).setSeverity(Severity.BLOCKER);
  ActiveRuleDto activeRule3=ActiveRuleDto.createFor(qprofile2,rule2).setSeverity(Severity.BLOCKER);
  tester.get(ActiveRuleDao.class).insert(activeRule1,dbSession);
  tester.get(ActiveRuleDao.class).insert(activeRule2,dbSession);
  tester.get(ActiveRuleDao.class).insert(activeRule3,dbSession);
  dbSession.commit();
  assertThat(tester.get(RuleDao.class).findAll(dbSession)).hasSize(2);
  assertThat(tester.get(ActiveRuleDao.class).findByRule(rule1,dbSession)).hasSize(1);
  assertThat(tester.get(ActiveRuleDao.class).findByRule(rule2,dbSession)).hasSize(2);
  RuleQuery query=new RuleQuery().setActivation("all");
  RuleResult result=service.search(query,new QueryOptions());
  assertThat(result.getActiveRules().values()).hasSize(3);
  query=new RuleQuery().setActivation("false");
  result=service.search(query,new QueryOptions());
  assertThat(result.getActiveRules().values()).hasSize(0);
  query=new RuleQuery().setActivation("true").setQProfileKey(qprofile1.getKey().toString());
  result=service.search(query,new QueryOptions());
  assertThat(result.getActiveRules().values()).hasSize(2);
}
