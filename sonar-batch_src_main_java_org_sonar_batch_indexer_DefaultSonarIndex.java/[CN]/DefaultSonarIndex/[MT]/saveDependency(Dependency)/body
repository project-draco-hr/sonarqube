{
  Dependency persistedDep=getEdge(dependency.getFrom(),dependency.getTo());
  if (persistedDep != null && persistedDep.getId() != null) {
    return persistedDep;
  }
  Bucket from=getOrCreateBucket(dependency.getFrom(),true);
  Bucket to=getOrCreateBucket(dependency.getTo(),true);
  DependencyDto dto=new DependencyDto();
  dto.setFromResourceId(from.getResourceId());
  dto.setFromScope(from.getResource().getScope());
  dto.setFromSnapshotId(from.getSnapshotId());
  dto.setToResourceId(to.getResourceId());
  dto.setToSnapshotId(to.getSnapshotId());
  dto.setToScope(to.getResource().getScope());
  dto.setProjectSnapshotId(selectedProjectBucket.getSnapshotId());
  dto.setUsage(dependency.getUsage());
  dto.setWeight(dependency.getWeight());
  Dependency parentDependency=dependency.getParent();
  if (parentDependency != null) {
    saveDependency(parentDependency);
    dto.setParentDependencyId(parentDependency.getId());
  }
  session.save(dto);
  dependency.setId(dto.getId());
  registerDependency(dependency);
  return dependency;
}
