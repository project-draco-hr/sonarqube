{
  Bucket bucket=buckets.get(resource);
  if (bucket != null) {
    return bucket;
  }
  if (mustExist && lock.isLocked() && !ResourceUtils.isLibrary(resource)) {
    LOG.warn("The following resource has not been registered before saving violation/measure/event: " + resource);
  }
  prepareResource(resource);
  bucket=new Bucket<Resource>(resource);
  buckets.put(resource,bucket);
  Bucket parentBucket=null;
  Resource parent=resource.getParent();
  if (parent != null) {
    parentBucket=getOrCreateBucket(parent,mustExist);
  }
 else   if (!ResourceUtils.isLibrary(resource)) {
    parentBucket=selectedProjectBucket;
  }
  bucket.setParent(parentBucket);
  bucket.setProject(selectedProjectBucket);
  persist(bucket);
  return bucket;
}
