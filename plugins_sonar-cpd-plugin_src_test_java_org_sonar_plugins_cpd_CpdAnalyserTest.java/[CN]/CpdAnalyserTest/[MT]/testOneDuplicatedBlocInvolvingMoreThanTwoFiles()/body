{
  ProjectFileSystem fileSystem=mock(ProjectFileSystem.class);
  when(fileSystem.getSourceDirs()).thenReturn(Collections.<File>emptyList());
  File file1=new File("target/tmp/file1.ext");
  File file2=new File("target/tmp/file2.ext");
  File file3=new File("target/tmp/file3.ext");
  File file4=new File("target/tmp/file4.ext");
  Project project=new Project("key").setFileSystem(fileSystem);
  SensorContext context=mock(SensorContext.class);
  CpdMapping cpdMapping=mock(CpdMapping.class);
  Resource resource1=new JavaFile("foo.Foo");
  Resource resource2=new JavaFile("foo.Bar");
  Resource resource3=new JavaFile("foo.Hotel");
  Resource resource4=new JavaFile("foo.Coffee");
  when(cpdMapping.createResource((File)anyObject(),anyList())).thenReturn(resource1).thenReturn(resource2).thenReturn(resource3).thenReturn(resource4).thenReturn(resource2).thenReturn(resource1).thenReturn(resource3).thenReturn(resource4).thenReturn(resource3).thenReturn(resource1).thenReturn(resource2).thenReturn(resource4).thenReturn(resource4).thenReturn(resource1).thenReturn(resource2).thenReturn(resource3);
  Match match=new Match(5,createTokenEntry(file1.getAbsolutePath(),5),createTokenEntry(file2.getAbsolutePath(),15));
  match.setLineCount(200);
  Set<TokenEntry> tokenEntries=new LinkedHashSet<TokenEntry>();
  tokenEntries.add(createTokenEntry(file1.getAbsolutePath(),5));
  tokenEntries.add(createTokenEntry(file2.getAbsolutePath(),15));
  tokenEntries.add(createTokenEntry(file3.getAbsolutePath(),7));
  tokenEntries.add(createTokenEntry(file4.getAbsolutePath(),10));
  match.setMarkSet(tokenEntries);
  CpdAnalyser cpdAnalyser=new CpdAnalyser(project,context,cpdMapping);
  cpdAnalyser.analyse(Arrays.asList(match).iterator());
  ArgumentCaptor<Measure> measureCaptor=ArgumentCaptor.forClass(Measure.class);
  verify(context).saveMeasure(resource1,CoreMetrics.DUPLICATED_FILES,1d);
  verify(context).saveMeasure(resource1,CoreMetrics.DUPLICATED_BLOCKS,1d);
  verify(context).saveMeasure(resource1,CoreMetrics.DUPLICATED_LINES,200d);
  verify(context).saveMeasure(eq(resource1),measureCaptor.capture());
  Measure measure=measureCaptor.getValue();
  assertThat(measure.getMetric(),is(CoreMetrics.DUPLICATIONS_DATA));
  assertThat(measure.getData(),is("<duplications>" + "<g>" + "<b s=\"5\" l=\"200\" r=\"key:foo.Foo\" />"+ "<b s=\"15\" l=\"200\" r=\"key:foo.Bar\" />"+ "</g>"+ "<g>"+ "<b s=\"5\" l=\"200\" r=\"key:foo.Foo\" />"+ "<b s=\"7\" l=\"200\" r=\"key:foo.Hotel\" />"+ "</g>"+ "<g>"+ "<b s=\"5\" l=\"200\" r=\"key:foo.Foo\" />"+ "<b s=\"10\" l=\"200\" r=\"key:foo.Coffee\" />"+ "</g>"+ "</duplications>"));
  verify(context).saveMeasure(resource3,CoreMetrics.DUPLICATED_FILES,1d);
  verify(context).saveMeasure(resource3,CoreMetrics.DUPLICATED_LINES,200d);
  verify(context).saveMeasure(resource3,CoreMetrics.DUPLICATED_BLOCKS,1d);
  verify(context).saveMeasure(eq(resource3),measureCaptor.capture());
  measure=measureCaptor.getValue();
  assertThat(measure.getMetric(),is(CoreMetrics.DUPLICATIONS_DATA));
  assertThat(measure.getData(),is("<duplications>" + "<g>" + "<b s=\"7\" l=\"200\" r=\"key:foo.Hotel\" />"+ "<b s=\"5\" l=\"200\" r=\"key:foo.Foo\" />"+ "</g>"+ "<g>"+ "<b s=\"7\" l=\"200\" r=\"key:foo.Hotel\" />"+ "<b s=\"15\" l=\"200\" r=\"key:foo.Bar\" />"+ "</g>"+ "<g>"+ "<b s=\"7\" l=\"200\" r=\"key:foo.Hotel\" />"+ "<b s=\"10\" l=\"200\" r=\"key:foo.Coffee\" />"+ "</g>"+ "</duplications>"));
  verify(context).saveMeasure(resource2,CoreMetrics.DUPLICATED_FILES,1d);
  verify(context).saveMeasure(resource2,CoreMetrics.DUPLICATED_LINES,200d);
  verify(context).saveMeasure(resource2,CoreMetrics.DUPLICATED_BLOCKS,1d);
  verify(context).saveMeasure(eq(resource2),measureCaptor.capture());
  measure=measureCaptor.getValue();
  assertThat(measure.getMetric(),is(CoreMetrics.DUPLICATIONS_DATA));
  assertThat(measure.getData(),is("<duplications>" + "<g>" + "<b s=\"15\" l=\"200\" r=\"key:foo.Bar\" />"+ "<b s=\"5\" l=\"200\" r=\"key:foo.Foo\" />"+ "</g>"+ "<g>"+ "<b s=\"15\" l=\"200\" r=\"key:foo.Bar\" />"+ "<b s=\"7\" l=\"200\" r=\"key:foo.Hotel\" />"+ "</g>"+ "<g>"+ "<b s=\"15\" l=\"200\" r=\"key:foo.Bar\" />"+ "<b s=\"10\" l=\"200\" r=\"key:foo.Coffee\" />"+ "</g>"+ "</duplications>"));
  verify(context).saveMeasure(resource4,CoreMetrics.DUPLICATED_LINES,200d);
  verify(context).saveMeasure(resource4,CoreMetrics.DUPLICATED_FILES,1d);
  verify(context).saveMeasure(resource4,CoreMetrics.DUPLICATED_BLOCKS,1d);
  verify(context).saveMeasure(eq(resource4),measureCaptor.capture());
  measure=measureCaptor.getValue();
  assertThat(measure.getMetric(),is(CoreMetrics.DUPLICATIONS_DATA));
  assertThat(measure.getData(),is("<duplications>" + "<g>" + "<b s=\"10\" l=\"200\" r=\"key:foo.Coffee\" />"+ "<b s=\"5\" l=\"200\" r=\"key:foo.Foo\" />"+ "</g>"+ "<g>"+ "<b s=\"10\" l=\"200\" r=\"key:foo.Coffee\" />"+ "<b s=\"15\" l=\"200\" r=\"key:foo.Bar\" />"+ "</g>"+ "<g>"+ "<b s=\"10\" l=\"200\" r=\"key:foo.Coffee\" />"+ "<b s=\"7\" l=\"200\" r=\"key:foo.Hotel\" />"+ "</g>"+ "</duplications>"));
}
