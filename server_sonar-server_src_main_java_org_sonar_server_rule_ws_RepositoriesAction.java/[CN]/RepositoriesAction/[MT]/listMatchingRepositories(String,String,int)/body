{
  Pattern pattern=Pattern.compile(query == null ? MATCH_ALL : MATCH_ALL + query + MATCH_ALL,Pattern.CASE_INSENSITIVE);
  SortedMap<String,Repository> reposByName=Maps.newTreeMap();
  Collection<Repository> repos=languageKey == null ? repositories.repositories() : repositories.repositoriesForLang(languageKey);
  for (  Repository repo : repos) {
    if (pattern.matcher(repo.key()).matches() || pattern.matcher(repo.name()).matches()) {
      reposByName.put(repo.name() + " -- " + repo.language(),repo);
    }
  }
  List<Repository> result=Lists.newArrayList(reposByName.values());
  if (pageSize > 0 && pageSize < result.size()) {
    result=result.subList(0,pageSize);
  }
  return result;
}
