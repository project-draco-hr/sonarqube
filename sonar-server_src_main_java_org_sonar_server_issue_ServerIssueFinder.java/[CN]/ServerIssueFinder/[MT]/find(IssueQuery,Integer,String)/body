{
  LOG.debug("IssueQuery : {}",query);
  SqlSession sqlSession=myBatis.openSession();
  try {
    List<IssueDto> allIssuesDto=issueDao.selectIssueAndComponentIds(query,sqlSession);
    Set<Integer> authorizedComponentIds=authorizationDao.keepAuthorizedComponentIds(extractResourceIds(allIssuesDto),currentUserId,role,sqlSession);
    List<IssueDto> authorizedIssues=authorized(allIssuesDto,authorizedComponentIds);
    Paging paging=Paging.create(query.pageSize(),query.pageIndex(),authorizedIssues.size());
    Set<Long> pagedAuthorizedIssueIds=pagedAuthorizedIssueIds(authorizedIssues,paging);
    Collection<IssueDto> dtos=issueDao.selectByIds(pagedAuthorizedIssueIds,sqlSession);
    Map<String,DefaultIssue> issuesByKey=newHashMap();
    List<Issue> issues=newArrayList();
    Set<Integer> ruleIds=Sets.newHashSet();
    Set<Integer> componentIds=Sets.newHashSet();
    Set<String> actionPlanKeys=Sets.newHashSet();
    for (    IssueDto dto : dtos) {
      if (authorizedComponentIds.contains(dto.getResourceId())) {
        DefaultIssue defaultIssue=dto.toDefaultIssue();
        issuesByKey.put(dto.getKee(),defaultIssue);
        issues.add(defaultIssue);
        ruleIds.add(dto.getRuleId());
        componentIds.add(dto.getResourceId());
        actionPlanKeys.add(dto.getActionPlanKey());
      }
    }
    List<DefaultIssueComment> comments=issueChangeDao.selectCommentsByIssues(sqlSession,issuesByKey.keySet());
    for (    DefaultIssueComment comment : comments) {
      DefaultIssue issue=issuesByKey.get(comment.issueKey());
      issue.addComment(comment);
    }
    return new DefaultResults(issues,findRules(ruleIds),findComponents(componentIds),findActionPlans(actionPlanKeys),paging,authorizedIssues.size() != allIssuesDto.size());
  }
  finally {
    MyBatis.closeQuietly(sqlSession);
  }
}
