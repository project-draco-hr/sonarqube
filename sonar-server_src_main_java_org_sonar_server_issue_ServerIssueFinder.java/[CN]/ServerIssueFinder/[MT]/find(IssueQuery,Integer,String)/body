{
  LOG.debug("IssueQuery : {}",query);
  SqlSession sqlSession=myBatis.openSession();
  try {
    List<IssueDto> allIssuesDto=issueDao.selectIssueIdsAndComponentsId(query,sqlSession);
    Set<Integer> componentIds=Sets.newLinkedHashSet();
    for (    IssueDto issueDto : allIssuesDto) {
      componentIds.add(issueDto.getResourceId());
    }
    Set<Integer> authorizedComponentIds=authorizationDao.keepAuthorizedComponentIds(componentIds,currentUserId,role,sqlSession);
    Set<Long> issueIds=getAutorizedIssueIds(allIssuesDto,authorizedComponentIds,query);
    Collection<IssueDto> dtos=issueDao.selectByIds(issueIds,sqlSession);
    Set<Integer> ruleIds=Sets.newLinkedHashSet();
    List<Issue> issues=Lists.newArrayList();
    for (    IssueDto dto : dtos) {
      if (authorizedComponentIds.contains(dto.getResourceId())) {
        issues.add(dto.toDefaultIssue());
        ruleIds.add(dto.getRuleId());
      }
    }
    if (!issues.isEmpty()) {
      return new DefaultResults(issues,getRulesByIssue(issues,ruleIds),getComponentsByIssue(issues,componentIds));
    }
 else {
      return new DefaultResults(issues);
    }
  }
  finally {
    MyBatis.closeQuietly(sqlSession);
  }
}
