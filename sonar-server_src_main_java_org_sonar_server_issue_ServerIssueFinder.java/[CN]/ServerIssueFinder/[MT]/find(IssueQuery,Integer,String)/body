{
  LOG.debug("IssueQuery : {}",query);
  SqlSession sqlSession=myBatis.openSession();
  try {
    List<IssueDto> allIssuesDto=issueDao.selectIssueIdsAndComponentsId(query,sqlSession);
    Set<Integer> componentIds=getResourceIds(allIssuesDto);
    Set<Integer> authorizedComponentIds=authorizationDao.keepAuthorizedComponentIds(componentIds,currentUserId,role,sqlSession);
    List<IssueDto> authorizedIssues=getAuthorizedIssues(allIssuesDto,authorizedComponentIds);
    Paging paging=new Paging(query.pageSize(),query.pageIndex(),authorizedIssues.size());
    Set<Long> paginatedAuthorizedIssueIds=getPaginatedAuthorizedIssueIds(authorizedIssues,paging);
    Collection<IssueDto> dtos=issueDao.selectByIds(paginatedAuthorizedIssueIds,sqlSession);
    Set<Integer> ruleIds=Sets.newLinkedHashSet();
    List<Issue> issues=newArrayList();
    for (    IssueDto dto : dtos) {
      if (authorizedComponentIds.contains(dto.getResourceId())) {
        issues.add(dto.toDefaultIssue());
        ruleIds.add(dto.getRuleId());
      }
    }
    return new DefaultResults(issues,getRulesByIssue(issues,ruleIds),getComponentsByIssue(issues,componentIds),paging);
  }
  finally {
    MyBatis.closeQuietly(sqlSession);
  }
}
