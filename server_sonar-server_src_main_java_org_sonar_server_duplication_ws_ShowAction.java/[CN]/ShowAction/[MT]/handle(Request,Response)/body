{
  String fileKey=request.param("key");
  String fileUuid=request.param("uuid");
  Preconditions.checkArgument(fileKey != null || fileUuid != null,"At least one of 'key' or 'uuid' must be provided");
  DbSession session=dbClient.openSession(false);
  if (fileKey == null) {
    fileKey=componentDao.getByUuid(session,fileUuid).key();
  }
  userSession.checkComponentPermission(UserRole.CODEVIEWER,fileKey);
  try {
    ComponentDto component=findComponent(fileKey,session);
    JsonWriter json=response.newJsonWriter().beginObject();
    String duplications=findDataFromComponent(fileKey,CoreMetrics.DUPLICATIONS_DATA_KEY,session);
    List<DuplicationsParser.Block> blocks=parser.parse(component,duplications,session);
    duplicationsJsonWriter.write(blocks,json,session);
    json.endObject().close();
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
