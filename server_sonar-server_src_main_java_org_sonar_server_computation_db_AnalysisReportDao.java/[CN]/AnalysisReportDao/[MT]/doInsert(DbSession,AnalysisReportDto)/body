{
  Connection connection=session.getConnection();
  PreparedStatement ps=null;
  try {
    ps=connection.prepareStatement(INSERT_QUERY);
    ps.setString(1,report.getProjectKey());
    ps.setLong(2,report.getSnapshotId());
    ps.setString(3,report.getStatus().toString());
    InputStreamReader inputStreamReader=null;
    int streamSizeEstimate=Integer.MAX_VALUE;
    if (report.getData() != null) {
      inputStreamReader=new InputStreamReader(report.getData(),Charsets.UTF_8);
      streamSizeEstimate=report.getData().available();
    }
    ps.setCharacterStream(4,inputStreamReader,streamSizeEstimate);
    ps.setTimestamp(5,dateToTimestamp(report.getCreatedAt()));
    ps.setTimestamp(6,dateToTimestamp(report.getUpdatedAt()));
    ps.setTimestamp(7,dateToTimestamp(report.getStartedAt()));
    ps.setTimestamp(8,dateToTimestamp(report.getFinishedAt()));
    ps.executeUpdate();
    connection.commit();
  }
 catch (  SQLException e) {
    throw new IllegalStateException(String.format("Failed to insert %s in the database",report),e);
  }
catch (  IOException e) {
    throw new IllegalStateException(String.format("Failed to read report data of %s",report),e);
  }
 finally {
    DatabaseUtils.closeQuietly(ps);
  }
  return report;
}
