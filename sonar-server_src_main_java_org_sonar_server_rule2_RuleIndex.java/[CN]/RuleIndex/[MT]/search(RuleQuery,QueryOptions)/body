{
  QueryBuilder qb;
  if (query.getQueryText() != null && !query.getQueryText().isEmpty()) {
    qb=QueryBuilders.multiMatchQuery(query.getQueryText(),RuleField.NAME.key(),RuleField.NAME.key() + ".search",RuleField.DESCRIPTION.key(),RuleField.KEY.key(),RuleField.LANGUAGE.key(),RuleField.TAGS.key());
  }
 else {
    qb=QueryBuilders.matchAllQuery();
  }
  BoolFilterBuilder fb=FilterBuilders.boolFilter();
  this.addTermFilter(RuleField.LANGUAGE.key(),query.getLanguages(),fb);
  this.addTermFilter(RuleField.REPOSITORY.key(),query.getRepositories(),fb);
  this.addTermFilter(RuleField.SEVERITY.key(),query.getSeverities(),fb);
  this.addTermFilter(RuleField.KEY.key(),query.getKey(),fb);
  QueryBuilder mainQuery;
  if ((query.getLanguages() != null && !query.getLanguages().isEmpty()) || (query.getRepositories() != null && !query.getRepositories().isEmpty()) || (query.getSeverities() != null && !query.getSeverities().isEmpty())|| (query.getKey() != null && !query.getKey().isEmpty())) {
    mainQuery=QueryBuilders.filteredQuery(qb,fb);
  }
 else {
    mainQuery=qb;
  }
  Set<String> fields=new HashSet<String>();
  fields.addAll(options.getFieldsToReturn());
  fields.add(RuleField.KEY.key());
  SearchRequestBuilder esSearch=getClient().prepareSearch(this.getIndexName()).setQuery(mainQuery).addFields(fields.toArray(new String[fields.size()]));
  SearchResponse esResult=esSearch.get();
  Results results=new Results().setTotal((int)esResult.getHits().totalHits()).setTime(esResult.getTookInMillis());
  for (  SearchHit esHit : esResult.getHits().getHits()) {
    Hit hit=new Hit(esHit.score());
    for (    Map.Entry<String,SearchHitField> entry : esHit.fields().entrySet()) {
      if (entry.getValue().getValues().size() > 1) {
        hit.getFields().put(entry.getKey(),entry.getValue().getValues());
      }
 else {
        hit.getFields().put(entry.getKey(),entry.getValue().getValue());
      }
    }
    results.getHits().add(hit);
  }
  return results;
}
