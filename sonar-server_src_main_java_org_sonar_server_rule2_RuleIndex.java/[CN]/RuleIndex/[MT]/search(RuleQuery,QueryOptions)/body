{
  SearchRequestBuilder esSearch=getClient().prepareSearch(this.getIndexName()).setIndices(this.getIndexName());
  QueryBuilder qb;
  if (query.getQueryText() != null && !query.getQueryText().isEmpty()) {
    qb=QueryBuilders.multiMatchQuery(query.getQueryText(),"_id",RuleField.NAME.key(),RuleField.NAME.key() + ".search",RuleField.DESCRIPTION.key(),RuleField.KEY.key(),RuleField.LANGUAGE.key(),RuleField.TAGS.key());
  }
 else {
    qb=QueryBuilders.matchAllQuery();
  }
  BoolFilterBuilder fb=FilterBuilders.boolFilter();
  this.addTermFilter(RuleField.LANGUAGE.key(),query.getLanguages(),fb);
  this.addTermFilter(RuleField.REPOSITORY.key(),query.getRepositories(),fb);
  this.addTermFilter(RuleField.SEVERITY.key(),query.getSeverities(),fb);
  this.addTermFilter(RuleField.KEY.key(),query.getKey(),fb);
  if (query.getStatuses() != null && !query.getStatuses().isEmpty()) {
    Collection<String> stringStatus=new ArrayList<String>();
    for (    RuleStatus status : query.getStatuses()) {
      stringStatus.add(status.name());
    }
    this.addTermFilter(RuleField.STATUS.key(),stringStatus,fb);
  }
  QueryBuilder mainQuery;
  if ((query.getLanguages() != null && !query.getLanguages().isEmpty()) || (query.getRepositories() != null && !query.getRepositories().isEmpty()) || (query.getSeverities() != null && !query.getSeverities().isEmpty())|| (query.getStatuses() != null && !query.getStatuses().isEmpty())|| (query.getKey() != null && !query.getKey().isEmpty())) {
    mainQuery=QueryBuilders.filteredQuery(qb,fb);
  }
 else {
    mainQuery=qb;
  }
  esSearch.setQuery(mainQuery);
  System.out.println(mainQuery.toString());
  if (options.getFieldsToReturn() != null && !options.getFieldsToReturn().isEmpty()) {
    for (    String field : options.getFieldsToReturn()) {
      esSearch.addField(field);
    }
  }
 else {
    for (    RuleField field : RuleField.values()) {
      esSearch.addField(field.key());
    }
  }
  SearchResponse esResult=esSearch.get();
  System.out.println(esResult);
  Results results=new Results().setTotal((int)esResult.getHits().totalHits()).setTime(esResult.getTookInMillis()).setHits(this.toHit(esResult.getHits()));
  return results;
}
