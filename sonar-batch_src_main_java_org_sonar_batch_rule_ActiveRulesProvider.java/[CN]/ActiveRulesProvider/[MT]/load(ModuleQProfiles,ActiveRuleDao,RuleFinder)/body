{
  ActiveRulesBuilder builder=new ActiveRulesBuilder();
  for (  QProfile qProfile : qProfiles.findAll()) {
    ListMultimap<Integer,ActiveRuleParamDto> paramDtosByActiveRuleId=ArrayListMultimap.create();
    for (    ActiveRuleParamDto dto : dao.selectParamsByProfileKey(qProfile.getKey())) {
      paramDtosByActiveRuleId.put(dto.getActiveRuleId(),dto);
    }
    for (    ActiveRuleDto activeDto : dao.selectByProfileKey(qProfile.getKey())) {
      Rule rule=ruleFinder.findById(activeDto.getRulId());
      if (rule != null) {
        NewActiveRule newActiveRule=builder.create(rule.ruleKey());
        newActiveRule.setSeverity(activeDto.getSeverityString());
        newActiveRule.setLanguage(rule.getLanguage());
        Rule template=rule.getTemplate();
        if (template != null) {
          newActiveRule.setInternalKey(template.getConfigKey());
        }
 else {
          newActiveRule.setInternalKey(rule.getConfigKey());
        }
        for (        ActiveRuleParamDto paramDto : paramDtosByActiveRuleId.get(activeDto.getId())) {
          newActiveRule.setParam(paramDto.getKey(),paramDto.getValue());
        }
        for (        RuleParam param : rule.getParams()) {
          if (!newActiveRule.params().containsKey(param.getKey())) {
            newActiveRule.setParam(param.getKey(),param.getDefaultValue());
          }
        }
        newActiveRule.activate();
      }
    }
  }
  return builder.build();
}
