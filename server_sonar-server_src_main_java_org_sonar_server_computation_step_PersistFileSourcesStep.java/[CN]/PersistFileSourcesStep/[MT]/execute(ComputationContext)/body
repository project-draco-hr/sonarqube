{
  int rootComponentRef=context.getReportMetadata().getRootComponentRef();
  DbSession session=dbClient.openSession(false);
  try {
    final Map<String,FileSourceDto> previousFileSourcesByUuid=new HashMap<>();
    String projectUuid=dbComponentsRefCache.getByRef(context.getReportMetadata().getRootComponentRef()).getUuid();
    session.select("org.sonar.core.source.db.FileSourceMapper.selectHashesForProject",ImmutableMap.of("projectUuid",projectUuid,"dataType",Type.SOURCE),new ResultHandler(){
      @Override public void handleResult(      ResultContext context){
        FileSourceDto dto=(FileSourceDto)context.getResultObject();
        previousFileSourcesByUuid.put(dto.getFileUuid(),dto);
      }
    }
);
    recursivelyProcessComponent(new FileSourcesContext(session,context,previousFileSourcesByUuid,projectUuid),rootComponentRef);
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
