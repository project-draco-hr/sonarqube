{
  try {
    XContentBuilder document=jsonBuilder().startObject();
    ActiveRuleKey key=rule.getKey();
    if (key == null) {
      throw new IllegalStateException("Cannot normalize ActiveRuleDto with null key");
    }
    document.startObject(RuleNormalizer.RuleField.ACTIVE.key());
    document.startObject(key.toString());
    indexField(ActiveRuleField.KEY.key(),rule.getKey(),document);
    indexField(ActiveRuleField.INHERITANCE.key(),rule.getInheritance(),document);
    indexField(ActiveRuleField.PROFILE_ID.key(),rule.getProfileId(),document);
    indexField(ActiveRuleField.SEVERITY.key(),rule.getSeverityString(),document);
    if (rule.getParentId() != null) {
      DbSession session=db.openSession(false);
      ActiveRuleDto dto=this.db.activeRuleDao().getById(rule.getParentId(),session);
      session.close();
      indexField(ActiveRuleField.PARENT_KEY.key(),dto.getKey().toString(),document);
    }
    document.endObject();
    document.endObject();
    UpdateRequest request=new UpdateRequest().doc(document);
    request.docAsUpsert(true);
    return request;
  }
 catch (  Exception e) {
    throw new IllegalStateException(String.format("Could not normalize Object with key %s",rule.getKey().toString()),e);
  }
}
