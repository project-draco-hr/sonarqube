{
  TimeProfiler profiler=new TimeProfiler().start("Execute Findbugs " + FindbugsVersion.getVersion());
  SecurityManager currentSecurityManager=System.getSecurityManager();
  ClassLoader initialClassLoader=Thread.currentThread().getContextClassLoader();
  Thread.currentThread().setContextClassLoader(FindBugs2.class.getClassLoader());
  OutputStream xmlOutput=null;
  Collection<Plugin> customPlugins=null;
  ExecutorService executorService=Executors.newSingleThreadExecutor();
  try {
    final FindBugs2 engine=new FindBugs2();
    customPlugins=loadFindbugsPlugins();
    disableUpdateChecksOnEveryPlugin();
    Project project=configuration.getFindbugsProject();
    engine.setProject(project);
    XMLBugReporter xmlBugReporter=new XMLBugReporter(project);
    xmlBugReporter.setPriorityThreshold(Priorities.LOW_PRIORITY);
    xmlBugReporter.setAddMessages(true);
    File xmlReport=configuration.getTargetXMLReport();
    LOG.info("Findbugs output report: " + xmlReport.getAbsolutePath());
    xmlOutput=FileUtils.openOutputStream(xmlReport);
    xmlBugReporter.setOutputStream(new PrintStream(xmlOutput));
    engine.setBugReporter(xmlBugReporter);
    UserPreferences userPreferences=UserPreferences.createDefaultUserPreferences();
    userPreferences.setEffort(configuration.getEffort());
    engine.setUserPreferences(userPreferences);
    engine.addFilter(configuration.saveIncludeConfigXml().getAbsolutePath(),true);
    engine.addFilter(configuration.saveExcludeConfigXml().getAbsolutePath(),false);
    for (    File filterFile : configuration.getExcludesFilters()) {
      if (filterFile.isFile()) {
        engine.addFilter(filterFile.getAbsolutePath(),false);
      }
 else {
        LOG.warn("FindBugs filter-file not found: {}",filterFile);
      }
    }
    engine.setDetectorFactoryCollection(DetectorFactoryCollection.instance());
    engine.setAnalysisFeatureSettings(FindBugs.DEFAULT_EFFORT);
    engine.finishSettings();
    executorService.submit(new FindbugsTask(engine)).get(configuration.getTimeout(),TimeUnit.MILLISECONDS);
    profiler.stop();
    return xmlReport;
  }
 catch (  Exception e) {
    throw new SonarException("Can not execute Findbugs",e);
  }
 finally {
    System.setSecurityManager(currentSecurityManager);
    resetCustomPluginList(customPlugins);
    executorService.shutdown();
    IOUtils.closeQuietly(xmlOutput);
    Thread.currentThread().setContextClassLoader(initialClassLoader);
  }
}
