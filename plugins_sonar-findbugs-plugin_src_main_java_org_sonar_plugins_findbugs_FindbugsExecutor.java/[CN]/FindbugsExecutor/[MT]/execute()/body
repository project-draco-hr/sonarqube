{
  TimeProfiler profiler=new TimeProfiler().start("Execute Findbugs " + FindbugsVersion.getVersion());
  ClassLoader initialClassLoader=Thread.currentThread().getContextClassLoader();
  Thread.currentThread().setContextClassLoader(FindBugs2.class.getClassLoader());
  OutputStream xmlOutput=null;
  try {
    final FindBugs2 engine=new FindBugs2();
    Project project=configuration.getFindbugsProject();
    engine.setProject(project);
    XMLBugReporter xmlBugReporter=new XMLBugReporter(project);
    xmlBugReporter.setPriorityThreshold(Priority.LOW.getPriorityValue());
    File xmlReport=configuration.getTargetXMLReport();
    if (xmlReport != null) {
      LOG.info("Findbugs output report: " + xmlReport.getAbsolutePath());
      xmlOutput=FileUtils.openOutputStream(xmlReport);
    }
 else {
      xmlOutput=new NullOutputStream();
    }
    xmlBugReporter.setOutputStream(new PrintStream(xmlOutput));
    engine.setBugReporter(xmlBugReporter);
    engine.setProject(project);
    engine.setDetectorFactoryCollection(DetectorFactoryCollection.instance());
    UserPreferences userPreferences=UserPreferences.createDefaultUserPreferences();
    userPreferences.setEffort(configuration.getEffort());
    engine.addFilter(configuration.saveIncludeConfigXml().getAbsolutePath(),true);
    engine.addFilter(configuration.saveExcludeConfigXml().getAbsolutePath(),false);
    engine.setUserPreferences(userPreferences);
    engine.setAnalysisFeatureSettings(FindBugs.DEFAULT_EFFORT);
    engine.finishSettings();
    Executors.newSingleThreadExecutor().submit(new FindbugsTask(engine)).get(configuration.getTimeout(),TimeUnit.MILLISECONDS);
    profiler.stop();
    return xmlReport;
  }
 catch (  Exception e) {
    throw new SonarException("Can not execute Findbugs",e);
  }
 finally {
    IOUtils.closeQuietly(xmlOutput);
    Thread.currentThread().setContextClassLoader(initialClassLoader);
  }
}
