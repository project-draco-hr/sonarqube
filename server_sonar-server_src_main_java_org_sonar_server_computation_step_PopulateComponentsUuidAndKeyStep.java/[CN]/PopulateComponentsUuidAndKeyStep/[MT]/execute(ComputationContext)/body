{
  DbSession session=dbClient.openSession(false);
  try {
    String branch=context.getReportMetadata().hasBranch() ? context.getReportMetadata().getBranch() : null;
    BatchReport.Component project=reportReader.readComponent(context.getReportMetadata().getRootComponentRef());
    String projectKey=ComponentKeys.createKey(project.getKey(),branch);
    Map<String,String> componentUuidsByKey=new HashMap<>();
    List<ComponentDto> components=dbClient.componentDao().selectComponentsFromProjectKey(session,projectKey);
    for (    ComponentDto componentDto : components) {
      componentUuidsByKey.put(componentDto.getKey(),componentDto.uuid());
    }
    ComponentContext componentContext=new ComponentContext(reportReader,componentUuidsByKey,branch);
    Component root=context.getRoot();
    processProject(componentContext,root,projectKey);
    processChildren(componentContext,root,root);
    session.commit();
  }
  finally {
    session.close();
  }
}
