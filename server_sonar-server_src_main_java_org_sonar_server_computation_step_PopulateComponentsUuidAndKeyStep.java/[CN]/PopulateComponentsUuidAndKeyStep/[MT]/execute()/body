{
  DbSession session=dbClient.openSession(false);
  try {
    BatchReport.Metadata metadata=reportReader.readMetadata();
    String branch=metadata.hasBranch() ? metadata.getBranch() : null;
    BatchReport.Component project=reportReader.readComponent(metadata.getRootComponentRef());
    String projectKey=ComponentKeys.createKey(project.getKey(),branch);
    Map<String,String> componentUuidsByKey=new HashMap<>();
    List<ComponentDto> components=dbClient.componentDao().selectComponentsFromProjectKey(session,projectKey);
    for (    ComponentDto componentDto : components) {
      componentUuidsByKey.put(componentDto.getKey(),componentDto.uuid());
    }
    ComponentContext componentContext=new ComponentContext(reportReader,componentUuidsByKey,branch);
    Component root=treeRootHolder.getRoot();
    processProject(componentContext,root,projectKey);
    processChildren(componentContext,root,root);
    session.commit();
  }
  finally {
    session.close();
  }
}
