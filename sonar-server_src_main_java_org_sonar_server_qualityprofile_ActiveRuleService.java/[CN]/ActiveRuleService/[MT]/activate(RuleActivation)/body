{
  verifyPermission(UserSession.get());
  DbSession dbSession=db.openSession(false);
  List<ActiveRuleChange> changes=Lists.newArrayList();
  try {
    RuleActivationContext context=contextFactory.create(activation.getKey(),dbSession);
    ActiveRuleChange change;
    if (context.activeRule() == null) {
      change=new ActiveRuleChange(ActiveRuleChange.Type.ACTIVATED,activation.getKey());
    }
 else {
      change=new ActiveRuleChange(ActiveRuleChange.Type.UPDATED,activation.getKey());
    }
    change.setSeverity(StringUtils.defaultIfEmpty(activation.getSeverity(),context.defaultSeverity()));
    for (    RuleParamDto ruleParamDto : context.ruleParams()) {
      String value=activation.getParameters().get(ruleParamDto.getName());
      verifyParam(ruleParamDto,value);
      change.setParameter(ruleParamDto.getName(),StringUtils.defaultIfEmpty(value,ruleParamDto.getDefaultValue()));
    }
    changes.add(change);
    persist(changes,context,dbSession);
    return changes;
  }
  finally {
    dbSession.close();
  }
}
