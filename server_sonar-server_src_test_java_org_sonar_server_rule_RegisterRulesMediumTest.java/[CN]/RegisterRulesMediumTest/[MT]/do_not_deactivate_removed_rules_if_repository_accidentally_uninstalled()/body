{
  Rules rules=new Rules(){
    @Override public void init(    RulesDefinition.NewRepository repository){
      repository.createRule("x1").setName("x1 name").setHtmlDescription("x1 desc");
    }
  }
;
  register(rules);
  userSessionRule.login().setGlobalPermissions(GlobalPermissions.QUALITY_PROFILE_ADMIN);
  db.qualityProfileDao().insert(dbSession,QProfileTesting.newXooP1());
  dbSession.commit();
  dbSession.clearCache();
  RuleActivation activation=new RuleActivation(RuleTesting.XOO_X1);
  TESTER.get(QProfileService.class).activate(QProfileTesting.XOO_P1_KEY,activation);
  register(null);
  dbSession.commit();
  dbSession.clearCache();
  assertThat(ruleIndex.search(new RuleQuery().setKey(RuleTesting.XOO_X1.toString()),new SearchOptions()).getTotal()).isEqualTo(0);
  assertThat(db.activeRuleDao().selectByProfileKey(dbSession,QProfileTesting.XOO_P1_KEY)).hasSize(1);
  register(rules);
  assertThat(ruleIndex.search(new RuleQuery().setKey(RuleTesting.XOO_X1.toString()),new SearchOptions()).getTotal()).isEqualTo(1);
  assertThat(db.activeRuleDao().selectByProfileKey(dbSession,QProfileTesting.XOO_P1_KEY)).hasSize(1);
}
