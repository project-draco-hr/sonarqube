{
  BatchResource batchResource=resourceCache.get(resource.getEffectiveKey());
  if (batchResource == null) {
    throw new IllegalStateException("Unknow component: " + resource);
  }
  if (event.getDate() == null) {
    event.setSnapshot(batchResource.snapshot());
  }
 else {
    event.setResourceId(batchResource.resource().getId());
  }
  session.save(event);
  session.commit();
}
