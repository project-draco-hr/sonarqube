{
  DbSession session=mybatis.openSession(true);
  ResourceKeyUpdaterMapper mapper=session.getMapper(ResourceKeyUpdaterMapper.class);
  try {
    Set<ResourceDto> modules=collectAllModules(projectId,stringToReplace,mapper);
    checkNewNameOfAllModules(modules,stringToReplace,replacementString,mapper);
    Map<ResourceDto,List<ResourceDto>> allResourcesByModuleMap=Maps.newHashMap();
    for (    ResourceDto module : modules) {
      allResourcesByModuleMap.put(module,mapper.selectProjectResources(module.getId()));
    }
    for (    ResourceDto module : modules) {
      String oldModuleKey=module.getKey();
      String newModuleKey=computeNewKey(module,stringToReplace,replacementString);
      Collection<ResourceDto> resources=Lists.newArrayList(module);
      resources.addAll(allResourcesByModuleMap.get(module));
      runBatchUpdateForAllResources(resources,oldModuleKey,newModuleKey,mapper);
    }
    session.commit();
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
