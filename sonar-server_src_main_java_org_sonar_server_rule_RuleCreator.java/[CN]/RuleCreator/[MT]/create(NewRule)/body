{
  DbSession dbSession=dbClient.openSession(false);
  try {
    RuleKey templateKey=newRule.templateKey();
    if (templateKey != null) {
      RuleDto templateRule=dbClient.ruleDao().getByKey(dbSession,templateKey);
      if (!Cardinality.MULTIPLE.equals(templateRule.getCardinality())) {
        throw new IllegalArgumentException("This rule is not a template rule: " + templateKey.toString());
      }
      validateRule(newRule);
      RuleKey customRuleKey=RuleKey.of(templateRule.getRepositoryKey(),newRule.ruleKey());
      checkRuleKeyUnicity(customRuleKey,dbSession);
      createCustomRule(customRuleKey,newRule,templateRule,dbSession);
      dbSession.commit();
      return customRuleKey;
    }
    throw new IllegalArgumentException("Not supported");
  }
  finally {
    dbSession.close();
  }
}
