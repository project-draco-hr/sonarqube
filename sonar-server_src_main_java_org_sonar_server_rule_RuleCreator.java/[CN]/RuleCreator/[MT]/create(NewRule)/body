{
  DbSession dbSession=dbClient.openSession(false);
  try {
    RuleKey templateKey=newRule.templateKey();
    if (templateKey != null) {
      RuleDto templateRule=dbClient.ruleDao().getByKey(dbSession,templateKey);
      if (!templateRule.isTemplate()) {
        throw new IllegalArgumentException("This rule is not a template rule: " + templateKey.toString());
      }
      validateCustomRule(newRule);
      RuleKey customRuleKey=RuleKey.of(templateRule.getRepositoryKey(),newRule.ruleKey());
      checkRuleKeyUnicity(customRuleKey,dbSession);
      createCustomRule(customRuleKey,newRule,templateRule,dbSession);
      dbSession.commit();
      return customRuleKey;
    }
 else {
      validateManualRule(newRule);
      RuleKey customRuleKey=RuleKey.of(RuleDoc.MANUAL_REPOSITORY,newRule.ruleKey());
      checkRuleKeyUnicity(customRuleKey,dbSession);
      createManualRule(customRuleKey,newRule,dbSession);
      dbSession.commit();
      return customRuleKey;
    }
  }
  finally {
    dbSession.close();
  }
}
