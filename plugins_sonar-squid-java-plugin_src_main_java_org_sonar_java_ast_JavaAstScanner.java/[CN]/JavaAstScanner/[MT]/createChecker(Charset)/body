{
  String checkstyleConfig=loadCheckstyleConfigToString().replace("${charset}",charset.toString());
  try {
    Configuration config=ConfigurationLoader.loadConfiguration(new InputSource(new ByteArrayInputStream(checkstyleConfig.getBytes())),new PropertiesExpander(System.getProperties()),false);
    Checker checker=new Checker();
    final ClassLoader moduleClassLoader=Checker.class.getClassLoader();
    checker.setModuleClassLoader(moduleClassLoader);
    checker.configure(config);
    checker.addListener(new CheckstyleAuditListener());
    return checker;
  }
 catch (  Exception e) {
    throw new AnalysisException("Unable to create Checkstyle Checker",e);
  }
}
