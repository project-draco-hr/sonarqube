{
  CharacteristicDto char1=new CharacteristicDto().setEnabled(true).setKey("c1").setName("char1");
  db.debtCharacteristicDao().insert(char1,dbSession);
  dbSession.commit();
  CharacteristicDto char11=new CharacteristicDto().setEnabled(true).setKey("c11").setName("char11").setParentId(char1.getId());
  db.debtCharacteristicDao().insert(char11,dbSession);
  RuleKey ruleKey=RuleKey.of("test","r1");
  RuleDto ruleDto=newRuleDto(ruleKey).setDefaultSubCharacteristicId(char11.getId());
  dao.insert(ruleDto,dbSession);
  dbSession.commit();
  assertThat(db.debtCharacteristicDao().selectByKey("c1",dbSession)).isNotNull();
  assertThat(db.debtCharacteristicDao().selectByKey("c1",dbSession).getParentId()).isNull();
  assertThat(db.debtCharacteristicDao().selectByKey("c11",dbSession)).isNotNull();
  assertThat(db.debtCharacteristicDao().selectByKey("c11",dbSession).getParentId()).isEqualTo(char1.getId());
  Rule rule=index.getByKey(ruleKey);
  assertThat(rule.debtCharacteristicKey()).isEqualTo(char1.getKey());
  assertThat(rule.debtSubCharacteristicKey()).isEqualTo(char11.getKey());
  CharacteristicDto char2=new CharacteristicDto().setEnabled(true).setKey("c2").setName("char2");
  db.debtCharacteristicDao().insert(char2,dbSession);
  CharacteristicDto char21=new CharacteristicDto().setEnabled(true).setKey("c21").setName("char21").setParentId(char2.getId());
  db.debtCharacteristicDao().insert(char21,dbSession);
  ruleDto.setSubCharacteristicId(char21.getId());
  dao.update(ruleDto,dbSession);
  dbSession.commit();
  rule=index.getByKey(ruleKey);
  assertThat(rule.debtCharacteristicKey()).isEqualTo(char2.getKey());
  assertThat(rule.debtSubCharacteristicKey()).isEqualTo(char21.getKey());
}
