{
  File destDir=fs.getUserPluginsDir();
  File destFile=new File(destDir,sourceFile.getName());
  if (destFile.exists()) {
    deleteQuietly(destFile);
  }
  try {
    if (deleteSource) {
      moveFile(sourceFile,destFile);
    }
 else {
      copyFile(sourceFile,destFile,true);
    }
  }
 catch (  IOException e) {
    LOG.error(format("Fail to move or copy plugin: %s to %s",sourceFile.getAbsolutePath(),destFile.getAbsolutePath()),e);
  }
  PluginMetadata metadata=installer.fileToPlugin(false).apply(destFile);
  if (isNotBlank(metadata.getKey())) {
    PluginMetadata existing=pluginByKeys.put(metadata.getKey(),metadata);
    if (existing != null) {
      if (!existing.getFile().getName().equals(destFile.getName())) {
        deleteQuietly(existing.getFile());
      }
      LOG.info("Plugin " + metadata.getKey() + " replaced by new version");
    }
  }
}
