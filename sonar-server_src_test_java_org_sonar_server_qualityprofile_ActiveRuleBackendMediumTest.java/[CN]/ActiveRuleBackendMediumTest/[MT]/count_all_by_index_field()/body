{
  QualityProfileDto profileDto1=QualityProfileDto.createFor("p1","java");
  QualityProfileDto profileDto2=QualityProfileDto.createFor("p2","java");
  db.qualityProfileDao().insert(dbSession,profileDto1,profileDto2);
  RuleKey ruleKey=RuleKey.of("javascript","S001");
  RuleDto ruleDto=newRuleDto(ruleKey);
  db.ruleDao().insert(dbSession,ruleDto);
  ActiveRuleDto activeRule1=ActiveRuleDto.createFor(profileDto1,ruleDto).setSeverity(Severity.MAJOR);
  ActiveRuleDto activeRule2=ActiveRuleDto.createFor(profileDto2,ruleDto).setSeverity(Severity.MAJOR);
  db.activeRuleDao().insert(dbSession,activeRule1,activeRule2);
  dbSession.commit();
  assertThat(index.countAll()).isEqualTo(2);
  Map<String,Long> counts=index.countByField(ActiveRuleNormalizer.ActiveRuleField.PROFILE_KEY);
  assertThat(counts).hasSize(2);
  assertThat(counts.values()).containsOnly(1L,1L);
  assertThat(counts.keySet()).containsOnly(profileDto1.getKey().toString(),profileDto2.getKey().toString());
}
