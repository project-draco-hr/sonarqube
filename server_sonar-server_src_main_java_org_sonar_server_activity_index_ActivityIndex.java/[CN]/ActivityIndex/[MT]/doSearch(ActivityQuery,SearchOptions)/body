{
  SearchRequestBuilder requestBuilder=getClient().prepareSearch(ActivityIndexDefinition.INDEX).setTypes(ActivityIndexDefinition.TYPE);
  requestBuilder.setFrom(options.getOffset());
  requestBuilder.setSize(options.getLimit());
  requestBuilder.addSort(ActivityIndexDefinition.FIELD_CREATED_AT,SortOrder.DESC);
  AndQueryBuilder filter=QueryBuilders.andQuery();
  if (!query.getTypes().isEmpty()) {
    OrQueryBuilder typeQuery=QueryBuilders.orQuery();
    for (    String type : query.getTypes()) {
      typeQuery.add(QueryBuilders.termQuery(ActivityIndexDefinition.FIELD_TYPE,type));
    }
    filter.add(typeQuery);
  }
  if (!query.getDataOrFilters().isEmpty()) {
    for (    Map.Entry<String,Object> entry : query.getDataOrFilters().entrySet()) {
      OrQueryBuilder orQuery=QueryBuilders.orQuery();
      orQuery.add(QueryBuilders.nestedQuery(ActivityIndexDefinition.FIELD_DETAILS,QueryBuilders.termQuery(ActivityIndexDefinition.FIELD_DETAILS + "." + entry.getKey(),entry.getValue())));
      filter.add(orQuery);
    }
  }
  Date since=query.getSince();
  if (since != null) {
    filter.add(QueryBuilders.rangeQuery(ActivityIndexDefinition.FIELD_CREATED_AT).gt(since));
  }
  Date to=query.getTo();
  if (to != null) {
    filter.add(QueryBuilders.rangeQuery(ActivityIndexDefinition.FIELD_CREATED_AT).lt(to));
  }
  requestBuilder.setQuery(QueryBuilders.filteredQuery(QueryBuilders.matchAllQuery(),filter));
  return requestBuilder.get();
}
