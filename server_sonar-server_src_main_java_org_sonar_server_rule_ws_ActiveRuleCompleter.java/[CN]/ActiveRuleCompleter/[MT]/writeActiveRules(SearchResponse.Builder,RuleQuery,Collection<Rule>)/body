{
  Collection<String> qProfileKeys=newHashSet();
  Rules.Actives.Builder activesBuilder=response.getActivesBuilder();
  String profileKey=query.getQProfileKey();
  if (profileKey != null) {
    for (    Rule rule : rules) {
      ActiveRule activeRule=loader.getActiveRule(ActiveRuleKey.of(profileKey,rule.key()));
      if (activeRule != null) {
        qProfileKeys=writeActiveRules(rule.key(),Arrays.asList(activeRule),activesBuilder);
      }
    }
  }
 else {
    for (    Rule rule : rules) {
      qProfileKeys=writeActiveRules(rule.key(),loader.findActiveRulesByRule(rule.key()),activesBuilder);
    }
  }
  response.setActives(activesBuilder);
  return qProfileKeys;
}
