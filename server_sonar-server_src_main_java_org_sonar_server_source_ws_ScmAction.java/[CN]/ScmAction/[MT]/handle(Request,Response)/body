{
  String fileKey=request.mandatoryParam("key");
  int from=Math.max(request.mandatoryParamAsInt("from"),1);
  int to=(Integer)ObjectUtils.defaultIfNull(request.paramAsInt("to"),Integer.MAX_VALUE);
  boolean commitsByLine=request.mandatoryParamAsBoolean("commits_by_line");
  DbSession session=dbClient.openSession(false);
  try {
    ComponentDto fileDto=dbClient.componentDao().getByKey(session,fileKey);
    userSession.checkProjectUuidPermission(UserRole.CODEVIEWER,fileDto.projectUuid());
    List<SourceLineDoc> sourceLines=sourceLineIndex.getLines(fileDto.uuid(),from,to);
    if (sourceLines.isEmpty()) {
      throw new NotFoundException("File '" + fileKey + "' has no sources");
    }
    JsonWriter json=response.newJsonWriter().beginObject();
    writeSource(sourceLines,commitsByLine,json);
    json.endObject().close();
  }
  finally {
    session.close();
  }
}
