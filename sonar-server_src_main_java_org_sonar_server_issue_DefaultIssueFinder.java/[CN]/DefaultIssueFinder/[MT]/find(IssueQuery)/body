{
  LOG.debug("IssueQuery : {}",query);
  long start=System.currentTimeMillis();
  SqlSession sqlSession=myBatis.openSession(false);
  try {
    List<IssueDto> authorizedIssues=issueDao.selectIssueIds(query,UserSession.get().userId(),sqlSession);
    List<IssueDto> authorizedSortedIssues=sort(authorizedIssues,query,authorizedIssues.size());
    Paging paging=Paging.create(query.pageSize(),query.pageIndex(),authorizedSortedIssues.size());
    Set<Long> pagedIssueIds=pagedIssueIds(authorizedSortedIssues,paging);
    List<IssueDto> pagedIssues=issueDao.selectByIds(pagedIssueIds,sqlSession);
    List<IssueDto> pagedSortedIssues=sort(pagedIssues,query,authorizedIssues.size());
    Map<String,DefaultIssue> issuesByKey=newHashMap();
    List<Issue> issues=newArrayList();
    Set<Integer> ruleIds=newHashSet();
    Set<Long> componentIds=newHashSet();
    Set<String> actionPlanKeys=newHashSet();
    Set<String> users=newHashSet();
    for (    IssueDto dto : pagedSortedIssues) {
      DefaultIssue defaultIssue=dto.toDefaultIssue();
      issuesByKey.put(dto.getKee(),defaultIssue);
      issues.add(defaultIssue);
      ruleIds.add(dto.getRuleId());
      componentIds.add(dto.getComponentId());
      actionPlanKeys.add(dto.getActionPlanKey());
      if (dto.getReporter() != null) {
        users.add(dto.getReporter());
      }
      if (dto.getAssignee() != null) {
        users.add(dto.getAssignee());
      }
    }
    List<DefaultIssueComment> comments=issueChangeDao.selectCommentsByIssues(sqlSession,issuesByKey.keySet());
    for (    DefaultIssueComment comment : comments) {
      DefaultIssue issue=issuesByKey.get(comment.issueKey());
      issue.addComment(comment);
      if (comment.userLogin() != null) {
        users.add(comment.userLogin());
      }
    }
    Collection<Component> components=findComponents(componentIds);
    Collection<Component> groupComponents=findSubProjects(components);
    Collection<Component> rootComponents=findProjects(components);
    Set<Component> allComponents=newHashSet(components);
    allComponents.addAll(groupComponents);
    allComponents.addAll(rootComponents);
    return new DefaultIssueQueryResult(issues).setMaxResultsReached(authorizedIssues.size() == query.maxResults()).addRules(hideRules(query) ? Collections.<Rule>emptyList() : findRules(ruleIds)).addComponents(allComponents).addProjects(rootComponents).addActionPlans(findActionPlans(actionPlanKeys)).addUsers(findUsers(users)).setPaging(paging);
  }
  finally {
    MyBatis.closeQuietly(sqlSession);
    LOG.debug("IssueQuery execution time : {} ms",System.currentTimeMillis() - start);
  }
}
