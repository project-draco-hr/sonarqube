{
  DbSession session=dbClient.openSession(false);
  try {
    List<ComponentDto> baseModules=dbClient.componentDao().selectEnabledModulesFromProjectKey(session,treeRootHolder.getRoot().getKey());
    Map<String,ComponentDto> baseModulesByKey=FluentIterable.from(baseModules).uniqueIndex(ComponentDtoToKey.INSTANCE);
    ValidateProjectsVisitor visitor=new ValidateProjectsVisitor(session,dbClient.componentDao(),settings.getBoolean(CoreProperties.CORE_PREVENT_AUTOMATIC_PROJECT_CREATION),baseModulesByKey);
    visitor.visit(treeRootHolder.getRoot());
    if (!visitor.validationMessages.isEmpty()) {
      throw MessageException.of("Validation of project failed:\n  o " + MESSAGES_JOINER.join(visitor.validationMessages));
    }
  }
  finally {
    session.close();
  }
}
