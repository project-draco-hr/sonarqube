{
  ResourceModel model=findOrCreateModel(library,null);
  model=session.save(model);
  library.setId(model.getId());
  library.setUuid(model.getUuid());
  library.setEffectiveKey(library.getKey());
  Snapshot snapshot=findLibrarySnapshot(model.getId(),library.getVersion());
  if (snapshot == null) {
    snapshot=new Snapshot(model,null);
    snapshot.setCreatedAtMs(dateToLong(analysisDate));
    snapshot.setBuildDateMs(System.currentTimeMillis());
    snapshot.setVersion(library.getVersion());
    snapshot.setStatus(Snapshot.STATUS_PROCESSED);
    snapshot.setQualifier(Qualifiers.LIBRARY);
    snapshot=session.save(snapshot);
  }
  session.commit();
  return snapshot;
}
