{
  DbSession dbSession=dbClient.openSession(false);
  try {
    String userLogin=user.getLogin();
    UserDto userDto=dbClient.userDao().selectByLogin(dbSession,userLogin);
    if (userDto != null && userDto.isActive()) {
      userUpdater.update(dbSession,UpdateUser.create(userDto.getLogin()).setEmail(user.getEmail()).setName(user.getName()).setExternalIdentity(new ExternalIdentity(provider.getKey(),user.getProviderLogin())).setPassword(null));
      return userDto.getId();
    }
    if (!provider.allowsUsersToSignUp()) {
      throw new NotAllowUserToSignUpException(provider);
    }
    String email=user.getEmail();
    if (email != null && dbClient.userDao().doesEmailExist(dbSession,email)) {
      throw new EmailAlreadyExistsException(email);
    }
    userUpdater.create(dbSession,NewUser.create().setLogin(userLogin).setEmail(user.getEmail()).setName(user.getName()).setExternalIdentity(new ExternalIdentity(provider.getKey(),user.getProviderLogin())));
    return dbClient.userDao().selectOrFailByLogin(dbSession,userLogin).getId();
  }
  finally {
    dbClient.closeSession(dbSession);
  }
}
