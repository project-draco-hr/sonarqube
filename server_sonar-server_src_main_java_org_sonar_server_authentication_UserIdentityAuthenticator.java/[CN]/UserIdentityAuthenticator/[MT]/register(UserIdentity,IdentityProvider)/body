{
  DbSession dbSession=dbClient.openSession(false);
  try {
    String userId=user.getId();
    Optional<UserDto> userDto=dbClient.userDao().selectByExternalIdentity(dbSession,userId,provider.getKey());
    if (userDto.isPresent() && userDto.get().isActive()) {
      userUpdater.update(dbSession,UpdateUser.create(userDto.get().getLogin()).setEmail(user.getEmail()).setName(user.getName()));
      return userDto.get().getId();
    }
    if (!provider.allowsUsersToSignUp()) {
      throw new NotAllowUserToSignUpException(provider);
    }
    String email=user.getEmail();
    if (email != null && dbClient.userDao().doesEmailExist(dbSession,email)) {
      throw new EmailAlreadyExistsException(email);
    }
    userUpdater.create(dbSession,NewUser.create().setLogin(uuidFactory.create()).setEmail(user.getEmail()).setName(user.getName()).setExternalIdentity(new NewUser.ExternalIdentity(provider.getKey(),userId)));
    return dbClient.userDao().selectOrFailByExternalIdentity(dbSession,userId,provider.getKey()).getId();
  }
  finally {
    dbClient.closeSession(dbSession);
  }
}
