{
  DbSession dbSession=dbClient.openSession(false);
  try {
    String userLogin=user.getLogin();
    UserDto userDto=dbClient.userDao().selectByLogin(dbSession,userLogin);
    if (userDto != null && userDto.isActive()) {
      userUpdater.update(dbSession,UpdateUser.create(userDto.getLogin()).setEmail(user.getEmail()).setName(user.getName()).setExternalIdentity(new ExternalIdentity(provider.getKey(),user.getProviderLogin())).setPassword(null));
      return userDto.getId();
    }
    if (!provider.allowsUsersToSignUp()) {
      throw new UnauthorizedException(format("'%s' users are not allowed to sign up",provider.getKey()));
    }
    String email=user.getEmail();
    if (email != null && dbClient.userDao().doesEmailExist(dbSession,email)) {
      throw new UnauthorizedException(format("You can't sign up because email '%s' is already used by an existing user. This means that you probably already registered with another account.",email));
    }
    userUpdater.create(dbSession,NewUser.create().setLogin(userLogin).setEmail(user.getEmail()).setName(user.getName()).setExternalIdentity(new ExternalIdentity(provider.getKey(),user.getProviderLogin())));
    return dbClient.userDao().selectOrFailByLogin(dbSession,userLogin).getId();
  }
  finally {
    dbClient.closeSession(dbSession);
  }
}
