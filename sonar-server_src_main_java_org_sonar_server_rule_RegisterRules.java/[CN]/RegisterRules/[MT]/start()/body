{
  TimeProfiler profiler=new TimeProfiler().start("Register rules");
  SonarSession sqlSession=myBatis.openSession();
  try {
    RulesDefinition.Context context=defLoader.load();
    Buffer buffer=new Buffer(system.now());
    selectRulesFromDb(buffer,sqlSession);
    enableRuleDefinitions(context,buffer,sqlSession);
    List<RuleDto> removedRules=processRemainingDbRules(buffer,sqlSession);
    removeActiveRulesOnStillExistingRepositories(removedRules,context);
    index(buffer,sqlSession);
    ruleTagOperations.deleteUnusedTags(sqlSession);
    sqlSession.commit();
  }
  finally {
    sqlSession.close();
    profiler.stop();
  }
}
