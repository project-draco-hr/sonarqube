{
  List<RuleDto> removedRules=newArrayList();
  for (  RuleDto ruleDto : ruleDtos) {
    boolean toBeRemoved=true;
    if (ruleDto.getTemplateId() != null) {
      RuleDto template=dbClient.ruleDao().getTemplate(ruleDto,session);
      if (template != null && RuleStatus.REMOVED != template.getStatus()) {
        ruleDto.setLanguage(template.getLanguage());
        ruleDto.setStatus(template.getStatus());
        ruleDto.setDefaultSubCharacteristicId(template.getDefaultSubCharacteristicId());
        ruleDto.setDefaultRemediationFunction(template.getDefaultRemediationFunction());
        ruleDto.setDefaultRemediationCoefficient(template.getDefaultRemediationCoefficient());
        ruleDto.setDefaultRemediationOffset(template.getDefaultRemediationOffset());
        ruleDto.setEffortToFixDescription(template.getEffortToFixDescription());
        dbClient.ruleDao().update(session,ruleDto);
        toBeRemoved=false;
      }
    }
    if (toBeRemoved && RuleStatus.REMOVED != ruleDto.getStatus()) {
      LOG.info(String.format("Disable rule %s",ruleDto.getKey()));
      ruleDto.setStatus(RuleStatus.REMOVED);
      ruleDto.setSystemTags(Collections.<String>emptySet());
      ruleDto.setTags(Collections.<String>emptySet());
      dbClient.ruleDao().update(session,ruleDto);
      removedRules.add(ruleDto);
      if (removedRules.size() % 100 == 0) {
        session.commit();
      }
    }
  }
  if (!removedRules.isEmpty()) {
    session.commit();
  }
  return removedRules;
}
