{
  UserSession.get().checkLoggedIn();
  DbSession session=dbClient.openSession(false);
  try {
    AuthorizedComponentDto component=dbClient.componentDao().getAuthorizedComponentByKey(componentKey,session);
    ResourceDto provisioned=resourceDao.selectProvisionedProject(session,componentKey);
    if (provisioned == null) {
      checkProjectAdminPermission(componentKey);
    }
 else {
      UserSession.get().checkGlobalPermission(GlobalPermissions.PROVISIONING);
    }
    permissionFacade.grantDefaultRoles(session,component.getId(),component.qualifier());
    synchronizePermissions(session,componentKey);
    session.commit();
  }
  finally {
    session.close();
  }
}
