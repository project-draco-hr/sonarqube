{
  query.validate();
  boolean projectsChanged=false;
  DbSession session=dbClient.openSession(false);
  try {
    if (query.getSelectedComponents().size() == 1) {
      checkProjectAdminPermission(query.getSelectedComponents().get(0));
    }
 else {
      checkProjectAdminPermission(null);
      userSession.checkGlobalPermission(GlobalPermissions.SYSTEM_ADMIN);
    }
    for (    String componentKey : query.getSelectedComponents()) {
      ComponentDto component=dbClient.componentDao().getByKey(session,componentKey);
      permissionFacade.applyPermissionTemplate(session,query.getTemplateKey(),component.getId());
      projectsChanged=true;
    }
    session.commit();
  }
  finally {
    session.close();
  }
  if (projectsChanged) {
    indexProjectPermissions();
  }
}
