{
  UserSession.get().checkLoggedIn();
  ApplyPermissionTemplateQuery query=ApplyPermissionTemplateQuery.buildFromParams(params);
  query.validate();
  DbSession session=dbClient.openSession(false);
  try {
    if (query.getSelectedComponents().size() == 1) {
      checkProjectAdminPermission(query.getSelectedComponents().get(0));
    }
 else {
      checkProjectAdminPermission(null);
      UserSession.get().checkGlobalPermission(GlobalPermissions.SYSTEM_ADMIN);
    }
    for (    String componentKey : query.getSelectedComponents()) {
      AuthorizedComponentDto component=dbClient.componentDao().getAuthorizedComponentByKey(componentKey,session);
      permissionFacade.applyPermissionTemplate(session,query.getTemplateKey(),component.getId());
      synchronizePermissions(componentKey);
    }
    session.commit();
  }
  finally {
    session.close();
  }
}
