{
  BatchSettings batchSettings=mock(BatchSettings.class);
  when(batchSettings.getDefinitions()).thenReturn(new PropertyDefinitions());
  when(batchSettings.getString(CoreProperties.DRY_RUN)).thenReturn("true");
  when(batchSettings.getProperties()).thenReturn(ImmutableMap.of("sonar.foo.secured","bar"));
  when(client.request("/batch_bootstrap/properties?project=struts-core&dryRun=true")).thenReturn("[{\"k\":\"sonar.foo.license.secured\",\"v\":\"bar2\"}]");
  ProjectDefinition module=ProjectDefinition.create().setKey("struts-core");
  Configuration deprecatedConf=new PropertiesConfiguration();
  ModuleSettings moduleSettings=new ModuleSettings(batchSettings,module,deprecatedConf,client);
  assertThat(moduleSettings.getString("sonar.foo.license.secured")).isEqualTo("bar2");
  thrown.expect(SonarException.class);
  thrown.expectMessage("Access to the secured property 'sonar.foo.secured' is not possible in local (dry run) SonarQube analysis. The SonarQube plugin which requires this property must be deactivated in dry run mode.");
  moduleSettings.getString("sonar.foo.secured");
}
