{
  ListMultimap<PluginInfo,Object> installedExtensionsByPlugin=ArrayListMultimap.create();
  for (  PluginInfo pluginInfo : pluginRepository.getPluginInfos()) {
    try {
      String pluginKey=pluginInfo.getKey();
      Plugin plugin=pluginRepository.getPluginInstance(pluginKey);
      container.addExtension(pluginInfo,plugin);
      Plugin.Context context=new Plugin.Context(sonarQubeVersion);
      plugin.define(context);
      for (      Object extension : context.getExtensions()) {
        if (installExtension(container,pluginInfo,extension,true) != null) {
          installedExtensionsByPlugin.put(pluginInfo,extension);
        }
 else {
          container.declareExtension(pluginInfo,extension);
        }
      }
    }
 catch (    Throwable e) {
      throw new IllegalStateException(String.format("Fail to load plugin %s [%s]",pluginInfo.getName(),pluginInfo.getKey()),e);
    }
  }
  for (  Map.Entry<PluginInfo,Object> entry : installedExtensionsByPlugin.entries()) {
    PluginInfo pluginInfo=entry.getKey();
    try {
      Object extension=entry.getValue();
      if (isExtensionProvider(extension)) {
        ExtensionProvider provider=(ExtensionProvider)container.getComponentByKey(extension);
        installProvider(container,pluginInfo,provider);
      }
    }
 catch (    Throwable e) {
      throw new IllegalStateException(String.format("Fail to load plugin %s [%s]",pluginInfo.getName(),pluginInfo.getKey()),e);
    }
  }
}
