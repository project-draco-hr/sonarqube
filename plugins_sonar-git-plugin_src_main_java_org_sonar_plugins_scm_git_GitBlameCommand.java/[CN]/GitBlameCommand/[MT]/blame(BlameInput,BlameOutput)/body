{
  FileSystem fs=input.fileSystem();
  LOG.debug("Working directory: " + fs.baseDir().getAbsolutePath());
  for (  InputFile inputFile : input.filesToBlame()) {
    String filename=inputFile.relativePath();
    Command cl=createCommandLine(fs.baseDir(),filename);
    GitBlameConsumer consumer=new GitBlameConsumer(filename);
    StringStreamConsumer stderr=new StringStreamConsumer();
    int exitCode=execute(cl,consumer,stderr);
    if (exitCode != 0) {
      throw new IllegalStateException("The git blame command [" + cl.toString() + "] failed: "+ stderr.getOutput());
    }
    List<BlameLine> lines=consumer.getLines();
    if (lines.size() == inputFile.lines() - 1) {
      lines.add(lines.get(lines.size() - 1));
    }
    output.blameResult(inputFile,lines);
  }
}
