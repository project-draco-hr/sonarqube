{
  MultipartRequestHandler multipartHandler=null;
  String multipartClass=(String)request.getAttribute(Globals.MULTIPART_KEY);
  request.removeAttribute(Globals.MULTIPART_KEY);
  if (multipartClass != null) {
    try {
      multipartHandler=(MultipartRequestHandler)applicationInstance(multipartClass);
    }
 catch (    ClassNotFoundException cnfe) {
      log.error("MultipartRequestHandler class \"" + multipartClass + "\" in mapping class not found, "+ "defaulting to global multipart class");
    }
catch (    InstantiationException ie) {
      log.error("InstantiationException when instantiating " + "MultipartRequestHandler \"" + multipartClass + "\", "+ "defaulting to global multipart class, exception: "+ ie.getMessage());
    }
catch (    IllegalAccessException iae) {
      log.error("IllegalAccessException when instantiating " + "MultipartRequestHandler \"" + multipartClass + "\", "+ "defaulting to global multipart class, exception: "+ iae.getMessage());
    }
    if (multipartHandler != null) {
      return multipartHandler;
    }
  }
  ModuleConfig moduleConfig=ModuleUtils.getInstance().getModuleConfig(request);
  multipartClass=moduleConfig.getControllerConfig().getMultipartClass();
  if (multipartClass != null) {
    try {
      multipartHandler=(MultipartRequestHandler)applicationInstance(multipartClass);
    }
 catch (    ClassNotFoundException cnfe) {
      throw new ServletException("Cannot find multipart class \"" + multipartClass + "\""+ ", exception: "+ cnfe.getMessage());
    }
catch (    InstantiationException ie) {
      throw new ServletException("InstantiationException when instantiating " + "multipart class \"" + multipartClass + "\", exception: "+ ie.getMessage());
    }
catch (    IllegalAccessException iae) {
      throw new ServletException("IllegalAccessException when instantiating " + "multipart class \"" + multipartClass + "\", exception: "+ iae.getMessage());
    }
    if (multipartHandler != null) {
      return multipartHandler;
    }
  }
  return multipartHandler;
}
