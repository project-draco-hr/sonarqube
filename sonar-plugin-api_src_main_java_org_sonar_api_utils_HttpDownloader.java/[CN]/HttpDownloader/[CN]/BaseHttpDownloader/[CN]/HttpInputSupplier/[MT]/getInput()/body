{
  LoggerFactory.getLogger(getClass()).debug("Download: " + uri + " ("+ getProxySynthesis(uri,ProxySelector.getDefault())+ ")");
  HttpURLConnection connection=(HttpURLConnection)uri.toURL().openConnection();
  if (!Strings.isNullOrEmpty(login)) {
    String encoded=new String(Base64.encodeBase64((login + ":" + password).getBytes()));
    connection.setRequestProperty("Authorization","Basic " + encoded);
  }
  connection.setConnectTimeout(TIMEOUT_MILLISECONDS);
  connection.setReadTimeout(readTimeoutMillis);
  connection.setUseCaches(true);
  connection.setInstanceFollowRedirects(true);
  connection.setRequestProperty("User-Agent",userAgent);
  int responseCode=connection.getResponseCode();
  if (responseCode >= 400) {
    InputStream errorResponse=null;
    try {
      errorResponse=connection.getErrorStream();
      if (errorResponse != null) {
        String errorResponseContent=IOUtils.toString(errorResponse);
        throw new HttpException(uri,responseCode,errorResponseContent);
      }
 else {
        throw new HttpException(uri,responseCode);
      }
    }
  finally {
      IOUtils.closeQuietly(errorResponse);
    }
  }
  return connection.getInputStream();
}
