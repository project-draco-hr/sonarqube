{
  userSession.checkGlobalPermission(GlobalPermissions.PREVIEW_EXECUTION);
  final String moduleKey=request.mandatoryParam(PARAM_KEY);
  response.stream().setMediaType(MimeTypes.PROTOBUF);
  DbSession session=dbClient.openSession(false);
  try {
    ComponentDto component=dbClient.componentDao().selectByKey(session,moduleKey);
    Map<String,String> keysByUUid=keysByUUid(session,component);
    BatchInput.ServerIssue.Builder issueBuilder=BatchInput.ServerIssue.newBuilder();
    for (Iterator<IssueDoc> issueDocIterator=issueIndex.selectIssuesForBatch(component); issueDocIterator.hasNext(); ) {
      handleIssue(issueDocIterator.next(),issueBuilder,keysByUUid,response.stream().output());
    }
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
