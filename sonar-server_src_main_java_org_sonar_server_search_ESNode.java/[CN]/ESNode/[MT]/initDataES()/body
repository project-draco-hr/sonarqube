{
  initLogging();
  ImmutableSettings.Builder esSettings=ImmutableSettings.settingsBuilder().put("node.name","sonarqube-" + System.currentTimeMillis()).put("node.data",true).put("node.local",true).put("cluster.name","sonarqube").put("index.number_of_shards","1").put("index.number_of_replicas","0").put("index.mapper.dynamic",false).put("index.analysis.analyzer.sortable.type","custom").put("index.analysis.analyzer.sortable.tokenizer","keyword").putArray("index.analysis.analyzer.sortable.filter","trim","lowercase","truncate").put("index.analysis.analyzer.string_gram.type","custom").put("index.analysis.analyzer.string_gram.tokenizer","whitespace").putArray("index.analysis.analyzer.string_gram.filter","lowercase","code_gram").put("index.analysis.filter.code_gram.type","edgeNGram").put("index.analysis.filter.code_gram.min_gram",2).put("index.analysis.filter.code_gram.max_gram",15).putArray("index.analysis.filter.code_gram.token_chars","letter","digit","punctuation","symbol");
  initDirs(esSettings);
  initRestConsole(esSettings);
  initNetwork(esSettings);
  node=NodeBuilder.nodeBuilder().settings(esSettings).node();
  node.start();
  addIndexTemplates();
  if (node.client().admin().cluster().prepareHealth().setWaitForYellowStatus().setTimeout(healthTimeout).execute().actionGet().getStatus() == ClusterHealthStatus.RED) {
    throw new IllegalStateException(String.format("Elasticsearch index is corrupt, please delete directory '%s/%s' and relaunch the SonarQube server.",fileSystem.getHomeDir().getAbsolutePath(),DATA_DIR));
  }
  LOG.info("Elasticsearch started");
}
