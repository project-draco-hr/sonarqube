{
  List<UpdateRequest> requests=new ArrayList<>();
  DbSession session=db.openSession(false);
  try {
    Map<String,Object> update=new HashMap<>();
    update.put(RuleField.ID.field(),rule.getId());
    update.put(RuleField.KEY.field(),rule.getKey().toString());
    update.put(RuleField._KEY.field(),ImmutableList.of(rule.getKey().repository(),rule.getKey().rule()));
    update.put(RuleField.REPOSITORY.field(),rule.getRepositoryKey());
    update.put(RuleField.RULE_KEY.field(),rule.getRuleKey());
    update.put(RuleField.NAME.field(),rule.getName());
    update.put(RuleField.CREATED_AT.field(),rule.getCreatedAt());
    update.put(RuleField.UPDATED_AT.field(),rule.getUpdatedAt());
    if (RuleDto.Format.HTML.equals(rule.getDescriptionFormat())) {
      update.put(RuleField.HTML_DESCRIPTION.field(),rule.getDescription());
      update.put(RuleField.MARKDOWN_DESCRIPTION.field(),null);
    }
 else {
      update.put(RuleField.HTML_DESCRIPTION.field(),rule.getDescription() == null ? null : Markdown.convertToHtml(rule.getDescription()));
      update.put(RuleField.MARKDOWN_DESCRIPTION.field(),rule.getDescription());
    }
    update.put(RuleField.FIX_DESCRIPTION.field(),rule.getEffortToFixDescription());
    update.put(RuleField.SEVERITY.field(),rule.getSeverityString());
    RuleStatus status=rule.getStatus();
    update.put(RuleField.STATUS.field(),status != null ? rule.getStatus().name() : null);
    update.put(RuleField.LANGUAGE.field(),rule.getLanguage());
    update.put(RuleField.INTERNAL_KEY.field(),rule.getConfigKey());
    update.put(RuleField.IS_TEMPLATE.field(),rule.isTemplate());
    update.put(RuleField.NOTE.field(),rule.getNoteData());
    update.put(RuleField.NOTE_LOGIN.field(),rule.getNoteUserLogin());
    update.put(RuleField.NOTE_CREATED_AT.field(),rule.getNoteCreatedAt());
    update.put(RuleField.NOTE_UPDATED_AT.field(),rule.getNoteUpdatedAt());
    Integer templateId=rule.getTemplateId();
    String templateKeyFieldValue=null;
    if (templateId != null) {
      Optional<RuleDto> templateRule=db.ruleDao().selectById(templateId,session);
      if (templateRule.isPresent()) {
        RuleKey templateKey=templateRule.get().getKey();
        templateKeyFieldValue=templateKey != null ? templateKey.toString() : null;
      }
    }
    update.put(RuleField.TEMPLATE_KEY.field(),templateKeyFieldValue);
    if (rule.getDefaultRemediationFunction() != null) {
      update.put(RuleField.DEFAULT_DEBT_FUNCTION_TYPE.field(),rule.getDefaultRemediationFunction());
      update.put(RuleField.DEFAULT_DEBT_FUNCTION_COEFFICIENT.field(),rule.getDefaultRemediationCoefficient());
      update.put(RuleField.DEFAULT_DEBT_FUNCTION_OFFSET.field(),rule.getDefaultRemediationOffset());
    }
 else {
      update.put(RuleField.DEFAULT_DEBT_FUNCTION_TYPE.field(),null);
      update.put(RuleField.DEFAULT_DEBT_FUNCTION_COEFFICIENT.field(),null);
      update.put(RuleField.DEFAULT_DEBT_FUNCTION_OFFSET.field(),null);
    }
    if (rule.getRemediationFunction() != null) {
      update.put(RuleField.DEBT_FUNCTION_TYPE.field(),rule.getRemediationFunction());
      update.put(RuleField.DEBT_FUNCTION_COEFFICIENT.field(),rule.getRemediationCoefficient());
      update.put(RuleField.DEBT_FUNCTION_OFFSET.field(),rule.getRemediationOffset());
      update.put(RuleField.DEBT_FUNCTION_TYPE_OVERLOADED.field(),true);
    }
 else {
      update.put(RuleField.DEBT_FUNCTION_TYPE.field(),rule.getDefaultRemediationFunction());
      update.put(RuleField.DEBT_FUNCTION_COEFFICIENT.field(),rule.getDefaultRemediationCoefficient());
      update.put(RuleField.DEBT_FUNCTION_OFFSET.field(),rule.getDefaultRemediationOffset());
      update.put(RuleField.DEBT_FUNCTION_TYPE_OVERLOADED.field(),false);
    }
    update.put(RuleField.TAGS.field(),rule.getTags());
    update.put(RuleField.SYSTEM_TAGS.field(),rule.getSystemTags());
    update.put(RuleField.ALL_TAGS.field(),Sets.union(rule.getSystemTags(),rule.getTags()));
    Map<String,Object> upsert=getUpsertFor(RuleField.ALL_FIELDS,update);
    upsert.put(RuleField.KEY.field(),rule.getKey().toString());
    requests.add(new UpdateRequest().id(rule.getKey().toString()).doc(update).upsert(upsert));
    for (    RuleParamDto param : db.ruleDao().selectRuleParamsByRuleKey(session,rule.getKey())) {
      requests.addAll(normalizeNested(param,rule.getKey()));
    }
  }
  finally {
    session.close();
  }
  return requests;
}
