{
  execute(new FakeRepositoryV1());
  assertThat(dbClient.ruleDao().findAll(dbSession)).hasSize(2);
  when(system.now()).thenReturn(DATE2.getTime());
  execute(new FakeRepositoryV2());
  RuleKey ruleKey1=RuleKey.of("fake","rule1");
  RuleDto rule1=dbClient.ruleDao().getByKey(ruleKey1,dbSession);
  assertThat(rule1.getName()).isEqualTo("One v2");
  assertThat(rule1.getDescription()).isEqualTo("Description of One v2");
  assertThat(rule1.getSeverityString()).isEqualTo(Severity.INFO);
  assertThat(rule1.getTags()).isEmpty();
  assertThat(rule1.getSystemTags()).containsOnly("tag1","tag4");
  assertThat(rule1.getConfigKey()).isEqualTo("config1 v2");
  assertThat(rule1.getStatus()).isEqualTo(RuleStatus.READY.toString());
  assertThat(rule1.getCreatedAt()).isEqualTo(DATE1);
  assertThat(rule1.getUpdatedAt()).isEqualTo(DATE2);
  assertThat(rule1.getEffortToFixDescription()).isEqualTo("squid.S115.effortToFix.v2");
  List<RuleParamDto> params=dbClient.ruleDao().findRuleParamsByRuleKey(ruleKey1,dbSession);
  assertThat(params).hasSize(2);
  RuleParamDto param=getParam(params,"param1");
  assertThat(param.getDescription()).isEqualTo("parameter one v2");
  assertThat(param.getDefaultValue()).isEqualTo("default1 v2");
  RuleDto rule2=dbClient.ruleDao().getByKey(RuleKey.of("fake","rule2"),dbSession);
  assertThat(rule2.getStatus()).isEqualTo(RuleStatus.REMOVED.toString());
  assertThat(rule2.getUpdatedAt()).isEqualTo(DATE2);
  RuleDto rule3=dbClient.ruleDao().getByKey(RuleKey.of("fake","rule3"),dbSession);
  assertThat(rule3).isNotNull();
}
