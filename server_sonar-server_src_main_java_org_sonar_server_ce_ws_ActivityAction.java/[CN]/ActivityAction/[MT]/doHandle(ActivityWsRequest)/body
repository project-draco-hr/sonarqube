{
  DbSession dbSession=dbClient.openSession(false);
  try {
    Optional<WsCe.Task> taskSearchedById=searchTaskByUuid(dbSession,request);
    if (taskSearchedById.isPresent()) {
      return buildResponse(singletonList(taskSearchedById.get()),Collections.<WsCe.Task>emptyList(),request.getPageSize());
    }
    CeTaskQuery query=buildQuery(dbSession,request);
    checkPermissions(query);
    Iterable<WsCe.Task> queuedTasks=loadQueuedTasks(dbSession,request,query);
    Iterable<WsCe.Task> pastTasks=loadPastTasks(dbSession,request,query);
    return buildResponse(queuedTasks,pastTasks,request.getPageSize());
  }
  finally {
    dbClient.closeSession(dbSession);
  }
}
