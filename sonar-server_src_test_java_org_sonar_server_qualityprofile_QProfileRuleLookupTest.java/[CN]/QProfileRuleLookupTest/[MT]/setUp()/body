{
  esSetup=new EsSetup(ImmutableSettings.builder().loadFromUrl(ESNode.class.getResource("config/elasticsearch.json")).build());
  esSetup.execute(EsSetup.deleteAll());
  ESNode searchNode=mock(ESNode.class);
  when(searchNode.client()).thenReturn(esSetup.client());
  Settings settings=new Settings();
  settings.setProperty("sonar.log.profilingLevel","FULL");
  ESIndex index=new ESIndex(searchNode,new Profiling(settings));
  index.start();
  RuleRegistry registry=new RuleRegistry(index,null);
  registry.start();
  ESActiveRule esActiveRule=new ESActiveRule(index,null,null);
  esActiveRule.start();
  profileRules=new QProfileRuleLookup(index);
  esSetup.client().prepareBulk().add(Requests.indexRequest().index("rules").type("rule").source(testFileAsString("shared/rule25.json"))).add(Requests.indexRequest().index("rules").type("active_rule").parent("25").source(testFileAsString("shared/active_rule25.json"))).add(Requests.indexRequest().index("rules").type("rule").source(testFileAsString("shared/rule759.json"))).add(Requests.indexRequest().index("rules").type("active_rule").parent("759").source(testFileAsString("shared/active_rule391.json"))).add(Requests.indexRequest().index("rules").type("active_rule").parent("759").source(testFileAsString("shared/active_rule523.json"))).add(Requests.indexRequest().index("rules").type("rule").source(testFileAsString("shared/rule1482.json"))).add(Requests.indexRequest().index("rules").type("active_rule").parent("1482").source(testFileAsString("shared/active_rule2702.json"))).add(Requests.indexRequest().index("rules").type("rule").source(testFileAsString("shared/rule944.json"))).add(Requests.indexRequest().index("rules").type("rule").source(testFileAsString("shared/rule719.json"))).add(Requests.indexRequest().index("rules").type("rule").source(testFileAsString("shared/rule860.json"))).setRefresh(true).execute().actionGet();
}
