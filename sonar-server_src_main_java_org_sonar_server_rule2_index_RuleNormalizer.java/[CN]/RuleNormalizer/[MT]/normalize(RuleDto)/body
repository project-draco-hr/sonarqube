{
  try {
    XContentBuilder document=jsonBuilder().startObject();
    indexField(RuleField.KEY.key(),rule.getRuleKey(),document);
    indexField(RuleField.REPOSITORY.key(),rule.getRepositoryKey(),document);
    indexField(RuleField.NAME.key(),rule.getName(),document);
    indexField(RuleField.CREATED_AT.key(),rule.getCreatedAt(),document);
    indexField(RuleField.UPDATED_AT.key(),rule.getUpdatedAt(),document);
    indexField(RuleField.HTML_DESCRIPTION.key(),rule.getDescription(),document);
    indexField(RuleField.SEVERITY.key(),rule.getSeverityString(),document);
    indexField(RuleField.STATUS.key(),rule.getStatus(),document);
    indexField(RuleField.LANGUAGE.key(),rule.getLanguage(),document);
    indexField(RuleField.INTERNAL_KEY.key(),rule.getConfigKey(),document);
    indexField(RuleField.TEMPLATE.key(),rule.getCardinality() == Cardinality.MULTIPLE,document);
    String subChar=null;
    if (rule.getDefaultSubCharacteristicId() != null) {
      subChar=rule.getDefaultSubCharacteristicId().toString();
    }
    if (rule.getSubCharacteristicId() != null) {
      subChar=rule.getSubCharacteristicId().toString();
    }
    indexField(RuleField.SUB_CHARACTERISTIC.key(),subChar,document);
    String dType=null, dCoefficient=null, dOffset=null;
    if (rule.getDefaultRemediationFunction() != null) {
      dType=rule.getDefaultRemediationFunction();
      dCoefficient=rule.getDefaultRemediationCoefficient();
      dOffset=rule.getDefaultRemediationOffset();
    }
    if (rule.getRemediationFunction() != null) {
      dType=rule.getRemediationFunction();
      dCoefficient=rule.getRemediationCoefficient();
      dOffset=rule.getRemediationOffset();
    }
    indexField(RuleField.DEBT_FUNCTION_TYPE.key(),dType,document);
    indexField(RuleField.DEBT_FUNCTION_COEFFICIENT.key(),dCoefficient,document);
    indexField(RuleField.DEBT_FUNCTION_OFFSET.key(),dOffset,document);
    document.array(RuleField.TAGS.key(),rule.getTags().toArray(new String[rule.getTags().size()]));
    document.array(RuleField.SYSTEM_TAGS.key(),rule.getSystemTags().toArray(new String[rule.getSystemTags().size()]));
    document.startObject(RuleField.PARAMS.key()).endObject();
    document.startObject(RuleField.ACTIVE.key()).endObject();
    document.endObject();
    UpdateRequest request=new UpdateRequest().doc(document);
    request.docAsUpsert(true);
    return request;
  }
 catch (  Exception e) {
    throw new IllegalStateException(String.format("Could not normalize RuleDto with key %s",rule.getKey().toString()),e);
  }
}
