{
  if (!settings.getBoolean(CoreProperties.SCM_ENABLED_KEY)) {
    LOG.debug("SCM Step is disabled by configuration");
    return;
  }
  if (settings.hasKey(CoreProperties.SCM_PROVIDER_KEY)) {
    String forcedProviderKey=settings.getString(CoreProperties.SCM_PROVIDER_KEY);
    if (providerPerKey.containsKey(forcedProviderKey)) {
      this.provider=providerPerKey.get(forcedProviderKey);
    }
 else {
      throw new IllegalArgumentException("SCM provider was set to \"" + forcedProviderKey + "\" but no provider found for this key. Supported providers are "+ Joiner.on(",").join(providerPerKey.keySet()));
    }
  }
 else {
    for (    ScmProvider provider : providerPerKey.values()) {
      if (provider.supports(projectReactor.getRoot().getBaseDir())) {
        if (this.provider == null) {
          this.provider=provider;
        }
 else {
          throw new IllegalStateException("SCM provider autodetection failed. Both " + this.provider.key() + " and "+ provider.key()+ " claim to support this project. Please use "+ CoreProperties.SCM_PROVIDER_KEY+ " to define SCM of your project.");
        }
      }
    }
    if (this.provider == null) {
      LOG.warn("SCM provider autodetection failed. No SCM provider claims to support this project. Please use " + CoreProperties.SCM_PROVIDER_KEY + " to define SCM of your project.");
    }
  }
}
