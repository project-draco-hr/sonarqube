{
  Loggers.get(getClass()).debug("Download: " + uri + " ("+ getProxySynthesis(uri,ProxySelector.getDefault())+ ")");
  HttpURLConnection connection=(HttpURLConnection)uri.toURL().openConnection();
  connection.setRequestMethod(requestMethod);
  HttpsTrust.INSTANCE.trust(connection);
  connection.setRequestProperty("Accept-Encoding","gzip");
  if (!Strings.isNullOrEmpty(login)) {
    String encoded=Base64.encodeBase64String((login + ":" + password).getBytes(StandardCharsets.UTF_8));
    connection.setRequestProperty("Authorization","Basic " + encoded);
  }
  connection.setConnectTimeout(connectTimeoutMillis);
  connection.setReadTimeout(readTimeoutMillis);
  connection.setUseCaches(true);
  connection.setInstanceFollowRedirects(true);
  connection.setRequestProperty("User-Agent",userAgent);
  connection.connect();
  String encoding=connection.getContentEncoding();
  int responseCode=connection.getResponseCode();
  if (responseCode >= 400) {
    InputStream errorResponse=null;
    try {
      errorResponse=connection.getErrorStream();
      if (errorResponse != null) {
        String errorResponseContent=IOUtils.toString(errorResponse);
        throw new HttpException(uri,responseCode,errorResponseContent);
      }
      throw new HttpException(uri,responseCode);
    }
  finally {
      IOUtils.closeQuietly(errorResponse);
    }
  }
  InputStream resultingInputStream;
  if (encoding != null && "gzip".equalsIgnoreCase(encoding)) {
    resultingInputStream=new GZIPInputStream(connection.getInputStream());
  }
 else {
    resultingInputStream=connection.getInputStream();
  }
  return resultingInputStream;
}
