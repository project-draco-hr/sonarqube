{
  Rules rules=new Rules(){
    @Override public void init(    RulesDefinition.NewRepository repository){
      repository.createRule("x1").setName("x1 name").setHtmlDescription("x1 desc");
    }
  }
;
  register(rules);
  MockUserSession.set().setGlobalPermissions(GlobalPermissions.QUALITY_PROFILE_ADMIN).setLogin("me");
  db.qualityProfileDao().insert(dbSession,QProfileTesting.newXooP1());
  dbSession.commit();
  dbSession.clearCache();
  RuleActivation activation=new RuleActivation(RuleTesting.XOO_X1);
  TESTER.get(QProfileService.class).activate(QProfileTesting.XOO_P1_KEY,activation);
  register(null);
  assertThat(db.ruleDao().getByKey(dbSession,RuleTesting.XOO_X1).getStatus()).isEqualTo(RuleStatus.REMOVED);
  assertThat(db.activeRuleDao().findByProfileKey(dbSession,QProfileTesting.XOO_P1_KEY)).hasSize(1);
  register(rules);
  assertThat(db.ruleDao().getByKey(dbSession,RuleTesting.XOO_X1).getStatus()).isEqualTo(RuleStatus.READY);
  assertThat(db.activeRuleDao().findByProfileKey(dbSession,QProfileTesting.XOO_P1_KEY)).hasSize(1);
}
