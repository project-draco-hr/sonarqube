{
  List<RuleDto> registeredRules=newArrayList();
  Map<String,Rule> ruleByKey=newHashMap();
  for (  Rule rule : repository.createRules()) {
    updateRuleFromRepositoryInfo(rule,repository);
    validateRule(rule,repository.getKey());
    ruleByKey.put(rule.getKey(),rule);
    registeredRules.add(dtoFrom(rule));
  }
  LOG.debug(ruleByKey.size() + " rules");
  for (  RuleDto persistedRule : existingRules.get(repository.getKey())) {
    Rule rule=ruleByKey.get(persistedRule.getRuleKey());
    if (rule != null) {
      registeredRules.remove(dtoFrom(rule));
      updateExistingRule(persistedRule,existingRules.params(persistedRule.getId()),existingRules.tags(persistedRule.getId()),rule);
      ruleDao.update(persistedRule,sqlSession);
      registeredRules.add(persistedRule);
      ruleByKey.remove(rule.getKey());
    }
  }
  saveNewRules(ruleByKey.values());
  return registeredRules;
}
