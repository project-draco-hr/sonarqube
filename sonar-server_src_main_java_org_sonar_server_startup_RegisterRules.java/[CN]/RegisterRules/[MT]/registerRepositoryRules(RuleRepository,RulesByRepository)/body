{
  List<RuleDto> registeredRules=newArrayList();
  Map<String,Rule> ruleByKey=newHashMap();
  for (  Rule rule : repository.createRules()) {
    updateRuleFromRepositoryInfo(rule,repository);
    validateRule(rule,repository.getKey());
    ruleByKey.put(rule.getKey(),rule);
  }
  LOG.debug(ruleByKey.size() + " rules");
  for (  RuleDto persistedRule : existingRules.get(repository.getKey())) {
    Rule rule=ruleByKey.get(persistedRule.getRuleKey());
    if (rule != null) {
      updateExistingRule(persistedRule,existingRules,rule);
      ruleDao.update(persistedRule,sqlSession);
      registeredRules.add(persistedRule);
      ruleByKey.remove(rule.getKey());
    }
  }
  registeredRules.addAll(saveNewRules(ruleByKey.values(),existingRules));
  return registeredRules;
}
