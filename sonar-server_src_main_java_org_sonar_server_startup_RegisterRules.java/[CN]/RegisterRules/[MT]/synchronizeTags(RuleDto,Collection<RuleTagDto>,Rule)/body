{
  Set<String> existingSystemTags=Sets.newHashSet();
  for (  RuleTagDto existingTag : persistedTags) {
    String existingTagValue=existingTag.getTag();
    if (existingTag.getType() == RuleTagType.SYSTEM) {
      existingSystemTags.add(existingTagValue);
      if (!rule.getTags().contains(existingTagValue)) {
        ruleDao.deleteTag(existingTag,sqlSession);
      }
    }
 else {
      if (rule.getTags().contains(existingTagValue)) {
        ruleDao.deleteTag(existingTag,sqlSession);
        existingSystemTags.add(existingTagValue);
        ruleDao.insert(dtoFrom(existingTagValue,persistedRule.getId()),sqlSession);
      }
    }
  }
  for (  String newTag : rule.getTags()) {
    if (!existingSystemTags.contains(newTag)) {
      ruleDao.insert(dtoFrom(newTag,persistedRule.getId()),sqlSession);
    }
  }
}
