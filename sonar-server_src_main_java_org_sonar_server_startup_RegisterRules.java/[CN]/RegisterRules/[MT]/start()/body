{
  sqlSession=myBatis.openSession();
  RulesByRepository existingRules=new RulesByRepository(findAllRules(),ruleDao.selectParameters(sqlSession),ruleDao.selectTags(sqlSession));
  try {
    List<RuleDto> registeredRules=registerRules(existingRules);
    LOG.info("Removing deprecated rules");
    disableDeprecatedRules(existingRules,registeredRules);
    disableDeprecatedRepositories(existingRules);
    sqlSession.commit();
    ruleRegistry.bulkRegisterRules();
  }
  finally {
    sqlSession.close();
  }
}
