{
  sqlSession=myBatis.openSession();
  RulesByRepository existingRules=new RulesByRepository(findAllRules(),ruleDao.selectParameters(sqlSession),ruleDao.selectTags(sqlSession));
  try {
    List<RuleDto> registeredRules=registerRules(existingRules);
    LOG.info("Removing deprecated rules");
    Set<RuleDto> disabledRules=newHashSet();
    disabledRules.addAll(disableDeprecatedRules(existingRules,registeredRules));
    disabledRules.addAll(disableDeprecatedRepositories(existingRules));
    sqlSession.commit();
    removeActiveRulesOnDisabledRules(disabledRules);
    ruleRegistry.bulkRegisterRules();
  }
  finally {
    sqlSession.close();
  }
}
