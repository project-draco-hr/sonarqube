{
  RuleDto dto=new RuleDto().setId(1).setRepositoryKey("squid").setRuleKey("UselessImportCheck").setSubCharacteristicId(6).setRemediationFunction("CONSTANT_ISSUE").setRemediationOffset("10min");
  RuleKey ruleKey=RuleKey.of("squid","UselessImportCheck");
  when(ruleDao.selectByKey(ruleKey,session)).thenReturn(dto);
  CharacteristicDto subCharacteristic=new CharacteristicDto().setId(2).setKey("COMPILER").setName("Compiler").setParentId(1);
  when(characteristicDao.selectByKey("COMPILER",session)).thenReturn(subCharacteristic);
  when(characteristicDao.selectById(2,session)).thenReturn(subCharacteristic);
  CharacteristicDto characteristic=new CharacteristicDto().setId(1).setKey("PORTABILITY").setName("Portability").setOrder(2);
  when(characteristicDao.selectById(1,session)).thenReturn(characteristic);
  operations.updateRule(new RuleChange().setRuleKey(ruleKey).setDebtCharacteristicKey("COMPILER").setDebtRemediationFunction("LINEAR_OFFSET").setDebtRemediationCoefficient("2h").setDebtRemediationOffset("20min"),authorizedUserSession);
  verify(ruleDao).update(ruleCaptor.capture(),eq(session));
  RuleDto result=ruleCaptor.getValue();
  assertThat(result.getId()).isEqualTo(1);
  assertThat(result.getSubCharacteristicId()).isEqualTo(2);
  assertThat(result.getRemediationFunction()).isEqualTo("LINEAR_OFFSET");
  assertThat(result.getRemediationCoefficient()).isEqualTo("2h");
  assertThat(result.getRemediationOffset()).isEqualTo("20min");
  assertThat(result.getUpdatedAt()).isEqualTo(now);
  verify(session).commit();
  verify(ruleRegistry).save(eq(result),eq(characteristic),eq(subCharacteristic),anyListOf(RuleParamDto.class),anyListOf(RuleRuleTagDto.class));
}
