{
  try (DbSession session=mybatis.openSession(false)){
    final Map<String,FileSourceDto> previousDtosByUuid=new HashMap<>();
    session.select("org.sonar.core.source.db.FileSourceMapper.selectHashesForProject",projectTree.getRootProject().getUuid(),new ResultHandler(){
      @Override public void handleResult(      ResultContext context){
        FileSourceDto dto=(FileSourceDto)context.getResultObject();
        previousDtosByUuid.put(dto.getFileUuid(),dto);
      }
    }
);
    FileSourceMapper mapper=session.getMapper(FileSourceMapper.class);
    for (    InputPath inputPath : inputPathCache.all()) {
      if (inputPath instanceof DefaultInputFile) {
        persist(session,mapper,(DefaultInputFile)inputPath,previousDtosByUuid);
      }
    }
  }
 catch (  Exception e) {
    throw new IllegalStateException("Unable to save file sources",e);
  }
}
