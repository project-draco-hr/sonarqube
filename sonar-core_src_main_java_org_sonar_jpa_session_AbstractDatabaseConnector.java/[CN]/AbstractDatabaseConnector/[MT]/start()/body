{
  if (!started) {
    transactionIsolation=configuration.getInteger(DatabaseProperties.PROP_ISOLATION,null);
    String jdbcConnectionUrl=testConnection();
    dialect=DialectRepository.find(configuration.getString("sonar.jdbc.dialect"),jdbcConnectionUrl);
    LoggerFactory.getLogger("org.sonar.INFO").info("Database dialect class " + dialect.getClass().getName());
    started=true;
  }
  if (!operational) {
    boolean upToDate=upToDateSchemaVersion();
    if (!upToDate && startsFailIfSchemaOutdated) {
      throw new DatabaseException(databaseVersion,SchemaMigration.LAST_VERSION);
    }
    if (upToDate) {
      factory=createEntityManagerFactory();
      operational=true;
    }
  }
}
