{
  sql.append("SELECT block.id, max(block.rid) AS rid, max(block.rootid) AS rootid, max(sortval) AS sortvalmax, CASE WHEN sortval IS NULL THEN 1 ELSE 0 END AS sortflag ");
  for (int index=0; index < filter.getMeasureConditions().size(); index++) {
    sql.append(", max(crit_").append(index).append(")");
  }
  sql.append(" FROM (");
  appendSortBlock();
  for (int index=0; index < filter.getMeasureConditions().size(); index++) {
    MeasureFilterCondition condition=filter.getMeasureConditions().get(index);
    sql.append(" UNION ");
    appendConditionBlock(index,condition);
  }
  sql.append(") block GROUP BY block.id, sortflag");
  if (!filter.getMeasureConditions().isEmpty()) {
    sql.append(" HAVING ");
    for (int index=0; index < filter.getMeasureConditions().size(); index++) {
      if (index > 0) {
        sql.append(" AND ");
      }
      sql.append(" max(crit_").append(index).append(") IS NOT NULL ");
    }
  }
  if (filter.sort().isSortedByDatabase()) {
    sql.append(" ORDER BY sortflag ASC, sortvalmax ");
    sql.append(filter.sort().isAsc() ? "ASC " : "DESC ");
  }
}
