{
  sql.append(" s.status='P' AND s.islast=").append(database.getDialect().getTrueSqlValue());
  sql.append(" AND p.copy_resource_id IS NULL ");
  if (!filter.resourceQualifiers().isEmpty()) {
    sql.append(" AND s.qualifier IN ");
    appendInStatement(filter.resourceQualifiers(),sql);
  }
  if (!filter.resourceScopes().isEmpty()) {
    sql.append(" AND s.scope IN ");
    appendInStatement(filter.resourceScopes(),sql);
  }
  if (!filter.resourceLanguages().isEmpty()) {
    sql.append(" AND p.language IN ");
    appendInStatement(filter.resourceLanguages(),sql);
  }
  if (filter.fromDate() != null) {
    sql.append(" AND s.created_at >= ? ");
    dateParameters.add(new java.sql.Date(filter.fromDate().getTime()));
  }
  if (filter.toDate() != null) {
    sql.append(" AND s.created_at <= ? ");
    dateParameters.add(new java.sql.Date(filter.toDate().getTime()));
  }
  if (filter.userFavourites() && context.getUserId() != null) {
    sql.append(" AND s.project_id IN (SELECT props.resource_id FROM properties props WHERE props.prop_key='favourite' AND props.user_id=");
    sql.append(context.getUserId());
    sql.append(" AND props.resource_id IS NOT NULL) ");
  }
  if (StringUtils.isNotBlank(filter.resourceName())) {
    sql.append(" AND s.project_id IN (SELECT rindex.resource_id FROM resource_index rindex WHERE rindex.kee like '");
    sql.append(StringEscapeUtils.escapeSql(StringUtils.lowerCase(filter.resourceName())));
    sql.append("%'");
    if (!filter.resourceQualifiers().isEmpty()) {
      sql.append(" AND rindex.qualifier IN ");
      appendInStatement(filter.resourceQualifiers(),sql);
    }
    sql.append(") ");
  }
  SnapshotDto baseSnapshot=context.getBaseSnapshot();
  if (baseSnapshot != null) {
    if (filter.isOnBaseResourceChildren()) {
      sql.append(" AND s.parent_snapshot_id=").append(baseSnapshot.getId());
    }
 else {
      Long rootSnapshotId=(baseSnapshot.getRootId() != null ? baseSnapshot.getRootId() : baseSnapshot.getId());
      sql.append(" AND s.root_snapshot_id=").append(rootSnapshotId);
      sql.append(" AND s.path LIKE '").append(baseSnapshot.getPath()).append(baseSnapshot.getId()).append(".%'");
    }
  }
}
