{
  sql.append(" s.status='P' AND s.islast=").append(database.getDialect().getTrueSqlValue());
  if (context.getBaseSnapshot() == null) {
    sql.append(" AND p.copy_resource_id IS NULL ");
  }
  if (!filter.getResourceQualifiers().isEmpty()) {
    sql.append(" AND s.qualifier IN ");
    appendInStatement(filter.getResourceQualifiers(),sql);
  }
  if (!filter.getResourceScopes().isEmpty()) {
    sql.append(" AND s.scope IN ");
    appendInStatement(filter.getResourceScopes(),sql);
  }
  if (!filter.getResourceLanguages().isEmpty()) {
    sql.append(" AND p.language IN ");
    appendInStatement(filter.getResourceLanguages(),sql);
  }
  if (filter.getFromDate() != null) {
    sql.append(" AND s.created_at >= ? ");
    dateParameters.add(new java.sql.Date(filter.getFromDate().getTime()));
  }
  if (filter.getToDate() != null) {
    sql.append(" AND s.created_at <= ? ");
    dateParameters.add(new java.sql.Date(filter.getToDate().getTime()));
  }
  if (filter.isOnFavourites()) {
    sql.append(" AND props.prop_key='favourite' AND props.resource_id IS NOT NULL AND props.user_id=");
    sql.append(context.getUserId());
    sql.append(" ");
  }
  if (StringUtils.isNotBlank(filter.getResourceName())) {
    sql.append(" AND s.project_id IN (SELECT rindex.resource_id FROM resource_index rindex WHERE rindex.kee like '");
    sql.append(StringEscapeUtils.escapeSql(StringUtils.lowerCase(filter.getResourceName())));
    sql.append("%'");
    if (!filter.getResourceQualifiers().isEmpty()) {
      sql.append(" AND rindex.qualifier IN ");
      appendInStatement(filter.getResourceQualifiers(),sql);
    }
    sql.append(") ");
  }
  if (StringUtils.isNotBlank(filter.getResourceKeyRegexp())) {
    sql.append(" AND UPPER(p.kee) LIKE '");
    String regexp=StringEscapeUtils.escapeSql(filter.getResourceKeyRegexp());
    regexp=StringUtils.replaceChars(regexp,'*','%');
    regexp=StringUtils.replaceChars(regexp,'?','_');
    sql.append(StringUtils.upperCase(regexp)).append("'");
  }
  SnapshotDto baseSnapshot=context.getBaseSnapshot();
  if (baseSnapshot != null) {
    if (filter.isOnBaseResourceChildren()) {
      sql.append(" AND s.parent_snapshot_id=").append(baseSnapshot.getId());
    }
 else {
      Long rootSnapshotId=(baseSnapshot.getRootId() != null ? baseSnapshot.getRootId() : baseSnapshot.getId());
      sql.append(" AND s.root_snapshot_id=").append(rootSnapshotId);
      sql.append(" AND s.path LIKE '").append(StringUtils.defaultString(baseSnapshot.getPath())).append(baseSnapshot.getId()).append(".%'");
    }
  }
}
