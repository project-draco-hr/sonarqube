{
  for (  ProfilePrototype prototype : prototypes) {
    TimeProfiler profiler=new TimeProfiler().start("Save profile " + prototype);
    RulesProfile profile=findOrCreate(prototype,session);
    for (    ProfilePrototype.RulePrototype rulePrototype : prototype.getRules()) {
      Rule rule=findRule(rulePrototype);
      if (rule == null) {
        LOGGER.warn("The profile " + prototype + " defines an unknown rule: "+ rulePrototype);
      }
 else {
        ActiveRule activeRule=profile.activateRule(rule,rulePrototype.getPriority());
        for (        Map.Entry<String,String> entry : rulePrototype.getParameters().entrySet()) {
          activeRule.setParameter(entry.getKey(),entry.getValue());
        }
      }
    }
    session.saveWithoutFlush(profile);
    session.commit();
    profiler.stop();
  }
}
