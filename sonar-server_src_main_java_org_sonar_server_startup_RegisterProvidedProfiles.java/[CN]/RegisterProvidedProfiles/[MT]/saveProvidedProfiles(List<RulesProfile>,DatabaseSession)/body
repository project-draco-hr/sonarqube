{
  Collection<String> languagesWithDefaultProfile=findLanguagesWithDefaultProfile(session);
  for (  RulesProfile profile : profiles) {
    TimeProfiler profiler=new TimeProfiler().start("Save profile " + profile);
    RulesProfile persistedProfile=findOrCreate(profile,session,languagesWithDefaultProfile.contains(profile.getLanguage()));
    for (    ActiveRule activeRule : profile.getActiveRules()) {
      Rule rule=getPersistedRule(activeRule);
      ActiveRule persistedRule=persistedProfile.activateRule(rule,activeRule.getSeverity());
      for (      RuleParam param : rule.getParams()) {
        String value=StringUtils.defaultString(activeRule.getParameter(param.getKey()),param.getDefaultValue());
        if (value != null) {
          persistedRule.setParameter(param.getKey(),value);
        }
      }
    }
    session.saveWithoutFlush(persistedProfile);
    profiler.stop();
  }
}
