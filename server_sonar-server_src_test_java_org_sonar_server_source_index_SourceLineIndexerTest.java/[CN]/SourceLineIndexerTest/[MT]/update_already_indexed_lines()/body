{
  es.client().prepareIndex(SourceLineIndexDefinition.INDEX,SourceLineIndexDefinition.TYPE).setSource(IOUtils.toString(new FileInputStream(TestUtils.getResource(this.getClass(),"line2.json")))).get();
  es.client().prepareIndex(SourceLineIndexDefinition.INDEX,SourceLineIndexDefinition.TYPE).setSource(IOUtils.toString(new FileInputStream(TestUtils.getResource(this.getClass(),"line2_other_file.json")))).setRefresh(true).get();
  List<Integer> duplications=ImmutableList.of(1,2,3);
  SourceLineDoc line1=new SourceLineDoc(ImmutableMap.<String,Object>builder().put(SourceLineIndexDefinition.FIELD_PROJECT_UUID,"abcd").put(SourceLineIndexDefinition.FIELD_FILE_UUID,"efgh").put(SourceLineIndexDefinition.FIELD_LINE,1).put(SourceLineIndexDefinition.FIELD_SCM_REVISION,"cafebabe").put(SourceLineIndexDefinition.FIELD_SCM_DATE,DateUtils.parseDateTime("2014-01-01T12:34:56+0100")).put(SourceLineIndexDefinition.FIELD_SCM_AUTHOR,"polop").put(SourceLineIndexDefinition.FIELD_SOURCE,"package org.sonar.server.source;").put(SourceLineIndexDefinition.FIELD_DUPLICATIONS,duplications).put(BaseNormalizer.UPDATED_AT_FIELD,new Date()).build());
  SourceLineResultSetIterator.SourceFile file=new SourceLineResultSetIterator.SourceFile("efgh",System.currentTimeMillis());
  file.addLine(line1);
  indexer.index(Iterators.singletonIterator(file));
  assertThat(countDocuments()).isEqualTo(2L);
  SearchResponse fileSearch=es.client().prepareSearch(SourceLineIndexDefinition.INDEX).setTypes(SourceLineIndexDefinition.TYPE).setQuery(QueryBuilders.termQuery(SourceLineIndexDefinition.FIELD_FILE_UUID,"efgh")).get();
  assertThat(fileSearch.getHits().getTotalHits()).isEqualTo(1L);
  Map<String,Object> fields=fileSearch.getHits().getHits()[0].sourceAsMap();
  assertThat(fields).hasSize(9);
  assertThat(fields).includes(MapAssert.entry(SourceLineIndexDefinition.FIELD_PROJECT_UUID,"abcd"),MapAssert.entry(SourceLineIndexDefinition.FIELD_FILE_UUID,"efgh"),MapAssert.entry(SourceLineIndexDefinition.FIELD_LINE,1),MapAssert.entry(SourceLineIndexDefinition.FIELD_SCM_REVISION,"cafebabe"),MapAssert.entry(SourceLineIndexDefinition.FIELD_SCM_DATE,"2014-01-01T11:34:56.000Z"),MapAssert.entry(SourceLineIndexDefinition.FIELD_SCM_AUTHOR,"polop"),MapAssert.entry(SourceLineIndexDefinition.FIELD_SOURCE,"package org.sonar.server.source;"),MapAssert.entry(SourceLineIndexDefinition.FIELD_DUPLICATIONS,duplications));
}
