{
  checkPermission();
  SqlSession session=mybatis.openSession();
  try {
    DebtModel debtModel=new DebtModel();
    List<CharacteristicDto> characteristicDtos=dao.selectEnabledCharacteristics(session);
    for (    CharacteristicDto characteristicDto : characteristicDtos) {
      if (characteristicDto.getParentId() == null) {
        debtModel.addRootCharacteristic(toDebtCharacteristic(characteristicDto));
        for (        CharacteristicDto sub : subCharacteristics(characteristicDto.getId(),characteristicDtos)) {
          debtModel.addSubCharacteristic(toDebtCharacteristic(sub),characteristicDto.getKey());
        }
      }
    }
    List<RuleDebt> rules=newArrayList();
    for (    RuleDto rule : ruleDao.selectEnablesAndNonManual(session)) {
      if ((languageKey == null || languageKey.equals(rule.getLanguage()))) {
        Integer effectiveCharacteristicId=rule.getCharacteristicId() != null ? rule.getCharacteristicId() : rule.getDefaultCharacteristicId();
        if (effectiveCharacteristicId != null && !RuleDto.DISABLED_CHARACTERISTIC_ID.equals(effectiveCharacteristicId)) {
          rules.add(toRuleDebt(rule,debtModel.characteristicById(effectiveCharacteristicId).key()));
        }
      }
    }
    return debtModelXMLExporter.export(debtModel,rules);
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
