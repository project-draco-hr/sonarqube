{
  checkPermission();
  SqlSession session=mybatis.openSession();
  try {
    DebtModel debtModel=new DebtModel();
    List<CharacteristicDto> characteristicDtos=dao.selectEnabledCharacteristics(session);
    for (    CharacteristicDto characteristicDto : characteristicDtos) {
      if (characteristicDto.getParentId() == null) {
        debtModel.addRootCharacteristic(toDebtCharacteristic(characteristicDto));
        for (        CharacteristicDto sub : subCharacteristics(characteristicDto.getId(),characteristicDtos)) {
          debtModel.addSubCharacteristic(toDebtCharacteristic(sub),characteristicDto.getKey());
        }
      }
    }
    List<RuleDebt> rules=newArrayList();
    for (    RuleDto rule : ruleDao.selectEnablesAndNonManual(session)) {
      if (languageKey == null || languageKey.equals(rule.getLanguage())) {
        Integer effectiveSubCharacteristicId=rule.getSubCharacteristicId() != null ? rule.getSubCharacteristicId() : rule.getDefaultSubCharacteristicId();
        String effectiveFunction=rule.getRemediationFunction() != null ? rule.getRemediationFunction() : rule.getDefaultRemediationFunction();
        if (!RuleDto.DISABLED_CHARACTERISTIC_ID.equals(effectiveSubCharacteristicId) && effectiveSubCharacteristicId != null && effectiveFunction != null) {
          rules.add(toRuleDebt(rule,debtModel.characteristicById(effectiveSubCharacteristicId).key(),effectiveFunction));
        }
      }
    }
    return debtModelXMLExporter.export(debtModel,rules);
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
