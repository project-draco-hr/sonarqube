{
  Event snapshotEvent1=mockVersionEvent("1.5-SNAPSHOT");
  Event releaseEvent2=mockVersionEvent("1.4");
  Event snapshotEvent2=mockVersionEvent("1.3-SNAPSHOT");
  VersionEventsSensor sensor=new VersionEventsSensor();
  SensorContext context=mock(SensorContext.class);
  Project project=mock(Project.class);
  when(project.getAnalysisVersion()).thenReturn("1.4");
  when(context.getEvents(project)).thenReturn(Lists.newArrayList(snapshotEvent1,releaseEvent2,snapshotEvent2));
  thrown.expect(IllegalStateException.class);
  thrown.expectMessage("A Sonar analysis can't delete a released version that already exists in the project history (version 1.4). " + "Please change the version of the project or clean its history first.");
  sensor.analyse(project,context);
}
