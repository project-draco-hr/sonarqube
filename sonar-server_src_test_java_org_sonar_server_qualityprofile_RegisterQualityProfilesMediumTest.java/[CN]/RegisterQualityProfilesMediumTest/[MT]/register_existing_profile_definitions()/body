{
  tester=new ServerTester().addComponents(XooRulesDefinition.class,XooProfileDefinition.class);
  tester.start();
  dbSession=dbClient().openSession(false);
  QualityProfileKey qualityProfileKey=QualityProfileKey.of("Basic","xoo");
  QualityProfileDao qualityProfileDao=dbClient().qualityProfileDao();
  assertThat(qualityProfileDao.findAll(dbSession)).hasSize(1);
  assertThat(qualityProfileDao.getByKey(qualityProfileKey,dbSession)).isNotNull();
  ActiveRuleDao activeRuleDao=dbClient().activeRuleDao();
  assertThat(activeRuleDao.findByProfileKey(dbSession,qualityProfileKey)).hasSize(2);
  RuleKey ruleKey=RuleKey.of("xoo","x1");
  ActiveRuleKey activeRuleKey=ActiveRuleKey.of(qualityProfileKey,ruleKey);
  assertThat(tester.get(ActiveRuleIndex.class).getByKey(activeRuleKey)).isNotNull();
  tester.clearIndexes();
  assertThat(tester.get(ActiveRuleIndex.class).getByKey(activeRuleKey)).isNull();
  tester.get(Platform.class).restart();
  assertThat(tester.get(ActiveRuleIndex.class).getByKey(activeRuleKey)).isNotNull();
  org.sonar.server.qualityprofile.ActiveRule activeRule=tester.get(ActiveRuleIndex.class).getByKey(activeRuleKey);
  assertThat(activeRule.key().qProfile()).isEqualTo(qualityProfileKey);
  assertThat(activeRule.key().ruleKey()).isEqualTo(ruleKey);
  assertThat(activeRule.severity()).isEqualTo(Severity.CRITICAL);
}
