{
  long count=0;
  Connection readConnection=null, writeConnection=null;
  PreparedStatement stmt=null;
  ResultSet rs=null;
  PreparedStatement writeStatement=null;
  try {
    readConnection=db.getDataSource().getConnection();
    readConnection.setAutoCommit(false);
    if (readConnection.getMetaData().supportsTransactionIsolationLevel(Connection.TRANSACTION_READ_UNCOMMITTED)) {
      readConnection.setTransactionIsolation(Connection.TRANSACTION_READ_UNCOMMITTED);
    }
    stmt=initStatement(convertSelectSql(inputLoader.selectSql(),db),readConnection);
    rs=stmt.executeQuery();
    int cursor=0;
    while (rs.next()) {
      S row=inputLoader.load(rs);
      if (row == null) {
        continue;
      }
      if (writeConnection == null) {
        writeConnection=db.getDataSource().getConnection();
        writeConnection.setAutoCommit(false);
        writeStatement=writeConnection.prepareStatement(converter.updateSql());
      }
      if (converter.convert(row,writeStatement)) {
        writeStatement.addBatch();
        writeStatement.clearParameters();
        cursor++;
        count++;
      }
      if (cursor == groupSize) {
        commit(writeStatement,periodicUpdater);
        cursor=0;
      }
    }
    if (cursor > 0) {
      commit(writeStatement,periodicUpdater);
    }
  }
 catch (  SQLException e) {
    SqlUtil.log(LOGGER,e);
    throw processError(e);
  }
catch (  Exception e) {
    throw processError(e);
  }
 finally {
    DbUtils.closeQuietly(writeStatement);
    DbUtils.closeQuietly(writeConnection);
    DbUtils.closeQuietly(readConnection,stmt,rs);
    LOGGER.info("{} rows have been updated",count);
  }
}
