{
  SqlSession session=mybatis.openBatchSession();
  PurgeMapper purgeMapper=session.getMapper(PurgeMapper.class);
  PurgeCommands commands=new PurgeCommands(session,purgeMapper,profiler);
  try {
    List<ResourceDto> projects=getProjects(rootResourceId,session);
    for (    ResourceDto project : projects) {
      LOG.info("-> Clean " + project.getLongName() + " [id="+ project.getId()+ "]");
      deleteAbortedBuilds(project,commands);
      purge(project,scopesWithoutHistoricalData,commands);
    }
    for (    ResourceDto project : projects) {
      disableOrphanResources(project,session,purgeMapper);
    }
  }
  finally {
    MyBatis.closeQuietly(session);
  }
  return this;
}
