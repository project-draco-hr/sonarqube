{
  final BatchSession session=mybatis.openBatchSession();
  try {
    final PurgeMapper mapper=session.getMapper(PurgeMapper.class);
    List<Long> projectIds=resourceDao.getDescendantProjectIdsAndSelf(rootProjectId,session);
    for (    Long projectId : projectIds) {
      session.select("org.sonar.core.purge.PurgeMapper.selectResourceIdsByRootId",projectId,new ResultHandler(){
        public void handleResult(        ResultContext context){
          Long resourceId=(Long)context.getResultObject();
          deleteResource(resourceId,session,mapper);
        }
      }
);
    }
    session.commit();
    return this;
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
