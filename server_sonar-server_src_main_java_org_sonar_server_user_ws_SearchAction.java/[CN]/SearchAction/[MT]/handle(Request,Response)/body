{
  SearchOptions options=new SearchOptions().setPage(request.mandatoryParamAsInt(Param.PAGE),request.mandatoryParamAsInt(Param.PAGE_SIZE));
  List<String> fields=request.paramAsStrings(Param.FIELDS);
  SearchResult<UserDoc> result=userIndex.search(request.param(Param.TEXT_QUERY),options);
  Multimap<String,String> groupsByLogin=ArrayListMultimap.create();
  Map<String,Integer> tokenCountsByLogin=new HashMap<>();
  DbSession dbSession=dbClient.openSession(false);
  try {
    List<String> logins=Lists.transform(result.getDocs(),new Function<UserDoc,String>(){
      @Override public String apply(      @Nonnull UserDoc input){
        return input.login();
      }
    }
);
    groupsByLogin=dbClient.groupMembershipDao().selectGroupsByLogins(dbSession,logins);
    tokenCountsByLogin=dbClient.userTokenDao().countTokensByLogins(dbSession,logins);
  }
  finally {
    dbClient.closeSession(dbSession);
  }
  JsonWriter json=response.newJsonWriter().beginObject();
  options.writeJson(json,result.getTotal());
  writeUsers(json,result,groupsByLogin,tokenCountsByLogin,fields);
  json.endObject().close();
}
