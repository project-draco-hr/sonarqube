{
  if (ExtensionUtils.supportsEnvironment(extension,env) && (!analysisMode.isPreview() || ExtensionUtils.supportsPreview(extension)) && matcher.accept(extension)) {
    container.addExtension(metadata,extension);
  }
 else {
    container.declareExtension(metadata,extension);
  }
}
