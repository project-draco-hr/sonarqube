{
  BoolFilterBuilder filter=activeRuleFilter(query);
  SearchRequestBuilder builder=index.client().prepareSearch(INDEX_RULES).setTypes(TYPE_ACTIVE_RULE).setPostFilter(filter).addFields(FIELD_SOURCE,FIELD_PARENT).setSize(paging.pageSize()).setFrom(paging.offset());
  SearchHits hits=index.executeRequest(builder);
  List<Map<String,Object>> activeRuleSources=Lists.newArrayList();
  String[] parentIds=new String[hits.getHits().length];
  int hitCounter=0;
  List<QProfileRule> result=Lists.newArrayList();
  for (  SearchHit hit : hits.getHits()) {
    activeRuleSources.add(hit.sourceAsMap());
    parentIds[hitCounter]=hit.field(FIELD_PARENT).value();
    hitCounter++;
  }
  if (hitCounter > 0) {
    MultiGetRequestBuilder getParentRules=index.client().prepareMultiGet().add(INDEX_RULES,TYPE_RULE,parentIds);
    MultiGetItemResponse[] responses=index.executeMultiGet(getParentRules);
    for (int i=0; i < hitCounter; i++) {
      result.add(new QProfileRule(responses[i].getResponse().getSourceAsMap(),activeRuleSources.get(i)));
    }
  }
  return new QProfileRuleResult(result,PagingResult.create(paging.pageSize(),paging.pageIndex(),hits.getTotalHits()));
}
