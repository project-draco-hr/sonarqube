{
  BoolFilterBuilder filter=parentRuleFilter(query);
  addMustTermOrTerms(filter,RuleDocument.FIELD_SEVERITY,query.severities());
  filter.mustNot(hasChildFilter(TYPE_ACTIVE_RULE,termFilter(ActiveRuleDocument.FIELD_PROFILE_ID,query.profileId())));
  SearchRequestBuilder builder=index.client().prepareSearch(INDEX_RULES).setTypes(TYPE_RULE).setFilter(filter).addFields(FIELD_SOURCE,FIELD_PARENT).setSize(paging.pageSize()).setFrom(paging.offset());
  SearchHits hits=index.executeRequest(builder);
  List<QProfileRule> result=Lists.newArrayList();
  for (  SearchHit hit : hits.getHits()) {
    result.add(new QProfileRule(hit.sourceAsMap()));
  }
  return new QProfileRuleResult(result,PagingResult.create(paging.pageSize(),paging.pageIndex(),hits.getTotalHits()));
}
