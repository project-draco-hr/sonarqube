{
  try {
    LOG.debug("Deploy plugin " + plugin);
    File deployDir=new File(fileSystem.getDeployedPluginsDir(),plugin.getKey());
    FileUtils.forceMkdir(deployDir);
    FileUtils.cleanDirectory(deployDir);
    File target=new File(deployDir,plugin.getFilename());
    FileUtils.copyFile(plugin.getSourceFile(),target);
    plugin.addDeployedFile(target);
    for (    File extension : fileSystem.getExtensions(plugin.getKey())) {
      target=new File(deployDir,extension.getName());
      FileUtils.copyFile(extension,target);
      plugin.addDeployedFile(target);
    }
    if (plugin.getDependencyPaths().length > 0) {
      File tempDir=ZipUtils.unzipToTempDir(plugin.getSourceFile());
      for (      String depPath : plugin.getDependencyPaths()) {
        File file=new File(tempDir,depPath);
        target=new File(deployDir,file.getName());
        FileUtils.copyFile(file,target);
        plugin.addDeployedFile(target);
      }
      FileUtils.deleteQuietly(tempDir);
    }
    classloaders.addForCreation(plugin);
  }
 catch (  IOException e) {
    throw new RuntimeException("Fail to deploy the plugin " + plugin,e);
  }
}
