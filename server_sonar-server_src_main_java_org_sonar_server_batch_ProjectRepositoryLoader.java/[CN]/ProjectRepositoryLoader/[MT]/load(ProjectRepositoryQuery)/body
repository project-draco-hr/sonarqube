{
  boolean hasScanPerm=UserSession.get().hasGlobalPermission(GlobalPermissions.SCAN_EXECUTION);
  checkPermission(query.isPreview());
  DbSession session=dbClient.openSession(false);
  try {
    ProjectRepositories ref=new ProjectRepositories();
    String projectKey=query.getModuleKey();
    ComponentDto module=dbClient.componentDao().getNullableByKey(session,query.getModuleKey());
    if (module != null) {
      if (query.isPreview() && !UserSession.get().hasProjectPermissionByUuid(UserRole.USER,module.projectUuid())) {
        throw new ForbiddenException("You're not authorized to access to project '" + module.name() + "', please contact your SonarQube administrator.");
      }
      ComponentDto project=getProject(module,session);
      if (!project.key().equals(module.key())) {
        addSettings(ref,module.getKey(),getSettingsFromParents(module,hasScanPerm,session));
        projectKey=project.key();
      }
      List<ComponentDto> modulesTree=dbClient.componentDao().selectEnabledDescendantModules(session,module.uuid());
      Map<String,String> moduleUuidsByKey=moduleUuidsByKey(module,modulesTree);
      Map<String,Long> moduleIdsByKey=moduleIdsByKey(module,modulesTree);
      List<PropertyDto> modulesTreeSettings=dbClient.propertiesDao().selectEnabledDescendantModuleProperties(module.uuid(),session);
      TreeModuleSettings treeModuleSettings=new TreeModuleSettings(moduleUuidsByKey,moduleIdsByKey,modulesTree,modulesTreeSettings,module);
      addSettingsToChildrenModules(ref,query.getModuleKey(),Maps.<String,String>newHashMap(),treeModuleSettings,hasScanPerm,session);
      List<FilePathWithHashDto> files=module.isRootProject() ? dbClient.componentDao().selectEnabledFilesFromProject(session,module.uuid()) : dbClient.componentDao().selectEnabledDescendantFiles(session,module.uuid());
      addFileData(session,ref,modulesTree,files);
      ref.setLastAnalysisDate(new Date());
    }
 else {
      ref.setLastAnalysisDate(null);
    }
    addProfiles(ref,projectKey,query.getProfileName(),session);
    addActiveRules(ref);
    addManualRules(ref);
    return ref;
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
