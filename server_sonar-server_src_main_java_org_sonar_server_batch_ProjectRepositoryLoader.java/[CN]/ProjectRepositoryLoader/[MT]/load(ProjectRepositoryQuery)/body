{
  boolean hasScanPerm=UserSession.get().hasGlobalPermission(GlobalPermissions.SCAN_EXECUTION);
  checkPermission(query.isPreview());
  DbSession session=dbClient.openSession(false);
  try {
    ProjectRepositories ref=new ProjectRepositories();
    String projectKey=query.getModuleKey();
    ComponentDto module=dbClient.componentDao().getNullableByKey(session,query.getModuleKey());
    if (module != null) {
      ComponentDto project=getProject(module,session);
      if (!project.key().equals(module.key())) {
        addSettings(ref,module.getKey(),getSettingsFromParents(module,hasScanPerm,session));
        projectKey=project.key();
      }
      List<ComponentDto> modulesTree=dbClient.componentDao().selectModulesTree(session,module.uuid());
      Map<String,String> moduleUuidsByKey=moduleUuidsByKey(module,modulesTree);
      Map<String,Long> moduleIdsByKey=moduleIdsByKey(module,modulesTree);
      List<PropertyDto> modulesTreeSettings=dbClient.propertiesDao().selectModulePropertiesTree(module.uuid(),session);
      TreeModuleSettings treeModuleSettings=new TreeModuleSettings(moduleUuidsByKey,moduleIdsByKey,modulesTree,modulesTreeSettings,module);
      addSettingsToChildrenModules(ref,query.getModuleKey(),Maps.<String,String>newHashMap(),treeModuleSettings,hasScanPerm,session);
      addFileData(session,ref,modulesTree,module.uuid());
    }
    addProfiles(ref,projectKey,query.getProfileName(),session);
    addActiveRules(ref);
    addManualRules(ref);
    return ref;
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
