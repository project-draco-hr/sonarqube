{
  for (  org.sonar.batch.protocol.input.QProfile qProfile : ref.qProfiles()) {
    Map<RuleKey,ActiveRule> activeRules=activeRuleByRuleKey(qProfileLoader.findActiveRulesByProfile(qProfile.key()));
    for (    Rule rule : ruleService.search(new RuleQuery().setQProfileKey(qProfile.key()).setActivation(true),new QueryContext()).getHits()) {
      RuleKey templateKey=rule.templateKey();
      ActiveRule activeRule=activeRules.get(rule.key());
      org.sonar.batch.protocol.input.ActiveRule inputActiveRule=new org.sonar.batch.protocol.input.ActiveRule(rule.key().repository(),rule.key().rule(),templateKey != null ? templateKey.rule() : null,rule.name(),activeRule.severity(),rule.internalKey(),qProfile.language());
      for (      Map.Entry<String,String> entry : activeRule.params().entrySet()) {
        inputActiveRule.addParam(entry.getKey(),entry.getValue());
      }
      ref.addActiveRule(inputActiveRule);
    }
  }
}
