{
  MockUserSession.set().setGlobalPermissions(GlobalPermissions.QUALITY_PROFILE_ADMIN).setLogin("marius");
  QualityProfileKey profileKey=QualityProfileKey.of("MyProfile","xoo");
  RuleActivation activation=new RuleActivation(ActiveRuleKey.of(profileKey,RuleKey.of("xoo","x1")));
  activation.setSeverity(Severity.BLOCKER);
  service.activate(activation);
  RuleActivation update=new RuleActivation(ActiveRuleKey.of(profileKey,RuleKey.of("xoo","x1")));
  update.setSeverity(Severity.CRITICAL);
  service.activate(update);
  List<ActiveRuleDto> activeRuleDtos=dbClient.activeRuleDao().findByProfileKey(profileKey,dbSession);
  assertThat(activeRuleDtos).hasSize(1);
  assertThat(activeRuleDtos.get(0).getSeverityString()).isEqualTo(Severity.CRITICAL);
  assertThat(activeRuleDtos.get(0).getInheritance()).isNull();
  ActiveRuleIndex index=tester.get(ActiveRuleIndex.class);
  index.refresh();
  ActiveRule activeRule=index.getByKey(activation.getKey());
  assertThat(activeRule).isNotNull();
  assertThat(activeRule.severity()).isEqualTo(Severity.CRITICAL);
  assertThat(activeRule.inheritance()).isEqualTo(ActiveRule.Inheritance.NONE);
}
