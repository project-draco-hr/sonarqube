{
  DbSession dbSession=dbClient.openSession(false);
  try {
    SearchTemplatesData.Builder data=newBuilder();
    List<PermissionTemplateDto> templates=searchTemplates(dbSession,wsRequest);
    List<Long> templateIds=Lists.transform(templates,TemplateToIdFunction.INSTANCE);
    List<TemplateUuidQualifier> defaultTemplates=defaultPermissionTemplateFinder.getDefaultTemplatesByQualifier();
    data.templates(templates).defaultTemplates(defaultTemplates).userCountByTemplateIdAndPermission(userCountByTemplateIdAndPermission(dbSession,templateIds)).groupCountByTemplateIdAndPermission(groupCountByTemplateIdAndPermission(dbSession,templateIds));
    return data.build();
  }
  finally {
    dbClient.closeSession(dbSession);
  }
}
