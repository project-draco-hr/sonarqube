{
  dbTester.truncateTables();
  analysisDate=DateUtils.parseDateQuietly("2015-06-01").getTime();
  reportReader.setMetadata(BatchReport.Metadata.newBuilder().setAnalysisDate(analysisDate).build());
  dbIdsRepository=new DbIdsRepository();
  now=DateUtils.parseDateQuietly("2015-06-02").getTime();
  when(system2.now()).thenReturn(now);
  underTest=new PersistSnapshotsStep(system2,dbClient,treeRootHolder,reportReader,dbIdsRepository,periodsHolderRule);
  periodsHolderRule.setPeriods();
}
