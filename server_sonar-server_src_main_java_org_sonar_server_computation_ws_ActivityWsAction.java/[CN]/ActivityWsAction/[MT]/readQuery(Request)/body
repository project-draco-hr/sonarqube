{
  CeActivityQuery query=new CeActivityQuery();
  query.setType(wsRequest.param(PARAM_TYPE));
  query.setOnlyCurrents(wsRequest.mandatoryParamAsBoolean(PARAM_ONLY_CURRENTS));
  query.setMinSubmittedAt(toTime(wsRequest.paramAsDateTime(PARAM_MIN_SUBMITTED_AT)));
  query.setMaxExecutedAt(toTime(wsRequest.paramAsDateTime(PARAM_MAX_EXECUTED_AT)));
  String status=wsRequest.param(PARAM_STATUS);
  if (status != null) {
    query.setStatus(CeActivityDto.Status.valueOf(status));
  }
  String componentUuid=wsRequest.param(PARAM_COMPONENT_UUID);
  if (componentUuid == null) {
    userSession.checkGlobalPermission(UserRole.ADMIN);
  }
 else {
    if (userSession.hasGlobalPermission(GlobalPermissions.SYSTEM_ADMIN) || userSession.hasComponentUuidPermission(UserRole.ADMIN,componentUuid)) {
      query.setComponentUuid(componentUuid);
    }
 else {
      throw new ForbiddenException("Requires administration permission");
    }
  }
  return query;
}
