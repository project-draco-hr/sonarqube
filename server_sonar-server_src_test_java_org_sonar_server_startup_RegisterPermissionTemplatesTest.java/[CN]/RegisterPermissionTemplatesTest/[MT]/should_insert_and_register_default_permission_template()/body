{
  LoadedTemplateDto expectedTemplate=new LoadedTemplateDto().setKey(DefaultPermissionTemplates.DEFAULT_TEMPLATE.getUuid()).setType(LoadedTemplateDto.PERMISSION_TEMPLATE_TYPE);
  PermissionTemplateDto permissionTemplate=DefaultPermissionTemplates.DEFAULT_TEMPLATE.setId(1L);
  when(loadedTemplateDao.countByTypeAndKey(LoadedTemplateDto.PERMISSION_TEMPLATE_TYPE,DefaultPermissionTemplates.DEFAULT_TEMPLATE.getUuid())).thenReturn(0);
  when(permissionTemplateDao.insert(dbSession,DefaultPermissionTemplates.DEFAULT_TEMPLATE)).thenReturn(permissionTemplate);
  when(groupDao.selectByName(dbSession,DefaultGroups.ADMINISTRATORS)).thenReturn(new GroupDto().setId(1L));
  when(groupDao.selectByName(dbSession,DefaultGroups.USERS)).thenReturn(new GroupDto().setId(2L));
  RegisterPermissionTemplates initializer=new RegisterPermissionTemplates(dbClient,settings);
  initializer.start();
  verify(loadedTemplateDao).insert(argThat(Matches.template(expectedTemplate)));
  verify(permissionTemplateDao).insert(dbSession,DefaultPermissionTemplates.DEFAULT_TEMPLATE);
  verify(permissionTemplateDao).insertGroupPermission(dbSession,1L,1L,UserRole.ADMIN);
  verify(permissionTemplateDao).insertGroupPermission(dbSession,1L,1L,UserRole.ISSUE_ADMIN);
  verify(permissionTemplateDao).insertGroupPermission(dbSession,1L,null,UserRole.USER);
  verify(permissionTemplateDao).insertGroupPermission(dbSession,1L,null,UserRole.CODEVIEWER);
  verifyNoMoreInteractions(permissionTemplateDao);
  verify(settings).saveProperty(DEFAULT_TEMPLATE_PROPERTY,DefaultPermissionTemplates.DEFAULT_TEMPLATE.getUuid());
}
