{
  LoadedTemplateDto expectedTemplate=new LoadedTemplateDto().setKey(DefaultPermissionTemplates.DEFAULT_TEMPLATE.getUuid()).setType(LoadedTemplateDto.PERMISSION_TEMPLATE_TYPE);
  PermissionTemplateDto permissionTemplate=DefaultPermissionTemplates.DEFAULT_TEMPLATE.setId(1L);
  when(loadedTemplateDao.countByTypeAndKey(LoadedTemplateDto.PERMISSION_TEMPLATE_TYPE,DefaultPermissionTemplates.DEFAULT_TEMPLATE.getUuid())).thenReturn(0);
  when(permissionTemplateDao.insert(any(DbSession.class),eq(DefaultPermissionTemplates.DEFAULT_TEMPLATE))).thenReturn(permissionTemplate);
  when(groupDao.selectByName(any(DbSession.class),eq(DefaultGroups.ADMINISTRATORS))).thenReturn(new GroupDto().setId(1L));
  when(groupDao.selectByName(any(DbSession.class),eq(DefaultGroups.USERS))).thenReturn(new GroupDto().setId(2L));
  RegisterPermissionTemplates initializer=new RegisterPermissionTemplates(dbClient,settings);
  initializer.start();
  verify(loadedTemplateDao).insert(argThat(Matches.template(expectedTemplate)));
  verify(permissionTemplateDao).insert(any(DbSession.class),eq(DefaultPermissionTemplates.DEFAULT_TEMPLATE));
  verify(permissionTemplateDao).insertGroupPermission(any(DbSession.class),eq(1L),eq(1L),eq(UserRole.ADMIN));
  verify(permissionTemplateDao).insertGroupPermission(any(DbSession.class),eq(1L),eq(1L),eq(UserRole.ISSUE_ADMIN));
  verify(permissionTemplateDao).insertGroupPermission(any(DbSession.class),eq(1L),eq(null),eq(UserRole.USER));
  verify(permissionTemplateDao).insertGroupPermission(any(DbSession.class),eq(1L),eq(null),eq(UserRole.CODEVIEWER));
  verifyNoMoreInteractions(permissionTemplateDao);
  verify(settings).saveProperty(DEFAULT_TEMPLATE_PROPERTY,DefaultPermissionTemplates.DEFAULT_TEMPLATE.getUuid());
}
