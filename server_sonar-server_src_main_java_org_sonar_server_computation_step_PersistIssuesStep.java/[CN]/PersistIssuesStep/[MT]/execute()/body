{
  DbSession session=dbClient.openSession(true);
  IssueMapper mapper=session.getMapper(IssueMapper.class);
  IssueChangeMapper changeMapper=session.getMapper(IssueChangeMapper.class);
  CloseableIterator<DefaultIssue> issues=issueCache.traverse();
  try {
    while (issues.hasNext()) {
      DefaultIssue issue=issues.next();
      boolean saved=false;
      if (issue.isNew()) {
        Integer ruleId=ruleCache.get(issue.ruleKey()).getId();
        IssueDto dto=IssueDto.toDtoForComputationInsert(issue,ruleId,system2.now());
        Loggers.get(getClass()).info("---- INSERT " + dto);
        mapper.insert(dto);
        saved=true;
      }
 else       if (issue.isChanged()) {
        IssueDto dto=IssueDto.toDtoForUpdate(issue,system2.now());
        Loggers.get(getClass()).info("---- UPDATE " + dto);
        int updateCount=mapper.updateIfBeforeSelectedDate(dto);
        if (updateCount == 0) {
          Loggers.get(getClass()).info("---- CONFLICT: " + updateCount);
          conflictResolver.resolve(issue,mapper);
        }
        saved=true;
      }
 else {
        Loggers.get(getClass()).info("---- UNCHANGED " + issue);
      }
      if (saved) {
        insertChanges(changeMapper,issue);
      }
    }
    session.flushStatements();
    session.commit();
  }
  finally {
    MyBatis.closeQuietly(session);
    issues.close();
  }
}
