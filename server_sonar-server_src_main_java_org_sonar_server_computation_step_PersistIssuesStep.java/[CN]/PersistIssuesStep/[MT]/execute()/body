{
  DbSession session=dbClient.openSession(true);
  IssueMapper mapper=session.getMapper(IssueMapper.class);
  IssueChangeMapper changeMapper=session.getMapper(IssueChangeMapper.class);
  CloseableIterator<DefaultIssue> issues=issueCache.traverse();
  try {
    while (issues.hasNext()) {
      DefaultIssue issue=issues.next();
      boolean saved=false;
      if (issue.isNew()) {
        Integer ruleId=ruleRepository.getByKey(issue.ruleKey()).getId();
        IssueDto dto=IssueDto.toDtoForComputationInsert(issue,ruleId,system2.now());
        mapper.insert(dto);
        saved=true;
      }
 else       if (issue.isChanged()) {
        IssueDto dto=IssueDto.toDtoForUpdate(issue,system2.now());
        int updateCount=mapper.updateIfBeforeSelectedDate(dto);
        if (updateCount == 0) {
          conflictResolver.resolve(issue,mapper);
        }
        saved=true;
      }
      if (saved) {
        insertChanges(changeMapper,issue);
      }
    }
    session.flushStatements();
    session.commit();
  }
  finally {
    MyBatis.closeQuietly(session);
    issues.close();
  }
}
