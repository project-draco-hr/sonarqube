{
  DbSession session=dbClient.openSession(true);
  IssueMapper mapper=session.getMapper(IssueMapper.class);
  IssueChangeMapper changeMapper=session.getMapper(IssueChangeMapper.class);
  int count=0;
  CloseableIterator<DefaultIssue> issues=issueCache.traverse();
  try {
    while (issues.hasNext()) {
      DefaultIssue issue=issues.next();
      boolean saved=false;
      if (issue.isNew()) {
        Integer ruleId=ruleCache.get(issue.ruleKey()).getId();
        mapper.insert(IssueDto.toDtoForComputationInsert(issue,issue.componentId(),context.getProject().getId(),ruleId,system2.now()));
        count++;
        saved=true;
      }
 else       if (issue.isChanged()) {
        IssueDto dto=IssueDto.toDtoForUpdate(issue,context.getProject().getId(),system2.now());
        if (Issue.STATUS_CLOSED.equals(issue.status()) || issue.selectedAt() == null) {
          mapper.update(dto);
          count++;
        }
 else {
          int updateCount=mapper.updateIfBeforeSelectedDate(dto);
          count++;
          if (updateCount == 0) {
            conflictResolver.resolve(issue,mapper);
          }
        }
        saved=true;
      }
      if (saved) {
        count+=insertChanges(changeMapper,issue);
        if (count > BatchSession.MAX_BATCH_SIZE) {
          session.flushStatements();
          session.commit();
          count=0;
        }
      }
    }
    session.flushStatements();
    session.commit();
  }
  finally {
    MyBatis.closeQuietly(session);
    issues.close();
  }
}
