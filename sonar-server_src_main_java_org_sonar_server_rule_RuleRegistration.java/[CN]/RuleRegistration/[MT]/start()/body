{
  TimeProfiler profiler=new TimeProfiler().start("Register rules");
  SqlSession sqlSession=myBatis.openSession();
  try {
    RuleDefinitions.Context context=defLoader.load();
    Buffer buffer=new Buffer(system.now());
    List<CharacteristicDto> characteristicDtos=characteristicDao.selectCharacteristics();
    selectRulesFromDb(buffer,sqlSession);
    enableRuleDefinitions(context,buffer,characteristicDtos,sqlSession);
    List<RuleDto> removedRules=processRemainingDbRules(buffer,sqlSession);
    removeActiveRulesOnStillExistingRepositories(removedRules,context);
    index(buffer);
    ruleTagOperations.deleteUnusedTags(sqlSession);
    sqlSession.commit();
  }
  finally {
    sqlSession.close();
    profiler.stop();
  }
}
