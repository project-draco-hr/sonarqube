{
  String sql="SELECT block.id, hash, block.snapshot_id, resource_key, index_in_file, start_line, end_line FROM clone_blocks AS block, snapshots AS snapshot" + " WHERE block.snapshot_id=snapshot.id AND snapshot.islast=true" + " AND hash IN ( SELECT hash FROM clone_blocks WHERE resource_key = :resource_key AND snapshot_id = :current_snapshot_id )";
  if (lastSnapshotId != null) {
    sql+=" AND snapshot.id != " + lastSnapshotId;
  }
  List<CloneBlock> blocks=session.getEntityManager().createNativeQuery(sql,CloneBlock.class).setParameter("resource_key",resourceKey).setParameter("current_snapshot_id",currentSnapshotId).getResultList();
  cache.clear();
  for (  CloneBlock dbBlock : blocks) {
    Block block=new Block(dbBlock.getResourceKey(),new ByteArray(dbBlock.getHash()),dbBlock.getIndexInFile(),dbBlock.getStartLine(),dbBlock.getEndLine());
    List<Block> sameHash=cache.get(block.getBlockHash());
    if (sameHash == null) {
      sameHash=Lists.newArrayList();
      cache.put(block.getBlockHash(),sameHash);
    }
    sameHash.add(block);
  }
}
