{
  Optional<Cookie> stateCookie=CookieUtils.findCookie(CSRF_STATE_COOKIE,request);
  if (!stateCookie.isPresent()) {
    throw new UnauthorizedException();
  }
  Cookie cookie=stateCookie.get();
  String hashInCookie=cookie.getValue();
  cookie.setValue(null);
  cookie.setMaxAge(0);
  cookie.setPath(server.getContextPath() + "/");
  response.addCookie(cookie);
  String stateInRequest=request.getParameter("state");
  if (isBlank(stateInRequest) || !sha256Hex(stateInRequest).equals(hashInCookie)) {
    throw new UnauthorizedException();
  }
}
