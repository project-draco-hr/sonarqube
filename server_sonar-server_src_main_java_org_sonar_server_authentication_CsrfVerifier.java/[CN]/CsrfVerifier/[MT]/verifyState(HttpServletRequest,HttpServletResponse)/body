{
  Cookie stateCookie=null;
  Cookie[] cookies=request.getCookies();
  for (  Cookie cookie : cookies) {
    if (CSRF_STATE_COOKIE.equals(cookie.getName())) {
      stateCookie=cookie;
    }
  }
  if (stateCookie == null) {
    throw new UnauthorizedException();
  }
  String hashInCookie=stateCookie.getValue();
  stateCookie.setValue(null);
  stateCookie.setMaxAge(0);
  stateCookie.setPath("/");
  response.addCookie(stateCookie);
  String stateInRequest=request.getParameter("state");
  if (isBlank(stateInRequest) || !sha256Hex(stateInRequest).equals(hashInCookie)) {
    throw new UnauthorizedException();
  }
}
