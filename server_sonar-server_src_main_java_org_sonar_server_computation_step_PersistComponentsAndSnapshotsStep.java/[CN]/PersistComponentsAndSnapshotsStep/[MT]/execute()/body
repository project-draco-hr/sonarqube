{
  DbSession session=dbClient.openSession(false);
  try {
    org.sonar.server.computation.component.Component root=treeRootHolder.getRoot();
    List<ComponentDto> components=dbClient.componentDao().selectComponentsFromProjectKey(session,root.getKey());
    Map<String,ComponentDto> componentDtosByKey=componentDtosByKey(components);
    PersisComponentExecutor componentContext=new PersisComponentExecutor(session,componentDtosByKey,reportReader,reportReader.readMetadata().getAnalysisDate());
    componentContext.recursivelyProcessComponent(root,null,null);
    session.commit();
  }
  finally {
    session.close();
  }
}
