{
  dbTester.prepareDbUnit(getClass(),"traverse.xml");
  ActivityResultSetIterator it=ActivityResultSetIterator.create(dbTester.getDbClient(),dbTester.getSession(),0L);
  assertThat(it.hasNext()).isTrue();
  UpdateRequest request=it.next();
  Map<String,Object> doc=request.doc().sourceAsMap();
  assertThat(doc.get(ActivityIndexDefinition.FIELD_KEY)).isEqualTo("UUID1");
  assertThat(doc.get(ActivityIndexDefinition.FIELD_ACTION)).isEqualTo("THE_ACTION");
  assertThat(doc.get(ActivityIndexDefinition.FIELD_MESSAGE)).isEqualTo("THE_MSG");
  assertThat((Map<String,String>)doc.get(ActivityIndexDefinition.FIELD_DETAILS)).containsOnly(MapEntry.entry("foo","bar"),MapEntry.entry("profileKey","PROFILE_KEY"));
  assertThat(doc.get(ActivityIndexDefinition.FIELD_LOGIN)).isEqualTo("THE_AUTHOR");
  assertThat(it.hasNext()).isTrue();
  assertThat(it.next()).isNotNull();
  assertThat(it.hasNext()).isFalse();
  it.close();
  assertThat(formatLongDate(it.getMaxRowDate())).startsWith("2015-01-01");
}
