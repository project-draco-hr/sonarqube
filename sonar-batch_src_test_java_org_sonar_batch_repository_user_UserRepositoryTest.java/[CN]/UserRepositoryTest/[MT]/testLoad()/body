{
  WSLoader wsLoader=mock(WSLoader.class);
  UserRepository userRepo=new UserRepository(wsLoader);
  ByteArrayOutputStream out=new ByteArrayOutputStream();
  BatchInput.User.Builder builder=BatchInput.User.newBuilder();
  builder.setLogin("fmallet").setName("Freddy Mallet").build().writeDelimitedTo(out);
  builder.setLogin("sbrandhof").setName("Simon").build().writeDelimitedTo(out);
  ByteSource source=mock(ByteSource.class);
  when(wsLoader.loadSource("/batch/users?logins=fmallet,sbrandhof")).thenReturn(new WSLoaderResult(source,true));
  when(source.openStream()).thenReturn(new ByteArrayInputStream(out.toByteArray()));
  assertThat(userRepo.loadFromWs(Arrays.asList("fmallet","sbrandhof"))).extracting("login","name").containsOnly(tuple("fmallet","Freddy Mallet"),tuple("sbrandhof","Simon"));
}
