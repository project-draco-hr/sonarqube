{
  WSLoader wsLoader=mock(WSLoader.class);
  UserRepository userRepo=new UserRepository(wsLoader);
  ByteSource source=mock(ByteSource.class);
  when(wsLoader.loadSource("/batch/users?logins=fmallet,sbrandhof")).thenReturn(new WSLoaderResult<>(source,true));
  InputStream errorInputStream=mock(InputStream.class);
  Mockito.doThrow(IOException.class).when(errorInputStream).read();
  when(source.openStream()).thenReturn(errorInputStream);
  exception.expect(IllegalStateException.class);
  exception.expectMessage("Unable to get user details from server");
  assertThat(userRepo.loadFromWs(Arrays.asList("fmallet","sbrandhof"))).extracting("login","name").containsOnly(tuple("fmallet","Freddy Mallet"),tuple("sbrandhof","Simon"));
}
