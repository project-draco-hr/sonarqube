{
  Logger logger=LoggerFactory.getLogger(FileIndex.class);
  logger.info("Index files");
  Progress progress=new Progress(cache.fileRelativePaths(fileSystem.moduleKey()));
  if (fileSystem.sourceFiles().isEmpty()) {
    for (    File sourceDir : fileSystem.sourceDirs()) {
      indexDirectory(fileSystem,progress,sourceDir,InputFile.TYPE_SOURCE);
    }
  }
 else {
    indexFiles(fileSystem,progress,fileSystem.sourceDirs(),fileSystem.sourceFiles(),InputFile.TYPE_SOURCE);
  }
  if (fileSystem.testFiles().isEmpty()) {
    for (    File testDir : fileSystem.testDirs()) {
      indexDirectory(fileSystem,progress,testDir,InputFile.TYPE_TEST);
    }
  }
 else {
    indexFiles(fileSystem,progress,fileSystem.testDirs(),fileSystem.testFiles(),InputFile.TYPE_TEST);
  }
  for (  String path : progress.removedPaths) {
    cache.remove(fileSystem.moduleKey(),path);
  }
  logger.info(String.format("%d files indexed",progress.count));
}
