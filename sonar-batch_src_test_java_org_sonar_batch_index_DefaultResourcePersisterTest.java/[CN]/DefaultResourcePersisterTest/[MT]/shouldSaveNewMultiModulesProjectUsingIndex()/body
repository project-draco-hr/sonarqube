{
  setupData("shared");
  java.io.File baseDir=temp.newFolder();
  ResourcePersister persister=new DefaultResourcePersister(getSession(),mock(ResourcePermissions.class),snapshotCache,resourceCache);
  ProjectTree projectTree=mock(ProjectTree.class);
  when(projectTree.getRootProject()).thenReturn(multiModuleProject);
  when(projectTree.getProjectDefinition(multiModuleProject)).thenReturn(ProjectDefinition.create().setBaseDir(baseDir));
  when(projectTree.getProjectDefinition(moduleA)).thenReturn(ProjectDefinition.create().setBaseDir(new java.io.File(baseDir,"moduleA")));
  when(projectTree.getProjectDefinition(moduleB)).thenReturn(ProjectDefinition.create().setBaseDir(new java.io.File(baseDir,"moduleB")));
  when(projectTree.getProjectDefinition(moduleB1)).thenReturn(ProjectDefinition.create().setBaseDir(new java.io.File(baseDir,"moduleB/moduleB1")));
  PersistenceManager persistenceManager=new DefaultPersistenceManager(persister,null,null,null);
  DefaultIndex index=new DefaultIndex(persistenceManager,projectTree,mock(MetricFinder.class),mock(ScanGraph.class),mock(DeprecatedViolations.class),mock(ResourceKeyMigration.class),mock(MeasureCache.class));
  index.start();
  Resource file=File.create("src/main/java/org/Foo.java");
  index.setCurrentProject(moduleB1,null);
  index.index(file);
  index.addResource(new Library(moduleA.getKey(),"1.0"));
  checkTables("shouldSaveNewMultiModulesProjectAndLibrary",new String[]{"build_date","created_at","authorization_updated_at","uuid","project_uuid","module_uuid","module_uuid_path"},"projects","snapshots");
  enableSnapshot(1001);
  enableSnapshot(1002);
  enableSnapshot(1003);
  enableSnapshot(1004);
  enableSnapshot(1005);
  enableSnapshot(1006);
  SqlSession session=getMyBatis().openSession(false);
  try {
    ComponentDto root=session.getMapper(ComponentMapper.class).selectByKey("root");
    System.out.println("Root: " + root.uuid());
    assertThat(root.uuid()).isNotNull();
    assertThat(root.projectUuid()).isEqualTo(root.uuid());
    assertThat(root.moduleUuid()).isNull();
    assertThat(root.moduleUuidPath()).isEqualTo("");
    ComponentDto a=session.getMapper(ComponentMapper.class).selectByKey("a");
    System.out.println("A: " + a.uuid());
    assertThat(a.uuid()).isNotNull();
    assertThat(a.projectUuid()).isEqualTo(root.uuid());
    assertThat(a.moduleUuid()).isEqualTo(root.uuid());
    assertThat(a.moduleUuidPath()).isEqualTo(root.uuid());
    ComponentDto b=session.getMapper(ComponentMapper.class).selectByKey("b");
    System.out.println("B: " + b.uuid());
    assertThat(b.uuid()).isNotNull();
    assertThat(b.projectUuid()).isEqualTo(root.uuid());
    assertThat(b.moduleUuid()).isEqualTo(root.uuid());
    assertThat(b.moduleUuidPath()).isEqualTo(root.uuid());
    ComponentDto b1=session.getMapper(ComponentMapper.class).selectByKey("b1");
    System.out.println("B1: " + b1.uuid());
    assertThat(b1.uuid()).isNotNull();
    assertThat(b1.projectUuid()).isEqualTo(root.uuid());
    assertThat(b1.moduleUuid()).isEqualTo(b.uuid());
    assertThat(b1.moduleUuidPath()).isEqualTo(root.uuid() + "." + b.uuid());
    ComponentDto dir=session.getMapper(ComponentMapper.class).selectByKey("b1:src/main/java/org");
    assertThat(dir.uuid()).isNotNull();
    assertThat(dir.projectUuid()).isEqualTo(root.uuid());
    assertThat(dir.moduleUuid()).isEqualTo(b1.uuid());
    assertThat(dir.moduleUuidPath()).isEqualTo(root.uuid() + "." + b.uuid()+ "."+ b1.uuid());
    ComponentDto fileComp=session.getMapper(ComponentMapper.class).selectByKey("b1:src/main/java/org/Foo.java");
    assertThat(fileComp.uuid()).isNotNull();
    assertThat(fileComp.projectUuid()).isEqualTo(root.uuid());
    assertThat(fileComp.moduleUuid()).isEqualTo(b1.uuid());
    assertThat(fileComp.moduleUuidPath()).isEqualTo(root.uuid() + "." + b.uuid()+ "."+ b1.uuid());
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
