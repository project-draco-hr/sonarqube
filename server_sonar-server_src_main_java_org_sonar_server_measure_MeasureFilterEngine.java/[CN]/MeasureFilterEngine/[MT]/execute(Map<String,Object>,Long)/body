{
  Profiler profiler=Profiler.createIfDebug(LOG).start();
  MeasureFilterResult result=new MeasureFilterResult();
  MeasureFilterContext context=new MeasureFilterContext();
  context.setUserId(userId);
  context.setData(String.format("{%s}",Joiner.on('|').withKeyValueSeparator("=").join(filterMap)));
  try {
    profiler.addContext("request",context.getData());
    MeasureFilter filter=factory.create(filterMap);
    List<MeasureFilterRow> rows=executor.execute(filter,context);
    result.setRows(rows);
  }
 catch (  NumberFormatException e) {
    result.setError(MeasureFilterResult.Error.VALUE_SHOULD_BE_A_NUMBER);
    LOG.debug("Value selected for the metric should be a number: " + context);
  }
catch (  Exception e) {
    result.setError(MeasureFilterResult.Error.UNKNOWN);
    LOG.error("Fail to execute measure filter: " + context,e);
  }
 finally {
    profiler.addContext("result",result.toString());
    profiler.stopDebug("Measure filter executed");
  }
  return result;
}
