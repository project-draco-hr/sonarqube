{
  Properties properties=new Properties();
  properties.setProperty(Process.SONAR_HOME,FileUtils.getTempDirectoryPath());
  properties.setProperty(Process.NAME_PROPERTY,"ES");
  properties.setProperty(ElasticSearch.ES_HOME_PROPERTY,tempDirectory.getAbsolutePath());
  properties.setProperty(ElasticSearch.ES_PORT_PROPERTY,Integer.toString(freeESPort));
  elasticSearch=new ElasticSearch(Props.create(properties));
  new Thread(new Runnable(){
    @Override public void run(){
      elasticSearch.start();
    }
  }
).start();
  assertThat(elasticSearch.isReady()).isFalse();
  int count=0;
  while (!elasticSearch.isReady() && count < 100) {
    try {
      Thread.sleep(500);
    }
 catch (    InterruptedException e) {
      e.printStackTrace();
    }
    count++;
  }
  assertThat(count).isLessThan(100);
  Settings settings=ImmutableSettings.settingsBuilder().put("cluster.name","sonarqube").build();
  TransportClient client=new TransportClient(settings).addTransportAddress(new InetSocketTransportAddress("localhost",freeESPort));
  assertThat(client.admin().cluster().prepareClusterStats().get().getStatus()).isEqualTo(ClusterHealthStatus.GREEN);
  elasticSearch.terminate(true);
  try {
    client.admin().cluster().prepareClusterStats().get().getStatus();
    fail();
  }
 catch (  Exception e) {
    assertThat(e.getMessage()).isEqualTo("No node available");
  }
}
