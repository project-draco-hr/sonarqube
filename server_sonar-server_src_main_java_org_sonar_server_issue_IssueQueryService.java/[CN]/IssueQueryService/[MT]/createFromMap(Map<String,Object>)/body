{
  DbSession session=dbClient.openSession(false);
  try {
    IssueQuery.Builder builder=IssueQuery.builder().issueKeys(RubyUtils.toStrings(params.get(IssueFilterParameters.ISSUES))).severities(RubyUtils.toStrings(params.get(IssueFilterParameters.SEVERITIES))).statuses(RubyUtils.toStrings(params.get(IssueFilterParameters.STATUSES))).resolutions(RubyUtils.toStrings(params.get(IssueFilterParameters.RESOLUTIONS))).resolved(RubyUtils.toBoolean(params.get(IssueFilterParameters.RESOLVED))).rules(toRules(params.get(IssueFilterParameters.RULES))).actionPlans(RubyUtils.toStrings(params.get(IssueFilterParameters.ACTION_PLANS))).reporters(RubyUtils.toStrings(params.get(IssueFilterParameters.REPORTERS))).assignees(RubyUtils.toStrings(params.get(IssueFilterParameters.ASSIGNEES))).languages(RubyUtils.toStrings(params.get(IssueFilterParameters.LANGUAGES))).tags(RubyUtils.toStrings(params.get(IssueFilterParameters.TAGS))).onComponentOnly(RubyUtils.toBoolean(params.get(IssueFilterParameters.ON_COMPONENT_ONLY))).assigned(RubyUtils.toBoolean(params.get(IssueFilterParameters.ASSIGNED))).planned(RubyUtils.toBoolean(params.get(IssueFilterParameters.PLANNED))).hideRules(RubyUtils.toBoolean(params.get(IssueFilterParameters.HIDE_RULES))).createdAt(RubyUtils.toDate(params.get(IssueFilterParameters.CREATED_AT))).createdAfter(RubyUtils.toDate(params.get(IssueFilterParameters.CREATED_AFTER))).createdBefore(RubyUtils.toDate(params.get(IssueFilterParameters.CREATED_BEFORE)));
    addProjectUuids(builder,session,RubyUtils.toStrings(params.get(IssueFilterParameters.PROJECT_UUIDS)),RubyUtils.toStrings(ObjectUtils.defaultIfNull(params.get(IssueFilterParameters.PROJECT_KEYS),params.get(IssueFilterParameters.PROJECTS))));
    addComponentUuids(builder,session,RubyUtils.toStrings(params.get(IssueFilterParameters.COMPONENT_UUIDS)),RubyUtils.toStrings(ObjectUtils.defaultIfNull(params.get(IssueFilterParameters.COMPONENT_KEYS),params.get(IssueFilterParameters.COMPONENTS))),RubyUtils.toStrings(params.get(IssueFilterParameters.COMPONENT_ROOT_UUIDS)),RubyUtils.toStrings(params.get(IssueFilterParameters.COMPONENT_ROOTS)));
    addModuleUuids(builder,session,RubyUtils.toStrings(params.get(IssueFilterParameters.MODULE_UUIDS)),RubyUtils.toStrings(params.get(IssueFilterParameters.MODULE_KEYS)));
    String sort=(String)params.get(IssueFilterParameters.SORT);
    if (!Strings.isNullOrEmpty(sort)) {
      builder.sort(sort);
      builder.asc(RubyUtils.toBoolean(params.get(IssueFilterParameters.ASC)));
    }
    String ignorePaging=(String)params.get(IssueFilterParameters.IGNORE_PAGING);
    if (!Strings.isNullOrEmpty(ignorePaging)) {
      builder.ignorePaging(RubyUtils.toBoolean(ignorePaging));
    }
    return builder.build();
  }
  finally {
    session.close();
  }
}
