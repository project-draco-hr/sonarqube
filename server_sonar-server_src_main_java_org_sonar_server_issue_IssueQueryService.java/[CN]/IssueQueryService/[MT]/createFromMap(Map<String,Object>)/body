{
  DbSession session=dbClient.openSession(false);
  try {
    IssueQuery.Builder builder=IssueQuery.builder().issueKeys(RubyUtils.toStrings(params.get(IssueFilterParameters.ISSUES))).severities(RubyUtils.toStrings(params.get(IssueFilterParameters.SEVERITIES))).statuses(RubyUtils.toStrings(params.get(IssueFilterParameters.STATUSES))).resolutions(RubyUtils.toStrings(params.get(IssueFilterParameters.RESOLUTIONS))).resolved(RubyUtils.toBoolean(params.get(IssueFilterParameters.RESOLVED))).components(componentUuids(session,RubyUtils.toStrings(params.get(IssueFilterParameters.COMPONENTS)))).componentRoots(componentUuids(session,RubyUtils.toStrings(params.get(IssueFilterParameters.COMPONENT_ROOTS)))).rules(toRules(params.get(IssueFilterParameters.RULES))).actionPlans(RubyUtils.toStrings(params.get(IssueFilterParameters.ACTION_PLANS))).reporters(RubyUtils.toStrings(params.get(IssueFilterParameters.REPORTERS))).assignees(RubyUtils.toStrings(params.get(IssueFilterParameters.ASSIGNEES))).languages(RubyUtils.toStrings(params.get(IssueFilterParameters.LANGUAGES))).assigned(RubyUtils.toBoolean(params.get(IssueFilterParameters.ASSIGNED))).planned(RubyUtils.toBoolean(params.get(IssueFilterParameters.PLANNED))).hideRules(RubyUtils.toBoolean(params.get(IssueFilterParameters.HIDE_RULES))).createdAt(RubyUtils.toDate(params.get(IssueFilterParameters.CREATED_AT))).createdAfter(RubyUtils.toDate(params.get(IssueFilterParameters.CREATED_AFTER))).createdBefore(RubyUtils.toDate(params.get(IssueFilterParameters.CREATED_BEFORE)));
    String sort=(String)params.get(IssueFilterParameters.SORT);
    if (!Strings.isNullOrEmpty(sort)) {
      builder.sort(sort);
      builder.asc(RubyUtils.toBoolean(params.get(IssueFilterParameters.ASC)));
    }
    return builder.build();
  }
  finally {
    session.close();
  }
}
