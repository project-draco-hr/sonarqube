{
  SqlSession session=myBatis.openSession();
  try {
    removeAllPermissions(resourceId,session);
    PermissionTemplateDto permissionTemplate=getPermissionTemplate(templateKey);
    List<PermissionTemplateUserDto> usersPermissions=permissionTemplate.getUsersPermissions();
    if (usersPermissions != null) {
      for (      PermissionTemplateUserDto userPermission : usersPermissions) {
        insertUserPermission(resourceId,userPermission.getUserId(),userPermission.getPermission(),session);
      }
    }
    List<PermissionTemplateGroupDto> groupsPermissions=permissionTemplate.getGroupsPermissions();
    if (groupsPermissions != null) {
      for (      PermissionTemplateGroupDto groupPermission : groupsPermissions) {
        Long groupId=groupPermission.getGroupId() == null ? null : groupPermission.getGroupId();
        insertGroupPermission(resourceId,groupId,groupPermission.getPermission(),session);
      }
    }
    session.commit();
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
