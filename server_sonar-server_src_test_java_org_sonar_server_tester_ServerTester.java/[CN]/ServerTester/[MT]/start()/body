{
  checkNotStarted();
  try {
    Properties properties=new Properties();
    properties.putAll(initialProps);
    esServerHolder=EsServerHolder.get();
    properties.setProperty(ProcessProperties.CLUSTER_NAME,esServerHolder.getClusterName());
    properties.setProperty(ProcessProperties.CLUSTER_NODE_NAME,esServerHolder.getNodeName());
    properties.setProperty(ProcessProperties.SEARCH_PORT,String.valueOf(esServerHolder.getPort()));
    properties.setProperty(ProcessProperties.SEARCH_HOST,String.valueOf(esServerHolder.getHostName()));
    properties.setProperty(ProcessProperties.PATH_HOME,homeDir.getAbsolutePath());
    properties.setProperty(ProcessProperties.PATH_DATA,new File(homeDir,"data").getAbsolutePath());
    properties.setProperty(ProcessProperties.PATH_TEMP,createTemporaryFolderIn().getAbsolutePath());
    properties.setProperty(DatabaseProperties.PROP_URL,"jdbc:h2:" + homeDir.getAbsolutePath() + "/h2");
    for (    Map.Entry<Object,Object> entry : System.getProperties().entrySet()) {
      String key=entry.getKey().toString();
      if (key.startsWith(PROP_PREFIX)) {
        properties.put(StringUtils.substringAfter(key,PROP_PREFIX),entry.getValue());
      }
    }
    platform=new Platform();
    platform.init(properties,servletContext);
    platform.addComponents(components);
    platform.doStart();
  }
 catch (  Exception e) {
    stop();
    Throwables.propagate(e);
  }
  if (!platform.isStarted()) {
    throw new IllegalStateException("Server not started. You should check that db migrations " + "are correctly declared, for example in schema-h2.sql or DatabaseVersion");
  }
}
