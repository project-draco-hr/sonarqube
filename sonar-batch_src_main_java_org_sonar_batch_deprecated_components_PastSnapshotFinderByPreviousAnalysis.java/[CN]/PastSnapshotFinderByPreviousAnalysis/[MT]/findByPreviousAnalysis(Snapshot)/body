{
  String hql="from " + Snapshot.class.getSimpleName() + " where createdAt<:date AND resourceId=:resourceId AND status=:status and last=:last order by createdAt desc";
  List<Snapshot> snapshots=session.createQuery(hql).setParameter("date",projectSnapshot.getCreatedAtMs()).setParameter("resourceId",projectSnapshot.getResourceId()).setParameter("status",Snapshot.STATUS_PROCESSED).setParameter("last",true).setMaxResults(1).getResultList();
  if (snapshots.isEmpty()) {
    return new PastSnapshot(CoreProperties.TIMEMACHINE_MODE_PREVIOUS_ANALYSIS);
  }
  Snapshot snapshot=snapshots.get(0);
  Date targetDate=longToDate(snapshot.getCreatedAtMs());
  SimpleDateFormat format=new SimpleDateFormat(DateUtils.DATE_FORMAT);
  return new PastSnapshot(CoreProperties.TIMEMACHINE_MODE_PREVIOUS_ANALYSIS,targetDate,snapshot).setModeParameter(format.format(targetDate));
}
