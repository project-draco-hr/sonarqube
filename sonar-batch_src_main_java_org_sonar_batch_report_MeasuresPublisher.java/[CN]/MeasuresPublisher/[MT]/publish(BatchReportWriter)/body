{
  for (  final BatchComponent resource : resourceCache.all()) {
    Iterable<Measure> batchMeasures=measureCache.byResource(resource.resource());
    Iterable<org.sonar.batch.protocol.output.BatchReport.Measure> reportMeasures=Iterables.transform(batchMeasures,new Function<Measure,BatchReport.Measure>(){
      private final BatchReport.Measure.Builder builder=BatchReport.Measure.newBuilder();
      @Override public BatchReport.Measure apply(      @Nonnull Measure input){
        validateMeasure(input,resource.key());
        return toReportMeasure(builder,input);
      }
    }
);
    writer.writeComponentMeasures(resource.batchId(),reportMeasures);
  }
}
