{
  DbSession dbSession=dbClient.openSession(false);
  String valueAsString=request.mandatoryParam(PARAM_VALUE);
  String description=request.param(PARAM_DESCRIPTION);
  long now=system.now();
  try {
    ComponentDto component=searchProject(dbSession,request);
    MetricDto metric=searchMetric(dbSession,request);
    checkPermissions(component);
    checkIsProjectOrModule(component);
    checkMeasureDoesNotExistAlready(dbSession,component,metric);
    UserDoc user=userIndex.getByLogin(userSession.getLogin());
    CustomMeasureDto measure=new CustomMeasureDto().setComponentUuid(component.uuid()).setMetricId(metric.getId()).setDescription(description).setUserLogin(user.login()).setCreatedAt(now).setUpdatedAt(now);
    validator.setMeasureValue(measure,valueAsString,metric);
    dbClient.customMeasureDao().insert(dbSession,measure);
    dbSession.commit();
    JsonWriter json=response.newJsonWriter();
    customMeasureJsonWriter.write(json,measure,metric,component,user,CustomMeasureJsonWriter.OPTIONAL_FIELDS);
    json.close();
  }
  finally {
    MyBatis.closeQuietly(dbSession);
  }
}
