{
  SqlSession session=myBatis.openSession();
  try {
    StopWatch bulkWatch=startWatch();
    List<ActiveRuleDto> activeRules=activeRuleDao.selectAll(session);
    List<ActiveRuleParamDto> activeRuleParams=activeRuleDao.selectAllParams(session);
    bulkWatch.stop(String.format("Loaded %d active rules from DB",activeRules.size()));
    Multimap<Integer,ActiveRuleParamDto> paramsByActiveRule=ArrayListMultimap.create();
    for (    ActiveRuleParamDto param : activeRuleParams) {
      paramsByActiveRule.put(param.getActiveRuleId(),param);
    }
    String[] ids=bulkIndexActiveRules(activeRules,paramsByActiveRule);
    removeDeletedActiveRules(ids);
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
