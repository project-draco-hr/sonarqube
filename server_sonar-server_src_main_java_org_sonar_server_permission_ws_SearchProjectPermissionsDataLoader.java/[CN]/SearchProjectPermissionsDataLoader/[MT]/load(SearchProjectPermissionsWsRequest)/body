{
  DbSession dbSession=dbClient.openSession(false);
  try {
    SearchProjectPermissionsData.Builder data=newBuilder();
    int countRootComponents=countRootComponents(dbSession,rootQualifiers,request);
    List<ComponentDto> rootComponents=searchRootComponents(dbSession,request,paging(request,countRootComponents));
    List<Long> rootComponentIds=Lists.transform(rootComponents,ComponentToIdFunction.INSTANCE);
    data.rootComponents(rootComponents).paging(paging(request,countRootComponents)).userCountByProjectIdAndPermission(userCountByRootComponentIdAndPermission(dbSession,rootComponentIds)).groupCountByProjectIdAndPermission(groupCountByRootComponentIdAndPermission(dbSession,rootComponentIds));
    return data.build();
  }
  finally {
    dbClient.closeSession(dbSession);
  }
}
