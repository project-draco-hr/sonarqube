{
  long normTime=System.currentTimeMillis();
  try {
    boolean hasInlineRefreshRequest=false;
    ExecutorService executorService=Executors.newFixedThreadPool(CONCURRENT_NORMALIZATION_FACTOR);
    List<Future<List<? extends ActionRequest>>> requests=executorService.invokeAll(actions,20,TimeUnit.SECONDS);
    for (    Future<List<? extends ActionRequest>> updates : requests) {
      for (      ActionRequest update : updates.get()) {
        if (UpdateRequest.class.isAssignableFrom(update.getClass())) {
          bulkRequestBuilder.add(((UpdateRequest)update));
        }
 else         if (DeleteRequest.class.isAssignableFrom(update.getClass())) {
          bulkRequestBuilder.add(((DeleteRequest)update));
        }
 else         if (RefreshRequest.class.isAssignableFrom(update.getClass())) {
          hasInlineRefreshRequest=true;
        }
 else {
          throw new IllegalStateException("Un-managed request type: " + update.getClass());
        }
      }
    }
    executorService.shutdown();
    bulkRequestBuilder.setRefresh(hasInlineRefreshRequest);
  }
 catch (  Exception e) {
    throw new IllegalStateException("Could not execute normalization for stack",e);
  }
  return System.currentTimeMillis() - normTime;
}
