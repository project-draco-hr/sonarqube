{
  if (userId == null) {
    throw new IllegalStateException("User is not logged in");
  }
  IssueDto dto=issueDao.selectByKey(issueKey);
  if (dto == null) {
    throw new IllegalStateException("Unknown issue: " + issueKey);
  }
  String requiredRole=UserRole.USER;
  if (!authorizationDao.isAuthorizedComponentId(dto.getResourceId(),userId,requiredRole)) {
    throw new IllegalStateException("User does not have the role " + requiredRole + " required to change the issue: "+ issueKey);
  }
  DefaultIssue issue=dto.toDefaultIssue();
  if (change.hasChanges()) {
    issueDao.update(Arrays.asList(IssueDto.toDto(issue,dto.getResourceId(),dto.getRuleId())));
  }
  return issue;
}
