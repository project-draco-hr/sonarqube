{
  ModuleRulesBuilder builder=new ModuleRulesBuilder();
  for (  ModuleQProfiles.QProfile qProfile : qProfiles.findAll()) {
    ListMultimap<Integer,ActiveRuleParamDto> paramDtosByActiveRuleId=ArrayListMultimap.create();
    for (    ActiveRuleParamDto dto : dao.selectParamsByProfileId(qProfile.id())) {
      paramDtosByActiveRuleId.put(dto.getActiveRuleId(),dto);
    }
    for (    ActiveRuleDto activeDto : dao.selectByProfileId(qProfile.id())) {
      Rule rule=ruleFinder.findById(activeDto.getRulId());
      if (rule != null) {
        NewModuleRule newModuleRule=builder.activate(rule.ruleKey());
        newModuleRule.setSeverity(activeDto.getSeverityString());
        if (rule.getParent() != null) {
          newModuleRule.setEngineKey(rule.getParent().getConfigKey());
        }
 else {
          newModuleRule.setEngineKey(rule.getConfigKey());
        }
        for (        ActiveRuleParamDto paramDto : paramDtosByActiveRuleId.get(activeDto.getId())) {
          newModuleRule.setParam(paramDto.getKey(),paramDto.getValue());
        }
      }
    }
  }
  return builder.build();
}
