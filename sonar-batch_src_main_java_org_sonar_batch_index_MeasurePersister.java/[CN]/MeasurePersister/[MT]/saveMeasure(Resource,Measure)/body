{
  if (shouldSaveLater(measure)) {
    unsavedMeasuresByResource.put(resource,measure);
    return;
  }
  if (measure.getId() != null) {
    MeasureModel model=session.reattach(MeasureModel.class,measure.getId());
    model=mergeModel(measure,model);
    model.save(session);
    memoryOptimizer.evictDataMeasure(measure,model);
  }
 else   if (shouldPersistMeasure(resource,measure)) {
    Snapshot snapshot=resourcePersister.getSnapshotOrFail(resource);
    MeasureModel model=createModel(measure).setSnapshotId(snapshot.getId());
    model.save(session);
    memoryOptimizer.evictDataMeasure(measure,model);
  }
}
