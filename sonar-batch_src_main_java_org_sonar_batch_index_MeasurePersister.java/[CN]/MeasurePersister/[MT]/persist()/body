{
  try (DbSession session=mybatis.openSession(true)){
    MeasureMapper mapper=session.getMapper(MeasureMapper.class);
    for (    Entry<Measure> entry : measureCache.entries()) {
      String effectiveKey=entry.key()[0].toString();
      Measure measure=entry.value();
      BatchResource batchResource=resourceCache.get(effectiveKey);
      measure.setMetric(metricFinder.findByKey(measure.getMetricKey()));
      if (shouldPersistMeasure(batchResource.resource(),measure)) {
        MeasureModel measureModel=model(measure,ruleFinder).setSnapshotId(batchResource.snapshotId());
        mapper.insert(measureModel);
      }
    }
    session.commit();
  }
 catch (  Exception e) {
    throw new IllegalStateException("Unable to save some measures",e);
  }
}
