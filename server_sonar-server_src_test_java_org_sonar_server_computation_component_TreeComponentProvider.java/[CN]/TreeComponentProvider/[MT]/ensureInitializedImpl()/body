{
  new DepthTraversalTypeAwareCrawler(new TypeAwareVisitorAdapter(CrawlerDepthLimit.LEAVES,ComponentVisitor.Order.PRE_ORDER){
    @Override public void visitAny(    Component component){
      String ref=getRef(component);
      checkState(!componentsByRef.containsKey(ref),"Tree contains more than one component with ref " + ref);
      componentsByRef.put(ref,component);
    }
  }
).visit(root);
}
