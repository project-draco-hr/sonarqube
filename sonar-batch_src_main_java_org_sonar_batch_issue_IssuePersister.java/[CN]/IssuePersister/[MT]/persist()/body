{
  for (  Map.Entry<String,Snapshot> componentEntry : snapshotCache.snapshots()) {
    String componentKey=componentEntry.getKey();
    Snapshot snapshot=componentEntry.getValue();
    Collection<Issue> issues=issueCache.componentIssues(componentKey);
    for (    Issue issue : issues) {
      Rule rule=ruleFinder.findByKey(issue.ruleKey().repository(),issue.ruleKey().rule());
      if (rule == null) {
        throw new IllegalStateException("Rule not found: " + issue.ruleKey());
      }
      IssueDto dto=toIssueDto((DefaultIssue)issue,snapshot.getResourceId(),rule.getId());
      if (issue.isNew()) {
        dao.insert(dto);
      }
 else {
        dao.update(newArrayList(dto));
      }
    }
  }
}
