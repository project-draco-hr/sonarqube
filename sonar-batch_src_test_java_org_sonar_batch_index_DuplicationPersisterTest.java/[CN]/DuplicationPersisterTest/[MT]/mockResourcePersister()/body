{
  duplicationCache=mock(DuplicationCache.class);
  ResourceCache resourceCache=mock(ResourceCache.class);
  BatchResource batchResource=mock(BatchResource.class);
  when(batchResource.resource()).thenReturn(aFile);
  when(batchResource.snapshotId()).thenReturn(FILE_SNAPSHOT_ID);
  when(resourceCache.get("foo:org/foo/Bar.java")).thenReturn(batchResource);
  MetricFinder metricFinder=mock(MetricFinder.class);
  when(metricFinder.findByKey(CoreMetrics.DUPLICATIONS_DATA_KEY)).thenReturn(CoreMetrics.DUPLICATIONS_DATA.setId(2));
  duplicationPersister=new DuplicationPersister(getMyBatis(),ruleFinder,resourceCache,duplicationCache,metricFinder);
}
