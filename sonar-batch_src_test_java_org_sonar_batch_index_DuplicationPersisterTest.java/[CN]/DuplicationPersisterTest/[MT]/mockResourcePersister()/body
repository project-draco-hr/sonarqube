{
  duplicationCache=mock(DuplicationCache.class);
  snapshotCache=mock(SnapshotCache.class);
  ResourceCache resourceCache=mock(ResourceCache.class);
  when(snapshotCache.get("foo:org/foo/Bar.java")).thenReturn(fileSnapshot);
  when(resourceCache.get("foo:org/foo/Bar.java")).thenReturn(aFile);
  MetricFinder metricFinder=mock(MetricFinder.class);
  when(metricFinder.findByKey(CoreMetrics.DUPLICATIONS_DATA_KEY)).thenReturn(CoreMetrics.DUPLICATIONS_DATA.setId(2));
  duplicationPersister=new DuplicationPersister(getMyBatis(),ruleFinder,snapshotCache,resourceCache,duplicationCache,metricFinder);
}
