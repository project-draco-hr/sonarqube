{
  SearchRequestBuilder esSearch=getClient().prepareSearch(IssueIndexDefinition.INDEX).setTypes(IssueIndexDefinition.TYPE_ISSUE);
  QueryBuilder esQuery=QueryBuilders.matchAllQuery();
  BoolFilterBuilder esFilter=createBoolFilter(query);
  if (esFilter.hasClauses()) {
    esSearch.setQuery(QueryBuilders.filteredQuery(esQuery,esFilter));
  }
 else {
    esSearch.setQuery(esQuery);
  }
  esSearch.addAggregation(AggregationBuilders.terms(IssueIndexDefinition.FIELD_ISSUE_ASSIGNEE).size(Integer.MAX_VALUE).field(IssueIndexDefinition.FIELD_ISSUE_ASSIGNEE));
  esSearch.addAggregation(AggregationBuilders.missing("notAssigned").field(IssueIndexDefinition.FIELD_ISSUE_ASSIGNEE));
  SearchResponse response=esSearch.get();
  Terms aggregation=(Terms)response.getAggregations().getAsMap().get(IssueIndexDefinition.FIELD_ISSUE_ASSIGNEE);
  LinkedHashMap<String,Long> result=EsUtils.termsToMap(aggregation);
  result.put("_notAssigned_",((InternalMissing)response.getAggregations().get("notAssigned")).getDocCount());
  return result;
}
