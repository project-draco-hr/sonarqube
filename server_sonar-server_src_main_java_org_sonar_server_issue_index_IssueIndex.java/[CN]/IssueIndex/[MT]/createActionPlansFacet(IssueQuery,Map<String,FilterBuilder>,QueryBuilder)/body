{
  String fieldName=IssueIndexDefinition.FIELD_ISSUE_ACTION_PLAN;
  String facetName=IssueFilterParameters.ACTION_PLANS;
  Map<String,FilterBuilder> actionPlanFilters=Maps.newHashMap(filters);
  actionPlanFilters.remove("__isPlanned");
  actionPlanFilters.remove(fieldName);
  StickyFacetBuilder actionPlanFacetBuilder=new StickyFacetBuilder(esQuery,actionPlanFilters);
  BoolFilterBuilder facetFilter=actionPlanFacetBuilder.getStickyFacetFilter(fieldName);
  FilterAggregationBuilder facetTopAggregation=actionPlanFacetBuilder.buildTopFacetAggregation(fieldName,facetName,facetFilter,DEFAULT_FACET_SIZE);
  facetTopAggregation=actionPlanFacetBuilder.addSelectedItemsToFacet(fieldName,facetName,facetTopAggregation,query.actionPlans().toArray());
  facetTopAggregation.subAggregation(AggregationBuilders.missing(facetName + FACET_SUFFIX_MISSING).field(fieldName));
  return AggregationBuilders.global(facetName).subAggregation(facetTopAggregation);
}
