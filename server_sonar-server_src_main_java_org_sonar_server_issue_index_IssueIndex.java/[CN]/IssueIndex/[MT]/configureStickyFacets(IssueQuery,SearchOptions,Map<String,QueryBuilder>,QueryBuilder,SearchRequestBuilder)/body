{
  if (!options.getFacets().isEmpty()) {
    StickyFacetBuilder stickyFacetBuilder=newStickyFacetBuilder(query,filters,esQuery);
    addSimpleStickyFacetIfNeeded(options,stickyFacetBuilder,esSearch,SEVERITIES,IssueIndexDefinition.FIELD_ISSUE_SEVERITY);
    addSimpleStickyFacetIfNeeded(options,stickyFacetBuilder,esSearch,STATUSES,IssueIndexDefinition.FIELD_ISSUE_STATUS);
    addSimpleStickyFacetIfNeeded(options,stickyFacetBuilder,esSearch,PROJECT_UUIDS,IssueIndexDefinition.FIELD_ISSUE_PROJECT_UUID,query.projectUuids().toArray());
    addSimpleStickyFacetIfNeeded(options,stickyFacetBuilder,esSearch,MODULE_UUIDS,IssueIndexDefinition.FIELD_ISSUE_MODULE_UUID,query.moduleUuids().toArray());
    addSimpleStickyFacetIfNeeded(options,stickyFacetBuilder,esSearch,DIRECTORIES,IssueIndexDefinition.FIELD_ISSUE_DIRECTORY_PATH,query.directories().toArray());
    addSimpleStickyFacetIfNeeded(options,stickyFacetBuilder,esSearch,FILE_UUIDS,IssueIndexDefinition.FIELD_ISSUE_COMPONENT_UUID,query.fileUuids().toArray());
    addSimpleStickyFacetIfNeeded(options,stickyFacetBuilder,esSearch,LANGUAGES,IssueIndexDefinition.FIELD_ISSUE_LANGUAGE,query.languages().toArray());
    addSimpleStickyFacetIfNeeded(options,stickyFacetBuilder,esSearch,RULES,IssueIndexDefinition.FIELD_ISSUE_RULE_KEY,query.rules().toArray());
    addSimpleStickyFacetIfNeeded(options,stickyFacetBuilder,esSearch,AUTHORS,IssueIndexDefinition.FIELD_ISSUE_AUTHOR_LOGIN,query.authors().toArray());
    if (options.getFacets().contains(TAGS)) {
      esSearch.addAggregation(stickyFacetBuilder.buildStickyFacet(IssueIndexDefinition.FIELD_ISSUE_TAGS,TAGS,query.tags().toArray()));
    }
    if (options.getFacets().contains(TYPES)) {
      esSearch.addAggregation(stickyFacetBuilder.buildStickyFacet(IssueIndexDefinition.FIELD_ISSUE_TYPE,TYPES,query.types().toArray()));
    }
    if (options.getFacets().contains(RESOLUTIONS)) {
      esSearch.addAggregation(createResolutionFacet(query,filters,esQuery));
    }
    if (options.getFacets().contains(ASSIGNEES)) {
      esSearch.addAggregation(createAssigneesFacet(query,filters,esQuery));
    }
    addAssignedToMeFacetIfNeeded(esSearch,options,query,filters,esQuery);
    if (options.getFacets().contains(CREATED_AT)) {
      esSearch.addAggregation(getCreatedAtFacet(query,filters,esQuery));
    }
  }
  if (hasQueryEffortFacet(query)) {
    esSearch.addAggregation(EFFORT_AGGREGATION);
  }
}
