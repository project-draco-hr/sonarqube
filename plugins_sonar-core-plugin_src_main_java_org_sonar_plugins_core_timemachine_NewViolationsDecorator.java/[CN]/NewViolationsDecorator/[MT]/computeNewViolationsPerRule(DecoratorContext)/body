{
  for (  RulePriority severity : RulePriority.values()) {
    Metric metric=severityToMetric(severity);
    ListMultimap<Rule,Measure> childMeasuresPerRule=ArrayListMultimap.create();
    ListMultimap<Rule,Violation> violationsPerRule=ArrayListMultimap.create();
    Set<Rule> rules=Sets.newHashSet();
    Collection<Measure> children=context.getChildrenMeasures(MeasuresFilters.rules(metric));
    for (    Measure child : children) {
      RuleMeasure childRuleMeasure=(RuleMeasure)child;
      Rule rule=childRuleMeasure.getRule();
      if (rule != null) {
        childMeasuresPerRule.put(rule,childRuleMeasure);
        rules.add(rule);
      }
    }
    for (    Violation violation : context.getViolations()) {
      if (violation.getSeverity().equals(severity)) {
        rules.add(violation.getRule());
        violationsPerRule.put(violation.getRule(),violation);
      }
    }
    for (    Rule rule : rules) {
      RuleMeasure measure=RuleMeasure.createForRule(metric,rule,null);
      measure.setRulePriority(severity);
      for (      PastSnapshot pastSnapshot : timeMachineConfiguration.getProjectPastSnapshots()) {
        int variationIndex=pastSnapshot.getIndex();
        int count=countViolations(violationsPerRule.get(rule),pastSnapshot.getTargetDate());
        double sum=sumChildren(variationIndex,childMeasuresPerRule.get(rule)) + count;
        measure.setVariation(variationIndex,sum);
      }
      context.saveMeasure(measure);
    }
  }
}
