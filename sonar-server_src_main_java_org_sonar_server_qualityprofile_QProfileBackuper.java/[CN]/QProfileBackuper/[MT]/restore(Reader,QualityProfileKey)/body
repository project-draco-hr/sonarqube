{
  try {
    String profileLang=null, profileName=null;
    SMInputFactory inputFactory=initStax();
    SMHierarchicCursor rootC=inputFactory.rootElementCursor(reader);
    rootC.advance();
    if (!rootC.getLocalName().equals("profile")) {
      throw new IllegalArgumentException("Backup XML is not valid. Root element must be <profile>.");
    }
    SMInputCursor cursor=rootC.childElementCursor();
    while (cursor.getNext() != null) {
      String nodeName=cursor.getLocalName();
      if (StringUtils.equals("name",nodeName)) {
        profileName=StringUtils.trim(cursor.collectDescendantText(false));
      }
 else       if (StringUtils.equals("language",nodeName)) {
        profileLang=StringUtils.trim(cursor.collectDescendantText(false));
      }
 else       if (StringUtils.equals("rules",nodeName)) {
        QualityProfileKey targetKey=(QualityProfileKey)ObjectUtils.defaultIfNull(profileKey,QualityProfileKey.of(profileName,profileLang));
        SMInputCursor rulesCursor=cursor.childElementCursor("rule");
        doRestore(rulesCursor,targetKey);
      }
    }
  }
 catch (  XMLStreamException e) {
    throw new IllegalStateException("Fail to restore Quality profile backup",e);
  }
}
