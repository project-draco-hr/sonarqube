{
  String version=project.getAnalysisVersion();
  boolean isReleaseVersion=!version.endsWith(SNAPSHOT_SUFFIX);
  String snapshotVersionToDelete=isReleaseVersion ? version + SNAPSHOT_SUFFIX : "";
  for (Iterator<Event> it=context.getEvents(project).iterator(); it.hasNext(); ) {
    Event event=it.next();
    if (event.isVersionCategory()) {
      if (snapshotVersionToDelete.equals(event.getName()) || (version.equals(event.getName()) && !isReleaseVersion)) {
        it.remove();
        context.deleteEvent(event);
      }
 else       if (version.equals(event.getName()) && isReleaseVersion) {
        throw new IllegalStateException("A Sonar analysis can't delete a released version that already exists in the project history (version " + version + "). Please change the version of the project or clean its history first.");
      }
    }
  }
}
