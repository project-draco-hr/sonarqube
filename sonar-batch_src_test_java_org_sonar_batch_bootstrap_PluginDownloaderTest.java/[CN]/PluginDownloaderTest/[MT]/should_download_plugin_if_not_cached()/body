{
  SonarCache cache=mock(SonarCache.class);
  BatchSonarCache batchCache=mock(BatchSonarCache.class);
  when(batchCache.getCache()).thenReturn(cache);
  File fileInCache=temp.newFile();
  when(cache.cacheFile(Mockito.any(File.class),Mockito.anyString())).thenReturn("fakemd51").thenReturn("fakemd52");
  when(cache.getFileFromCache(Mockito.anyString(),Mockito.anyString())).thenReturn(null).thenReturn(fileInCache).thenReturn(null).thenReturn(fileInCache);
  ServerClient server=mock(ServerClient.class);
  PluginDownloader downloader=new PluginDownloader(batchCache,server);
  RemotePlugin plugin=new RemotePlugin("checkstyle",true).addFile("checkstyle-plugin.jar","fakemd51").addFile("checkstyle-extensions.jar","fakemd52");
  List<File> files=downloader.downloadPlugin(plugin);
  assertThat(files).hasSize(2);
  verify(server).download(Mockito.eq("/deploy/plugins/checkstyle/checkstyle-plugin.jar"),Mockito.any(File.class));
  verify(server).download(Mockito.eq("/deploy/plugins/checkstyle/checkstyle-extensions.jar"),Mockito.any(File.class));
}
