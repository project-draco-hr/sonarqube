{
  if (filter.mustReturnEmptyResult()) {
    return new FilterResult(filter,Collections.<Object[]>emptyList());
  }
  String sql=null;
  try {
    TimeProfiler profiler=new TimeProfiler(FilterExecutor.class).setLevelToDebug().start("Build/execute SQL query");
    sql=toSql(filter);
    LOG.debug("SQL: " + sql);
    Query query=session.getEntityManager().createNativeQuery(sql);
    setHqlParameters(filter,query);
    FilterResult result=new FilterResult(filter,query.getResultList());
    profiler.stop();
    profiler.start("Process rows");
    result.removeUnvalidRows();
    profiler.stop();
    profiler.start("Sort rows");
    result.sort();
    profiler.stop();
    return result;
  }
 catch (  Exception e) {
    throw new SonarException("Fail to execute filter: " + filter.toString() + ", sql="+ sql,e);
  }
}
