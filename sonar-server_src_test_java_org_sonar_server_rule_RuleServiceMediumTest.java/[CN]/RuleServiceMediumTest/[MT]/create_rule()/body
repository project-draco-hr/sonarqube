{
  MockUserSession.set().setGlobalPermissions(GlobalPermissions.QUALITY_PROFILE_ADMIN).setLogin("me");
  RuleKey templateRuleKey=RuleKey.of("java","S001");
  dao.insert(dbSession,RuleTesting.newDto(templateRuleKey).setCardinality(Cardinality.MULTIPLE));
  dbSession.commit();
  NewRule newRule=new NewRule().setTemplateKey(templateRuleKey).setName("My custom").setHtmlDescription("Some description").setSeverity(Severity.MAJOR).setStatus(RuleStatus.READY).setParams(newArrayList(new NewRuleParam("regex").setDefaultValue("a.*")));
  RuleKey customRuleKey=service.create(newRule);
  dbSession.clearCache();
  RuleDto rule=dao.getNullableByKey(dbSession,customRuleKey);
  assertThat(rule).isNotNull();
}
