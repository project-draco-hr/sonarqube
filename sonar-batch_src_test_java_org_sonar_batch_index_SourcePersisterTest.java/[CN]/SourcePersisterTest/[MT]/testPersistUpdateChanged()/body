{
  setupData("file_sources");
  Date now=DateUtils.parseDateTime("2014-10-29T16:44:02+0100");
  when(system2.newDate()).thenReturn(now);
  String relativePathSame="src/changed.java";
  java.io.File sameFile=new java.io.File(basedir,relativePathSame);
  FileUtils.write(sameFile,"changed\ncontent");
  DefaultInputFile inputFileNew=new DefaultInputFile(PROJECT_KEY,relativePathSame).setLines(2).setAbsolutePath(sameFile.getAbsolutePath()).setLineHashes(new byte[][]{md5("changed"),md5("content")});
  when(inputPathCache.all()).thenReturn(Arrays.<InputPath>asList(inputFileNew));
  mockResourceCache(relativePathSame,PROJECT_KEY,"uuidsame");
  sourcePersister.persist();
  FileSourceDto fileSourceDto=new FileSourceDao(getMyBatis()).select("uuidsame");
  assertThat(fileSourceDto.getCreatedAt()).isEqualTo(DateUtils.parseDateTime("2014-10-10T16:44:02+0200").getTime());
  assertThat(fileSourceDto.getUpdatedAt()).isEqualTo(now.getTime());
  assertThat(fileSourceDto.getData()).isEqualTo(",,,,,,,,,,,,,,,changed\r\n,,,,,,,,,,,,,,,content\r\n");
  assertThat(fileSourceDto.getLineHashes()).isEqualTo(md5Hex("changed") + "\n" + md5Hex("content"));
  assertThat(fileSourceDto.getDataHash()).isEqualTo("d1a4dd62422639f665a8d80b37c59f8d");
}
