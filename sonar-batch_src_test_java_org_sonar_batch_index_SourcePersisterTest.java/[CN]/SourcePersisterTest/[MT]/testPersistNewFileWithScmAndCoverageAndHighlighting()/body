{
  setupData("file_sources");
  Date now=DateUtils.parseDateTime("2014-10-29T16:44:02+0100");
  when(system2.newDate()).thenReturn(now);
  String relativePathNew="src/new.java";
  java.io.File newFile=new java.io.File(basedir,relativePathNew);
  FileUtils.write(newFile,"foo\nbar\nbiz");
  DefaultInputFile inputFileNew=new DefaultInputFile(PROJECT_KEY,relativePathNew).setLines(3).setAbsolutePath(newFile.getAbsolutePath()).setOriginalLineOffsets(new long[]{0,4,7}).setLineHashes(new byte[][]{md5("foo"),md5("bar"),md5("biz")});
  when(inputPathCache.all()).thenReturn(Arrays.<InputPath>asList(inputFileNew));
  mockResourceCache(relativePathNew,PROJECT_KEY,"uuidnew");
  String fileKey=PROJECT_KEY + ":" + relativePathNew;
  when(measureCache.byMetric(fileKey,CoreMetrics.SCM_AUTHORS_BY_LINE_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.SCM_AUTHORS_BY_LINE,"1=julien;2=simon;3=julien")));
  when(measureCache.byMetric(fileKey,CoreMetrics.SCM_LAST_COMMIT_DATETIMES_BY_LINE_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.SCM_LAST_COMMIT_DATETIMES_BY_LINE,"1=2014-10-11T16:44:02+0100;2=2014-10-12T16:44:02+0100;3=2014-10-13T16:44:02+0100")));
  when(measureCache.byMetric(fileKey,CoreMetrics.SCM_REVISIONS_BY_LINE_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.SCM_REVISIONS_BY_LINE,"1=123;2=234;3=345")));
  when(measureCache.byMetric(fileKey,CoreMetrics.COVERAGE_LINE_HITS_DATA_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.COVERAGE_LINE_HITS_DATA,"1=1;3=0")));
  when(measureCache.byMetric(fileKey,CoreMetrics.CONDITIONS_BY_LINE_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.CONDITIONS_BY_LINE,"1=4")));
  when(measureCache.byMetric(fileKey,CoreMetrics.COVERED_CONDITIONS_BY_LINE_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.COVERED_CONDITIONS_BY_LINE,"1=2")));
  when(measureCache.byMetric(fileKey,CoreMetrics.IT_COVERAGE_LINE_HITS_DATA_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.IT_COVERAGE_LINE_HITS_DATA,"1=2;3=0")));
  when(measureCache.byMetric(fileKey,CoreMetrics.IT_CONDITIONS_BY_LINE_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.IT_CONDITIONS_BY_LINE,"1=5")));
  when(measureCache.byMetric(fileKey,CoreMetrics.IT_COVERED_CONDITIONS_BY_LINE_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.IT_COVERED_CONDITIONS_BY_LINE,"1=3")));
  when(measureCache.byMetric(fileKey,CoreMetrics.OVERALL_COVERAGE_LINE_HITS_DATA_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.OVERALL_COVERAGE_LINE_HITS_DATA,"1=3;3=0")));
  when(measureCache.byMetric(fileKey,CoreMetrics.OVERALL_CONDITIONS_BY_LINE_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.OVERALL_CONDITIONS_BY_LINE,"1=6")));
  when(measureCache.byMetric(fileKey,CoreMetrics.OVERALL_COVERED_CONDITIONS_BY_LINE_KEY)).thenReturn(Arrays.asList(new Measure(CoreMetrics.OVERALL_COVERED_CONDITIONS_BY_LINE,"1=4")));
  SyntaxHighlightingData highlighting=new SyntaxHighlightingDataBuilder().registerHighlightingRule(0,3,TypeOfText.ANNOTATION).registerHighlightingRule(4,5,TypeOfText.COMMENT).registerHighlightingRule(7,16,TypeOfText.CONSTANT).build();
  when(componentDataCache.getData(fileKey,SnapshotDataTypes.SYNTAX_HIGHLIGHTING)).thenReturn(highlighting);
  DefaultSymbolTableBuilder symbolBuilder=new DefaultSymbolTableBuilder(fileKey,null);
  org.sonar.api.batch.sensor.symbol.Symbol s1=symbolBuilder.newSymbol(1,2);
  symbolBuilder.newReference(s1,4);
  symbolBuilder.newReference(s1,11);
  org.sonar.api.batch.sensor.symbol.Symbol s2=symbolBuilder.newSymbol(4,6);
  symbolBuilder.newReference(s2,0);
  symbolBuilder.newReference(s2,7);
  when(componentDataCache.getData(fileKey,SnapshotDataTypes.SYMBOL_HIGHLIGHTING)).thenReturn(symbolBuilder.build());
  DuplicationGroup group1=new DuplicationGroup(new DuplicationGroup.Block(fileKey,1,1)).addDuplicate(new DuplicationGroup.Block(fileKey,3,1)).addDuplicate(new DuplicationGroup.Block("anotherFile1",12,1)).addDuplicate(new DuplicationGroup.Block("anotherFile2",13,1));
  DuplicationGroup group2=new DuplicationGroup(new DuplicationGroup.Block(fileKey,1,2)).addDuplicate(new DuplicationGroup.Block("anotherFile1",12,2)).addDuplicate(new DuplicationGroup.Block("anotherFile2",13,2));
  when(duplicationCache.byComponent(fileKey)).thenReturn(Arrays.asList(group1,group2));
  sourcePersister.persist();
  FileSourceDto fileSourceDto=new FileSourceDao(getMyBatis()).select("uuidnew");
  assertThat(fileSourceDto.getCreatedAt()).isEqualTo(now.getTime());
  assertThat(fileSourceDto.getUpdatedAt()).isEqualTo(now.getTime());
  assertThat(fileSourceDto.getLineHashes()).isEqualTo(md5Hex("foo") + "\n" + md5Hex("bar")+ "\n"+ md5Hex("biz"));
  assertThat(fileSourceDto.getData()).isEqualTo("123,julien,2014-10-11T16:44:02+0100,1,4,2,2,5,3,3,6,4,\"0,3,a\",\"1,2,1;0,2,2\",\"1,3\",foo\r\n" + "234,simon,2014-10-12T16:44:02+0100,,,,,,,,,,\"0,1,cd\",\"0,1,1;0,2,2\",3,bar\r\n" + "345,julien,2014-10-13T16:44:02+0100,0,,,0,,,0,,,\"0,9,c\",\"4,5,1;0,2,2\",2,biz\r\n");
  assertThat(fileSourceDto.getDataHash()).isEqualTo("26930cf0250d525b04083185ff24a046");
}
