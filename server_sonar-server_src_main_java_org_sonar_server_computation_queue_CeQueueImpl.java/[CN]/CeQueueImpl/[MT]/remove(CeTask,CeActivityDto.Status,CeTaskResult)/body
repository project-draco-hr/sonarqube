{
  DbSession dbSession=dbClient.openSession(false);
  try {
    Optional<CeQueueDto> queueDto=dbClient.ceQueueDao().selectByUuid(dbSession,task.getUuid());
    if (!queueDto.isPresent()) {
      throw new IllegalStateException(format("Task does not exist anymore: %s",task));
    }
    CeActivityDto activityDto=new CeActivityDto(queueDto.get());
    activityDto.setStatus(status);
    updateQueueStatus(status,activityDto);
    updateTaskResult(activityDto,taskResult);
    remove(dbSession,task,queueDto.get(),activityDto);
  }
  finally {
    dbClient.closeSession(dbSession);
  }
}
