{
  when(ruleDao.selectEnablesAndNonManual(session)).thenReturn(newArrayList(new RuleDto().setId(1).setRepositoryKey("xoo").setRuleKey("key1").setSeverity(Severity.MINOR),new RuleDto().setId(2).setRepositoryKey("xoo").setRuleKey("key2").setSeverity(Severity.MINOR)));
  assertThat(esSetup.exists("rules","rule","3")).isTrue();
  String[] ids=registry.reindex(session);
  registry.removeDeletedRules(ids);
  assertThat(registry.findIds(ImmutableMap.of("repositoryKey","xoo"))).hasSize(2).containsOnly(1,2);
  assertThat(esSetup.exists("rules","rule","3")).isFalse();
}
