{
  sessionFactory=mock(DatabaseSessionFactory.class);
  ruleI18nManager=mock(RuleI18nManager.class);
  esSetup=new EsSetup();
  esSetup.execute(EsSetup.deleteAll());
  SearchNode node=mock(SearchNode.class);
  when(node.client()).thenReturn(esSetup.client());
  searchIndex=new SearchIndex(node);
  searchIndex.start();
  registry=new RuleRegistry(searchIndex,sessionFactory,ruleI18nManager);
  registry.start();
  String source1=IOUtils.toString(TestUtils.getResource(getClass(),"rules/rule1.json").toURI());
  String source2=IOUtils.toString(TestUtils.getResource(getClass(),"rules/rule2.json").toURI());
  esSetup.execute(EsSetup.index("rules","rule","1").withSource(source1),EsSetup.index("rules","rule","2").withSource(source2));
}
