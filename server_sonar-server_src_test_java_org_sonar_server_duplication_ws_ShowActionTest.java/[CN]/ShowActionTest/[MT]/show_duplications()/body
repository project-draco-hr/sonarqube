{
  String componentKey="src/Foo.java";
  userSessionRule.addComponentPermission(UserRole.CODEVIEWER,"org.codehaus.sonar:sonar",componentKey);
  ComponentDto componentDto=new ComponentDto().setId(10L);
  when(componentDao.getNullableByKey(session,componentKey)).thenReturn(componentDto);
  String data="{duplications}";
  when(measureDao.findByComponentKeyAndMetricKey(session,componentKey,CoreMetrics.DUPLICATIONS_DATA_KEY)).thenReturn(new MeasureDto().setComponentKey(componentKey).setMetricKey(CoreMetrics.DUPLICATIONS_DATA_KEY).setData("{duplications}"));
  List<DuplicationsParser.Block> blocks=newArrayList(new DuplicationsParser.Block(newArrayList(new DuplicationsParser.Duplication(componentDto,1,2))));
  when(parser.parse(componentDto,data,session)).thenReturn(blocks);
  WsTester.TestRequest request=tester.newGetRequest("api/duplications","show").setParam("key",componentKey);
  request.execute();
  verify(duplicationsJsonWriter).write(eq(blocks),any(JsonWriter.class),eq(session));
}
