{
  SearchRequestBuilder builder=client.prepareSearch(indices.toArray(new String[0])).setTypes(types.toArray(new String[0]));
  List<FilterBuilder> filters=Lists.newArrayList();
  if (StringUtils.isNotBlank(searchString)) {
    filters.add(queryFilter(QueryBuilders.queryString(searchString)));
  }
  for (  String field : fieldCriteria.keySet()) {
    if (fieldCriteria.get(field).size() > 1) {
      filters.add(termsFilter(field,fieldCriteria.get(field)));
    }
 else {
      filters.add(termFilter(field,fieldCriteria.get(field)));
    }
  }
  for (  String field : notFieldCriteria.keySet()) {
    if (notFieldCriteria.get(field).size() > 1) {
      filters.add(notFilter(termsFilter(field,notFieldCriteria.get(field))));
    }
 else {
      filters.add(notFilter(termFilter(field,notFieldCriteria.get(field))));
    }
  }
  if (filters.isEmpty()) {
    builder.setFilter(matchAllFilter());
  }
 else   if (filters.size() == 1) {
    builder.setFilter(filters.get(0));
  }
 else {
    builder.setFilter(andFilter(filters.toArray(new FilterBuilder[0])));
  }
  return addFacets(builder);
}
