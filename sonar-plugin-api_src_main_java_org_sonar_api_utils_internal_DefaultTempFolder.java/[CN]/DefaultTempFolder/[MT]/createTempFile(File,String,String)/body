{
  String baseName=StringUtils.defaultIfEmpty(prefix,"") + System.currentTimeMillis() + "-";
  try {
    for (int counter=0; counter < TEMP_DIR_ATTEMPTS; counter++) {
      File tempFile=new File(baseDir,baseName + counter + suffix);
      if (tempFile.createNewFile()) {
        return tempFile;
      }
    }
  }
 catch (  IOException e) {
    throw new IllegalStateException("Failed to create temp file",e);
  }
  throw new IllegalStateException(MessageFormat.format("Failed to create temp file within {0} attempts (tried {1} to {2})",TEMP_DIR_ATTEMPTS,baseName + 0 + suffix,baseName + (TEMP_DIR_ATTEMPTS - 1) + suffix));
}
