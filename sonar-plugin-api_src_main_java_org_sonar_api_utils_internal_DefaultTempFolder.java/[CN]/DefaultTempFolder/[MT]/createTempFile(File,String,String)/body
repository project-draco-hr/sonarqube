{
  String baseName=StringUtils.defaultIfEmpty(prefix,"") + System.currentTimeMillis() + "-";
  try {
    for (int counter=0; counter < TEMP_DIR_ATTEMPTS; counter++) {
      File tempFile=new File(baseDir,baseName + counter + suffix);
      if (tempFile.createNewFile()) {
        return tempFile;
      }
    }
  }
 catch (  IOException e) {
    throw new IllegalStateException("Failed to create temp file",e);
  }
  throw new IllegalStateException("Failed to create temp file within " + TEMP_DIR_ATTEMPTS + " attempts (tried "+ baseName+ "0"+ suffix+ " to "+ baseName+ (TEMP_DIR_ATTEMPTS - 1)+ suffix+ ")");
}
