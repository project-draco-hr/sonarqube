{
  printIndent(out,lineage.size());
  if (map == null) {
    if (label != null) {
      out.print(label);
      out.print(" = ");
    }
    out.println("null");
    return;
  }
  if (label != null) {
    out.print(label);
    out.println(" = ");
  }
  printIndent(out,lineage.size());
  out.println("{");
  lineage.push(map);
  for (Iterator it=map.entrySet().iterator(); it.hasNext(); ) {
    Map.Entry entry=(Map.Entry)it.next();
    Object childKey=entry.getKey();
    Object childValue=entry.getValue();
    if (childValue instanceof Map && !lineage.contains(childValue)) {
      verbosePrintInternal(out,(childKey == null ? "null" : childKey),(Map)childValue,lineage,debug);
    }
 else {
      printIndent(out,lineage.size());
      out.print(childKey);
      out.print(" = ");
      final int lineageIndex=lineage.indexOf(childValue);
      if (lineageIndex == -1) {
        out.print(childValue);
      }
 else       if (lineage.size() - 1 == lineageIndex) {
        out.print("(this Map)");
      }
 else {
        out.print("(ancestor[" + (lineage.size() - 1 - lineageIndex- 1) + "] Map)");
      }
      if (debug && childValue != null) {
        out.print(' ');
        out.println(childValue.getClass().getName());
      }
 else {
        out.println();
      }
    }
  }
  lineage.pop();
  printIndent(out,lineage.size());
  out.println(debug ? "} " + map.getClass().getName() : "}");
}
