{
  DbSession session=db.openSession(false);
  try {
    OrFilterBuilder activityFilter=FilterBuilders.orFilter();
    for (    String profileKey : query.getQprofileKeys()) {
      activityFilter.add(FilterBuilders.nestedFilter("details",QueryBuilders.matchQuery("details.profileKey",profileKey)));
    }
    SearchResponse response=index.get(ActivityIndex.class).search(query,options,activityFilter);
    Result<QProfileActivity> result=new Result<QProfileActivity>(response);
    for (    SearchHit hit : response.getHits().getHits()) {
      QProfileActivity profileActivity=new QProfileActivity(hit.getSource());
      RuleDto ruleDto=db.ruleDao().getNullableByKey(session,profileActivity.ruleKey());
      profileActivity.ruleName(ruleDto != null ? ruleDto.getName() : null);
      String login=profileActivity.login();
      if (login != null) {
        UserDto user=db.userDao().selectActiveUserByLogin(login,session);
        profileActivity.authorName(user != null ? user.getName() : null);
      }
      result.getHits().add(profileActivity);
    }
    return result;
  }
  finally {
    session.close();
  }
}
