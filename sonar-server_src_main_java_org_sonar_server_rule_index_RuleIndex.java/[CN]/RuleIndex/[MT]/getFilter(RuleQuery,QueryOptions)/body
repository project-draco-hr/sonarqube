{
  BoolFilterBuilder fb=FilterBuilders.boolFilter();
  this.addMultiFieldTermFilter(query.getDebtCharacteristics(),fb,RuleNormalizer.RuleField.SUB_CHARACTERISTIC.key(),RuleNormalizer.RuleField.CHARACTERISTIC.key());
  this.addTermFilter(RuleNormalizer.RuleField.LANGUAGE.key(),query.getLanguages(),fb);
  this.addTermFilter(RuleNormalizer.RuleField.REPOSITORY.key(),query.getRepositories(),fb);
  this.addTermFilter(RuleNormalizer.RuleField.SEVERITY.key(),query.getSeverities(),fb);
  this.addTermFilter(RuleNormalizer.RuleField.KEY.key(),query.getKey(),fb);
  this.addTermFilter(RuleNormalizer.RuleField._TAGS.key(),query.getTags(),fb);
  if (query.getStatuses() != null && !query.getStatuses().isEmpty()) {
    Collection<String> stringStatus=new ArrayList<String>();
    for (    RuleStatus status : query.getStatuses()) {
      stringStatus.add(status.name());
    }
    this.addTermFilter(RuleNormalizer.RuleField.STATUS.key(),stringStatus,fb);
  }
  if (query.getActivation() == Boolean.TRUE) {
    if (query.getQProfileKey() == null) {
      fb.must(FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),QueryBuilders.matchAllQuery()));
    }
 else {
      fb.must(FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),QueryBuilders.termQuery(ActiveRuleNormalizer.ActiveRuleField.PROFILE_KEY.key(),query.getQProfileKey())));
    }
  }
 else   if (query.getActivation() == Boolean.FALSE) {
    if (query.getQProfileKey() == null) {
      fb.mustNot(FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),QueryBuilders.matchAllQuery()));
    }
 else {
      fb.mustNot(FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),QueryBuilders.termQuery(ActiveRuleNormalizer.ActiveRuleField.PROFILE_KEY.key(),query.getQProfileKey())));
    }
  }
  return fb.hasClauses() ? fb : FilterBuilders.matchAllFilter();
}
