{
  BoolFilterBuilder fb=FilterBuilders.boolFilter();
  fb.mustNot(FilterBuilders.termFilter(RuleNormalizer.RuleField.STATUS.field(),RuleStatus.REMOVED.toString()));
  this.addMultiFieldTermFilter(fb,query.getDebtCharacteristics(),RuleNormalizer.RuleField.SUB_CHARACTERISTIC.field(),RuleNormalizer.RuleField.CHARACTERISTIC.field());
  this.addTermFilter(fb,RuleNormalizer.RuleField.LANGUAGE.field(),query.getLanguages());
  this.addTermFilter(fb,RuleNormalizer.RuleField.REPOSITORY.field(),query.getRepositories());
  this.addTermFilter(fb,RuleNormalizer.RuleField.SEVERITY.field(),query.getSeverities());
  this.addTermFilter(fb,RuleNormalizer.RuleField.KEY.field(),query.getKey());
  this.addTermFilter(fb,RuleNormalizer.RuleField._TAGS.field(),query.getTags());
  if (query.getAvailableSince() != null) {
    fb.must(FilterBuilders.rangeFilter(RuleNormalizer.RuleField.UPDATED_AT.field()).gte(query.getAvailableSince()));
  }
  if (query.getStatuses() != null && !query.getStatuses().isEmpty()) {
    Collection<String> stringStatus=new ArrayList<String>();
    for (    RuleStatus status : query.getStatuses()) {
      stringStatus.add(status.name());
    }
    this.addTermFilter(fb,RuleNormalizer.RuleField.STATUS.field(),stringStatus);
  }
  Boolean isTemplate=query.isTemplate();
  if (isTemplate != null) {
    this.addTermFilter(fb,RuleNormalizer.RuleField.TEMPLATE.field(),Boolean.toString(isTemplate));
  }
  BoolFilterBuilder childrenFilter=FilterBuilders.boolFilter();
  this.addTermFilter(childrenFilter,ActiveRuleNormalizer.ActiveRuleField.PROFILE_KEY.field(),query.getQProfileKey());
  this.addTermFilter(childrenFilter,ActiveRuleNormalizer.ActiveRuleField.INHERITANCE.field(),query.getInheritance());
  QueryBuilder childQuery;
  if (childrenFilter.hasClauses()) {
    childQuery=QueryBuilders.constantScoreQuery(childrenFilter);
  }
 else {
    childQuery=QueryBuilders.matchAllQuery();
  }
  if (query.getActivation() == Boolean.TRUE) {
    fb.must(FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),childQuery));
  }
 else   if (query.getActivation() == Boolean.FALSE) {
    fb.mustNot(FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),childQuery));
  }
  return fb;
}
