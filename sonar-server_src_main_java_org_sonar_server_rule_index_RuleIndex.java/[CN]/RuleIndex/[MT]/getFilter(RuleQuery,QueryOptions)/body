{
  BoolFilterBuilder fb=FilterBuilders.boolFilter();
  fb.mustNot(FilterBuilders.termFilter(RuleNormalizer.RuleField.STATUS.field(),RuleStatus.REMOVED.toString()));
  this.addMultiFieldTermFilter(query.getDebtCharacteristics(),fb,RuleNormalizer.RuleField.SUB_CHARACTERISTIC.field(),RuleNormalizer.RuleField.CHARACTERISTIC.field());
  this.addTermFilter(RuleNormalizer.RuleField.LANGUAGE.field(),query.getLanguages(),fb);
  this.addTermFilter(RuleNormalizer.RuleField.REPOSITORY.field(),query.getRepositories(),fb);
  this.addTermFilter(RuleNormalizer.RuleField.SEVERITY.field(),query.getSeverities(),fb);
  this.addTermFilter(RuleNormalizer.RuleField.KEY.field(),query.getKey(),fb);
  this.addTermFilter(RuleNormalizer.RuleField._TAGS.field(),query.getTags(),fb);
  if (query.getStatuses() != null && !query.getStatuses().isEmpty()) {
    Collection<String> stringStatus=new ArrayList<String>();
    for (    RuleStatus status : query.getStatuses()) {
      stringStatus.add(status.name());
    }
    this.addTermFilter(RuleNormalizer.RuleField.STATUS.field(),stringStatus,fb);
  }
  if (query.getActivation() == Boolean.TRUE) {
    if (query.getQProfileKey() == null) {
      fb.must(FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),QueryBuilders.matchAllQuery()));
    }
 else {
      fb.must(FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),QueryBuilders.termQuery(ActiveRuleNormalizer.ActiveRuleField.PROFILE_KEY.field(),query.getQProfileKey())));
    }
  }
 else   if (query.getActivation() == Boolean.FALSE) {
    if (query.getQProfileKey() == null) {
      fb.mustNot(FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),QueryBuilders.matchAllQuery()));
    }
 else {
      fb.mustNot(FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),QueryBuilders.termQuery(ActiveRuleNormalizer.ActiveRuleField.PROFILE_KEY.field(),query.getQProfileKey())));
    }
  }
  return fb;
}
