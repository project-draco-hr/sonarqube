{
  String taskUuid=wsRequest.mandatoryParam(PARAM_TASK_UUID);
  DbSession dbSession=dbClient.openSession(false);
  try {
    WsCe.TaskResponse.Builder wsTaskResponse=WsCe.TaskResponse.newBuilder();
    Optional<CeQueueDto> queueDto=dbClient.ceQueueDao().selectByUuid(dbSession,taskUuid);
    if (queueDto.isPresent()) {
      checkPermission(queueDto.get().getComponentUuid());
      wsTaskResponse.setTask(wsTaskFormatter.formatQueue(dbSession,queueDto.get()));
    }
 else {
      Optional<CeActivityDto> activityDto=dbClient.ceActivityDao().selectByUuid(dbSession,taskUuid);
      if (activityDto.isPresent()) {
        CeActivityDto ceActivityDto=activityDto.get();
        checkPermission(ceActivityDto.getComponentUuid());
        Set<AdditionalField> additionalFields=AdditionalField.getFromRequest(wsRequest);
        maskErrorStacktrace(ceActivityDto,additionalFields);
        wsTaskResponse.setTask(wsTaskFormatter.formatActivity(dbSession,ceActivityDto,extractScannerContext(dbSession,taskUuid,additionalFields)));
      }
 else {
        throw new NotFoundException();
      }
    }
    writeProtobuf(wsTaskResponse.build(),wsRequest,wsResponse);
  }
  finally {
    dbClient.closeSession(dbSession);
  }
}
