{
  String sql="select m.metric_id, m.characteristic_id, m.person_id, m.rule_id, m.value from project_measures m, snapshots s" + " where m.snapshot_id=s.id and m.metric_id in (:metricIds) " + "       and (s.root_snapshot_id=:rootSnapshotId or s.id=:rootSnapshotId) "+ "       and s.status=:status and s.project_id=(select p.id from projects p where p.kee=:resourceKey and p.qualifier<>:lib" + (StringUtils.isNotBlank(path) ? " and p.path=:path" : "") + ")";
  Query q=session.createNativeQuery(sql).setParameter("metricIds",metricByIds.keySet()).setParameter("rootSnapshotId",ObjectUtils.defaultIfNull(projectPastSnapshot.getRootId(),projectPastSnapshot.getId())).setParameter("resourceKey",resourceKey).setParameter("lib",Qualifiers.LIBRARY).setParameter("status",Snapshot.STATUS_PROCESSED);
  if (StringUtils.isNotBlank(path)) {
    q.setParameter("path",path);
  }
  return q.getResultList();
}
