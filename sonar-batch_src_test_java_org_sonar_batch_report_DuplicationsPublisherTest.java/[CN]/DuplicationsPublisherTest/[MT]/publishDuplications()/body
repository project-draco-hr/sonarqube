{
  DefaultDuplication dup1=new DefaultDuplication().setOriginBlock(new Duplication.Block("foo:src/Foo.php",1,10)).isDuplicatedBy("foo:src/Foo.php",20,50);
  DefaultDuplication dup2=new DefaultDuplication().setOriginBlock(new Duplication.Block("foo:src/Foo.php",11,10)).isDuplicatedBy("another",20,50);
  DefaultDuplication dup3=new DefaultDuplication().setOriginBlock(new Duplication.Block("foo:src/Foo.php",11,10)).isDuplicatedBy("foo:src/Foo2.php",20,50);
  when(duplicationCache.byComponent("foo:src/Foo.php")).thenReturn(Arrays.asList(dup1,dup2,dup3));
  File outputDir=temp.newFolder();
  BatchReportWriter writer=new BatchReportWriter(outputDir);
  publisher.publish(writer);
  BatchReportReader reader=new BatchReportReader(outputDir);
  assertThat(reader.readComponentDuplications(1)).hasSize(0);
  List<org.sonar.batch.protocol.output.BatchReport.Duplication> componentDuplications=reader.readComponentDuplications(2);
  assertThat(componentDuplications).hasSize(3);
  org.sonar.batch.protocol.output.BatchReport.Duplication savedDup1=componentDuplications.get(0);
  assertThat(savedDup1.getOriginBlock().hasComponentKey()).isFalse();
  assertThat(savedDup1.getOriginBlock().hasOtherComponentRef()).isFalse();
  assertThat(savedDup1.getOriginBlock().getStartLine()).isEqualTo(1);
  assertThat(savedDup1.getOriginBlock().getEndLine()).isEqualTo(10);
  assertThat(savedDup1.getDuplicatedBy(0).hasComponentKey()).isFalse();
  assertThat(savedDup1.getDuplicatedBy(0).hasOtherComponentRef()).isFalse();
  assertThat(savedDup1.getDuplicatedBy(0).getStartLine()).isEqualTo(20);
  assertThat(savedDup1.getDuplicatedBy(0).getEndLine()).isEqualTo(50);
  org.sonar.batch.protocol.output.BatchReport.Duplication savedDup2=componentDuplications.get(1);
  assertThat(savedDup2.getOriginBlock().hasComponentKey()).isFalse();
  assertThat(savedDup2.getOriginBlock().hasOtherComponentRef()).isFalse();
  assertThat(savedDup2.getOriginBlock().getStartLine()).isEqualTo(11);
  assertThat(savedDup2.getOriginBlock().getEndLine()).isEqualTo(20);
  assertThat(savedDup2.getDuplicatedBy(0).getComponentKey()).isEqualTo("another");
  assertThat(savedDup2.getDuplicatedBy(0).hasOtherComponentRef()).isFalse();
  assertThat(savedDup2.getDuplicatedBy(0).getStartLine()).isEqualTo(20);
  assertThat(savedDup2.getDuplicatedBy(0).getEndLine()).isEqualTo(50);
  org.sonar.batch.protocol.output.BatchReport.Duplication savedDup3=componentDuplications.get(2);
  assertThat(savedDup3.getOriginBlock().hasComponentKey()).isFalse();
  assertThat(savedDup3.getOriginBlock().hasOtherComponentRef()).isFalse();
  assertThat(savedDup3.getOriginBlock().getStartLine()).isEqualTo(11);
  assertThat(savedDup3.getOriginBlock().getEndLine()).isEqualTo(20);
  assertThat(savedDup3.getDuplicatedBy(0).hasComponentKey()).isFalse();
  assertThat(savedDup3.getDuplicatedBy(0).getOtherComponentRef()).isEqualTo(3);
  assertThat(savedDup3.getDuplicatedBy(0).getStartLine()).isEqualTo(20);
  assertThat(savedDup3.getDuplicatedBy(0).getEndLine()).isEqualTo(50);
}
