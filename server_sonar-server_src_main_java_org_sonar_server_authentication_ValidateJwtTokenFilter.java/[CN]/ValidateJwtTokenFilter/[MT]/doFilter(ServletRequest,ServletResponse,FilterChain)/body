{
  HttpServletRequest request=(HttpServletRequest)servletRequest;
  HttpServletResponse response=(HttpServletResponse)servletResponse;
  String path=request.getRequestURI().replaceFirst(request.getContextPath(),"");
  try {
    if (isDeprecatedBatchWs(path)) {
      chain.doFilter(request,response);
      return;
    }
    jwtHttpHandler.validateToken(request,response);
    if (!userSession.isLoggedIn() && settings.getBoolean(CORE_FORCE_AUTHENTICATION_PROPERTY)) {
      throw new UnauthorizedException("User must be authenticated");
    }
    chain.doFilter(request,response);
  }
 catch (  UnauthorizedException e) {
    jwtHttpHandler.removeToken(response);
    response.setStatus(HTTP_UNAUTHORIZED);
    if (isWsUrl(path)) {
      return;
    }
    chain.doFilter(request,response);
  }
}
