{
  checkPermission(userSession);
  QualityProfileDto profile=profileLookup.profile(profileId).toDto();
  QualityProfileDto parentProfile=null;
  if (parentId != null) {
    parentProfile=profileLookup.profile(parentId).toDto();
  }
  SqlSession session=myBatis.openSession();
  try {
    if (isCycle(profile,parentProfile,session)) {
      throw new BadRequestException("Please do not select a child profile as parent.");
    }
    String parentName=parentProfile != null ? parentProfile.getName() : null;
    ProfilesManager.RuleInheritanceActions actions=profilesManager.profileParentChanged(profile.getId(),parentName,userSession.name());
    ruleRegistry.deleteActiveRules(actions.idsToDelete());
    ruleRegistry.bulkIndexActiveRules(actions.idsToIndex(),session);
    profile.setParent(parentName);
    dao.update(profile,session);
    session.commit();
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
