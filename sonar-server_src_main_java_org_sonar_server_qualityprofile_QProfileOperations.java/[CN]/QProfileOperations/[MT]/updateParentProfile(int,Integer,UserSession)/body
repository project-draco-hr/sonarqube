{
  checkPermission(userSession);
  SqlSession session=myBatis.openSession();
  try {
    QualityProfileDto profile=findNotNull(profileId,session);
    QualityProfileDto parentProfile=null;
    if (parentId != null) {
      parentProfile=findNotNull(parentId,session);
    }
    if (isCycle(profile,parentProfile,session)) {
      throw new BadRequestException("Please do not select a child profile as parent.");
    }
    String newParentName=parentProfile != null ? parentProfile.getName() : null;
    ProfilesManager.RuleInheritanceActions actions=profilesManager.profileParentChanged(profile.getId(),newParentName,userSession.name());
    profile.setParent(newParentName);
    dao.update(profile,session);
    session.commit();
    ruleRegistry.deleteActiveRules(actions.idsToDelete());
    ruleRegistry.bulkIndexActiveRuleIds(actions.idsToIndex(),session);
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
