{
  checkPermission(userSession);
  SqlSession session=myBatis.openSession();
  try {
    checkNotAlreadyExists(name,language,session);
    NewProfileResult result=new NewProfileResult();
    List<RulesProfile> importProfiles=readProfilesFromXml(result,xmlProfilesByPlugin);
    QualityProfileDto dto=new QualityProfileDto().setName(name).setLanguage(language).setVersion(1).setUsed(false);
    dao.insert(dto,session);
    for (    RulesProfile rulesProfile : importProfiles) {
      importProfile(dto,rulesProfile,session);
    }
    result.setProfile(QProfile.from(dto));
    session.commit();
    dryRunCache.reportGlobalModification();
    return result;
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
