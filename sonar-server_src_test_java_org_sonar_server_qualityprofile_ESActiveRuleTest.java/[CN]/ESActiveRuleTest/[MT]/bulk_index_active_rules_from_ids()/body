{
  when(myBatis.openSession()).thenReturn(session);
  List<Integer> ids=newArrayList(1);
  when(activeRuleDao.selectByIds(ids,session)).thenReturn(newArrayList(new ActiveRuleDto().setId(1).setProfileId(10).setRuleId(1).setSeverity(Severity.MAJOR).setParentId(5)));
  when(activeRuleDao.selectParamsByActiveRuleIds(ids,session)).thenReturn(newArrayList(new ActiveRuleParamDto().setId(1).setActiveRuleId(1).setRulesParameterId(1).setKey("key").setValue("RuleWithParameters")));
  esActiveRule.bulkIndexActiveRules(ids);
  assertThat(esSetup.exists("rules","active_rule","1"));
  SearchHit[] parentHit=esSetup.client().prepareSearch("rules").setPostFilter(hasChildFilter("active_rule",termFilter("profileId",10))).execute().actionGet().getHits().getHits();
  assertThat(parentHit).hasSize(1);
  assertThat(parentHit[0].getId()).isEqualTo("1");
  SearchHit[] childHit=esSetup.client().prepareSearch("rules").setPostFilter(hasParentFilter("rule",termFilter("key","RuleWithParameters"))).execute().actionGet().getHits().getHits();
  assertThat(childHit).hasSize(1);
  assertThat(childHit[0].getId()).isEqualTo("1");
}
