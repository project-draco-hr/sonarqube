{
  Map<MeasureKey,Object[]> pastMeasuresByKey=Maps.newHashMap();
  for (  Object[] pastMeasure : pastMeasures) {
    pastMeasuresByKey.put(new MeasureKey(pastMeasure),pastMeasure);
  }
  for (  Measure measure : context.getMeasures(MeasuresFilters.all())) {
    Integer metricId=measure.getMetric().getId();
    if (metricId == null) {
      Metric metric=metricFinder.findByKey(measure.getMetric().getKey());
      if (metric == null) {
        throw new IllegalStateException("Unknow metric with key: " + measure.getMetric().getKey());
      }
      metricId=metric.getId();
    }
    Characteristic characteristic=measure.getCharacteristic();
    Integer characteristicId=characteristic != null ? characteristic.id() : null;
    Integer personId=measure.getPersonId();
    Integer ruleId=null;
    if (measure instanceof RuleMeasure) {
      Rule rule=ruleFinder.findByKey(((RuleMeasure)measure).ruleKey());
      if (rule != null) {
        ruleId=rule.getId();
      }
    }
    Object[] pastMeasure=pastMeasuresByKey.get(new MeasureKey(metricId,characteristicId,personId,ruleId));
    if (updateVariation(measure,pastMeasure,index)) {
      context.saveMeasure(measure);
    }
  }
}
