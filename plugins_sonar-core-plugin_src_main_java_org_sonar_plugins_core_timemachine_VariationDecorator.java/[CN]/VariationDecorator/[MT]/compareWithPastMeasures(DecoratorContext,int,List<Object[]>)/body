{
  Map<MeasureKey,Object[]> pastMeasuresByKey=Maps.newHashMap();
  for (  Object[] pastMeasure : pastMeasures) {
    pastMeasuresByKey.put(new MeasureKey(pastMeasure),pastMeasure);
  }
  for (  Measure measure : context.getMeasures(MeasuresFilters.all())) {
    Integer metricId=measure.getMetric().getId() != null ? measure.getMetric().getId() : metricFinder.findByKey(measure.getMetric().getKey()).getId();
    Characteristic characteristic=measure.getCharacteristic();
    Requirement requirement=measure.getRequirement();
    Integer characteristicId=characteristic != null ? characteristic.id() : requirement != null ? requirement.id() : null;
    Integer personId=measure.getPersonId();
    Integer ruleId=measure instanceof RuleMeasure ? ((RuleMeasure)measure).getRule().getId() : null;
    Object[] pastMeasure=pastMeasuresByKey.get(new MeasureKey(metricId,characteristicId,personId,ruleId));
    if (updateVariation(measure,pastMeasure,index)) {
      context.saveMeasure(measure);
    }
  }
}
