{
  Map<MeasureKey,Object[]> pastMeasuresByKey=Maps.newHashMap();
  for (  Object[] pastMeasure : pastMeasures) {
    pastMeasuresByKey.put(new MeasureKey(pastMeasure),pastMeasure);
  }
  for (  Measure measure : context.getMeasures(MeasuresFilters.all())) {
    Integer metricId=(measure.getMetric().getId() != null ? measure.getMetric().getId() : metricFinder.findByKey(measure.getMetric().getKey()).getId());
    Integer characteristicId=(measure.getCharacteristic() != null ? measure.getCharacteristic().getId() : null);
    Integer ruleId=(measure instanceof RuleMeasure ? ((RuleMeasure)measure).getRule().getId() : null);
    Integer severityId=(measure instanceof RuleMeasure ? ((RuleMeasure)measure).getRulePriority().ordinal() : null);
    Object[] pastMeasure=pastMeasuresByKey.get(new MeasureKey(metricId,characteristicId,ruleId,severityId));
    if (updateVariation(measure,pastMeasure,index)) {
      context.saveMeasure(measure);
    }
  }
}
