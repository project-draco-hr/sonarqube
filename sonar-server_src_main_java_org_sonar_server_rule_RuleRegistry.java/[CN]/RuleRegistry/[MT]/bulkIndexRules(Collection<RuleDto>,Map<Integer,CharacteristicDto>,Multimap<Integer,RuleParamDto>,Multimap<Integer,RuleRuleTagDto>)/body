{
  try {
    String[] ids=new String[rules.size()];
    BytesStream[] docs=new BytesStream[rules.size()];
    int index=0;
    TimeProfiler profiler=new TimeProfiler();
    profiler.start("Build rules documents");
    for (    RuleDto rule : rules) {
      ids[index]=rule.getId().toString();
      CharacteristicDto effectiveSubCharacteristic=characteristicsById.get(rule.getSubCharacteristicId() != null ? rule.getSubCharacteristicId() : rule.getDefaultSubCharacteristicId());
      CharacteristicDto effectiveCharacteristic=effectiveSubCharacteristic != null ? characteristicsById.get(effectiveSubCharacteristic.getParentId()) : null;
      docs[index]=ruleDocument(rule,effectiveCharacteristic,effectiveSubCharacteristic,paramsByRule.get(rule.getId()),tagsByRule.get(rule.getId()));
      index++;
    }
    profiler.stop();
    if (!rules.isEmpty()) {
      profiler.start("Index rules");
      searchIndex.bulkIndex(INDEX_RULES,TYPE_RULE,ids,docs);
      profiler.stop();
    }
    return ids;
  }
 catch (  IOException ioe) {
    throw new IllegalStateException("Unable to index rules",ioe);
  }
}
