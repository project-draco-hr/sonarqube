{
  SqlSession session=myBatis.openSession();
  try {
    TimeProfiler profiler=new TimeProfiler();
    profiler.start("Rebuilding active rules index - query");
    List<ActiveRuleDto> activeRules=activeRuleDao.selectAll(session);
    List<ActiveRuleParamDto> activeRuleParams=activeRuleDao.selectAllParams(session);
    profiler.stop();
    Multimap<Integer,ActiveRuleParamDto> paramsByActiveRule=ArrayListMultimap.create();
    for (    ActiveRuleParamDto param : activeRuleParams) {
      paramsByActiveRule.put(param.getActiveRuleId(),param);
    }
    String[] ids=bulkIndexActiveRules(activeRules,paramsByActiveRule);
    removeDeletedActiveRules(ids);
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
