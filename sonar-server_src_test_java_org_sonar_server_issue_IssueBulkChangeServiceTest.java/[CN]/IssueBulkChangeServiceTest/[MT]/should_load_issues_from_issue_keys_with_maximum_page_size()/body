{
  Map<String,Object> properties=newHashMap();
  properties.put("issues","ABCD,DEFG");
  properties.put("actions","assign");
  properties.put("assign.assignee","fred");
  when(action.supports(any(Issue.class))).thenReturn(true);
  when(action.execute(anyMap(),any(IssueBulkChangeService.ActionContext.class))).thenReturn(true);
  when(action.execute(eq(properties),any(IssueBulkChangeService.ActionContext.class))).thenReturn(true);
  IssueBulkChangeQuery issueBulkChangeQuery=new IssueBulkChangeQuery(properties);
  service.execute(issueBulkChangeQuery,userSession);
  ArgumentCaptor<IssueQuery> captor=ArgumentCaptor.forClass(IssueQuery.class);
  verify(finder).find(captor.capture());
  IssueQuery query=captor.getValue();
  assertThat(query.issueKeys()).containsOnly("ABCD","DEFG");
  assertThat(query.pageSize()).isEqualTo(IssueQuery.MAX_PAGE_SIZE);
  assertThat(query.requiredRole()).isEqualTo(UserRole.USER);
}
