{
  MockUserSession.set().setLogin("john").setGlobalPermissions(GlobalPermissions.SCAN_EXECUTION);
  ComponentDto project=ComponentTesting.newProjectDto();
  tester.get(DbClient.class).componentDao().insert(dbSession,project);
  SnapshotDto projectSnapshot=SnapshotTesting.createForProject(project);
  tester.get(DbClient.class).snapshotDao().insert(dbSession,projectSnapshot);
  addDefaultProfile();
  ComponentDto module=ComponentTesting.newModuleDto(project);
  tester.get(DbClient.class).componentDao().insert(dbSession,module);
  SnapshotDto moduleSnapshot=SnapshotTesting.createForComponent(module,projectSnapshot);
  tester.get(DbClient.class).snapshotDao().insert(dbSession,moduleSnapshot);
  ComponentDto subModule=ComponentTesting.newModuleDto(module);
  tester.get(DbClient.class).componentDao().insert(dbSession,subModule);
  tester.get(DbClient.class).snapshotDao().insert(dbSession,SnapshotTesting.createForComponent(subModule,moduleSnapshot));
  tester.get(DbClient.class).propertiesDao().setProperty(new PropertyDto().setKey("sonar.jira.project.key").setValue("SONAR").setResourceId(subModule.getId()),dbSession);
  tester.get(DbClient.class).propertiesDao().setProperty(new PropertyDto().setKey("sonar.jira.login.secured").setValue("john").setResourceId(subModule.getId()),dbSession);
  tester.get(DbClient.class).propertiesDao().setProperty(new PropertyDto().setKey("sonar.coverage.exclusions").setValue("**/*.java").setResourceId(subModule.getId()),dbSession);
  dbSession.commit();
  ProjectReferentials ref=loader.load(ProjectReferentialsQuery.create().setModuleKey(subModule.key()));
  assertThat(ref.settings(project.key())).isEmpty();
  assertThat(ref.settings(module.key())).isEmpty();
  assertThat(ref.settings(subModule.key())).isEqualTo(ImmutableMap.of("sonar.jira.project.key","SONAR","sonar.jira.login.secured","john","sonar.coverage.exclusions","**/*.java"));
}
