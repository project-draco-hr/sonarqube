{
  DbSession session=mybatis.openSession(true);
  ResourceKeyUpdaterMapper mapper=session.getMapper(ResourceKeyUpdaterMapper.class);
  try {
    if (mapper.countResourceByKey(newKey) > 0) {
      throw new IllegalStateException("Impossible to update key: a resource with \"" + newKey + "\" key already exists.");
    }
    ResourceDto project=mapper.selectProject(projectId);
    String projectOldKey=project.getKey();
    List<ResourceDto> resources=mapper.selectProjectResources(projectId);
    resources.add(project);
    runBatchUpdateForAllResources(resources,projectOldKey,newKey,mapper);
    session.commit();
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
