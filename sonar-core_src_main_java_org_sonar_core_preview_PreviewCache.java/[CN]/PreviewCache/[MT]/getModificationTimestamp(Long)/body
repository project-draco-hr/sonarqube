{
  if (projectId == null) {
    PropertyDto dto=propertiesDao.selectGlobalProperty(SONAR_PREVIEW_CACHE_LAST_UPDATE_KEY);
    if (dto == null) {
      return 0;
    }
    return Long.valueOf(dto.getValue());
  }
  ResourceDto rootProject=resourceDao.getRootProjectByComponentId(projectId);
  if (rootProject == null) {
    throw new SonarException("Unable to find root project for project with [id=" + projectId + "]");
  }
  PropertyDto dto=propertiesDao.selectProjectProperty(rootProject.getId(),SONAR_PREVIEW_CACHE_LAST_UPDATE_KEY);
  if (dto == null) {
    return 0;
  }
  return Long.valueOf(dto.getValue());
}
