{
  DbSession dbSession=dbClient.openSession(false);
  try {
    String snapshotId=request.getAnalysisId();
    SnapshotDto snapshotDto=getSnapshot(dbSession,snapshotId);
    ComponentDto projectDto=dbClient.componentDao().selectOrFailById(dbSession,snapshotDto.getComponentId());
    checkPermission(projectDto.uuid());
    String measureData=getQualityGateDetailsMeasureData(dbSession,snapshotDto);
    return ProjectStatusWsResponse.newBuilder().setProjectStatus(new QualityGateDetailsFormatter(measureData,snapshotDto).format()).build();
  }
  finally {
    dbClient.closeSession(dbSession);
  }
}
