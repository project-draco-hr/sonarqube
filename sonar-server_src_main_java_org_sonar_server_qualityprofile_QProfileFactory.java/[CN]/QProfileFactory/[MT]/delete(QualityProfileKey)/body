{
  DbSession session=db.openSession(false);
  try {
    QualityProfileDto profile=db.qualityProfileDao().getNonNullByKey(session,key);
    List<QualityProfileDto> descendants=db.qualityProfileDao().findDescendants(session,key);
    QualityProfileDto defaultProfile=getDefault(session,profile.getLanguage());
    checkNotDefault(defaultProfile,profile);
    for (    QualityProfileDto descendant : descendants) {
      checkNotDefault(defaultProfile,descendant);
    }
    for (    QualityProfileDto descendant : Lists.reverse(descendants)) {
      doDelete(session,descendant);
    }
    doDelete(session,profile);
    previewCache.reportGlobalModification(session);
    session.commit();
  }
  finally {
    session.close();
  }
}
