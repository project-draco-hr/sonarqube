{
  if (review.getReviewId() == null) {
    LOG.error("Review has no id. Violation id is: " + review.getViolationId());
    return;
  }
  SqlSession session=mybatis.openSession();
  ReviewMapper mapper=session.getMapper(ReviewMapper.class);
  ReviewCommentMapper commentMapper=session.getMapper(ReviewCommentMapper.class);
  try {
    ReviewDto dto=mapper.findById(review.getReviewId());
    dto.setResolution(review.getResolution());
    dto.setStatus(review.getStatus());
    dto.setData(KeyValueFormat.format(review.getProperties()));
    dto.setUpdatedAt(now);
    mapper.update(dto);
    for (    Comment comment : review.getNewComments()) {
      ReviewCommentDto commentDto=new ReviewCommentDto();
      commentDto.setReviewId(dto.getId());
      commentDto.setText(comment.getMarkdownText());
      commentDto.setCreatedAt(now);
      commentDto.setUpdatedAt(now);
      commentDto.setUserId(comment.getUserId());
      commentMapper.insert(commentDto);
    }
    session.commit();
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
