{
  RuleDto templateRule=RuleTesting.newTemplateRule(RuleKey.of("xoo","T1")).setLanguage("xoo");
  dao.insert(dbSession,templateRule);
  RuleDto customRule=RuleTesting.newCustomRule(templateRule).setLanguage("xoo");
  dao.insert(dbSession,customRule);
  QualityProfileDto profileDto=QProfileTesting.newXooP1();
  db.qualityProfileDao().insert(dbSession,profileDto);
  dbSession.commit();
  dbSession.clearCache();
  activate(new RuleActivation(customRule.getKey()).setSeverity(Severity.BLOCKER),QProfileTesting.XOO_P1_KEY);
  deleter.delete(customRule.getKey());
  Rule customRuleReloaded=index.getByKey(customRule.getKey());
  assertThat(customRuleReloaded).isNotNull();
  assertThat(customRuleReloaded.status()).isEqualTo(RuleStatus.REMOVED);
  List<ActiveRule> activeRules=Lists.newArrayList(tester.get(ActiveRuleIndex.class).findByProfile(profileDto.getKey()));
  assertThat(activeRules).isEmpty();
}
