{
  ComponentDto project1=ComponentTesting.newProjectDto().setKey("project1");
  ComponentDto project2=ComponentTesting.newProjectDto().setKey("project2");
  ComponentDto project3=ComponentTesting.newProjectDto().setKey("project3");
  ComponentDto file1=ComponentTesting.newFileDto(project1).setKey("file1");
  ComponentDto file2=ComponentTesting.newFileDto(project2).setKey("file2");
  ComponentDto file3=ComponentTesting.newFileDto(project3).setKey("file3");
  indexIssue(IssueTesting.newDoc("ISSUE1",file1),"sonar-users",null);
  indexIssue(IssueTesting.newDoc("ISSUE2",file2),"sonar-admins",null);
  indexIssue(IssueTesting.newDoc("ISSUE3",file3),null,null);
  MockUserSession.set().setUserGroups("sonar-users");
  assertThat(index.search(IssueQuery.builder().build(),new SearchOptions()).getDocs()).hasSize(1);
  MockUserSession.set().setUserGroups("sonar-admins");
  assertThat(index.search(IssueQuery.builder().build(),new SearchOptions()).getDocs()).hasSize(1);
  MockUserSession.set().setUserGroups("sonar-users","sonar-admins");
  assertThat(index.search(IssueQuery.builder().build(),new SearchOptions()).getDocs()).hasSize(2);
  MockUserSession.set().setUserGroups("another group");
  assertThat(index.search(IssueQuery.builder().build(),new SearchOptions()).getDocs()).isEmpty();
  MockUserSession.set().setUserGroups("sonar-users","sonar-admins");
  assertThat(index.search(IssueQuery.builder().projectUuids(newArrayList(project3.uuid())).build(),new SearchOptions()).getDocs()).isEmpty();
}
