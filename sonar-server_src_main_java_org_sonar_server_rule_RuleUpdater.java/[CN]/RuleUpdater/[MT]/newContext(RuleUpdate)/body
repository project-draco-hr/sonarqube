{
  DbSession dbSession=dbClient.openSession(false);
  try {
    Context context=new Context();
    context.rule=dbClient.ruleDao().getNonNullByKey(dbSession,change.getRuleKey());
    if (RuleStatus.REMOVED == context.rule.getStatus()) {
      throw new IllegalArgumentException("Rule with REMOVED status cannot be updated: " + change.getRuleKey());
    }
    if (change.getDebtSubCharacteristicKey() != null && !change.getDebtSubCharacteristicKey().equals(RuleUpdate.DEFAULT_DEBT_CHARACTERISTIC)) {
      CharacteristicDto characteristicDto=dbClient.debtCharacteristicDao().selectByKey(change.getDebtSubCharacteristicKey(),dbSession);
      if (characteristicDto == null) {
        throw new IllegalArgumentException("Unknown debt sub-characteristic: " + change.getDebtSubCharacteristicKey());
      }
      if (!characteristicDto.isEnabled()) {
        throw new IllegalArgumentException("Debt sub-characteristic is disabled: " + change.getDebtSubCharacteristicKey());
      }
      if (characteristicDto.getParentId() == null) {
        throw new IllegalArgumentException("Not a sub-characteristic: " + change.getDebtSubCharacteristicKey());
      }
      context.newCharacteristic=characteristicDto;
    }
    return context;
  }
  finally {
    dbSession.close();
  }
}
