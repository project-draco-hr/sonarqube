{
  String conditions=" WHERE status!='CLOSED' AND resource_id=" + resourceId + " AND manual_violation=:manualViolation AND rule_failure_permanent_id NOT IN "+ "(SELECT permanent_id FROM rule_failures WHERE snapshot_id="+ snapshotId+ " AND permanent_id IS NOT NULL)";
  List<Review> reviews=databaseSession.getEntityManager().createNativeQuery("SELECT * FROM reviews " + conditions,Review.class).setParameter("manualViolation",false).getResultList();
  for (  Review review : reviews) {
    notifyClosed(resource,review);
  }
  int rowUpdated=databaseSession.createNativeQuery("UPDATE reviews SET status='CLOSED', updated_at=CURRENT_TIMESTAMP" + conditions).setParameter("manualViolation",false).executeUpdate();
  LOG.debug("- {} reviews set to 'closed' on resource #{}",rowUpdated,resourceId);
  return rowUpdated;
}
