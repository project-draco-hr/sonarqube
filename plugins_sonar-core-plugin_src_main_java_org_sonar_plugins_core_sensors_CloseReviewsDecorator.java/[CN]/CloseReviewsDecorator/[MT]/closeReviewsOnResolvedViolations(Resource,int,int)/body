{
  String conditions=" WHERE resource_id=" + resourceId + " AND "+ "( "+ "  ( "+ "    manual_violation=:automaticViolation AND status!='CLOSED' AND "+ "    rule_failure_permanent_id NOT IN (SELECT permanent_id FROM rule_failures WHERE snapshot_id="+ snapshotId+ " AND permanent_id IS NOT NULL)"+ "  )"+ "  OR "+ "  (manual_violation=:manualViolation AND status='RESOLVED')"+ ")";
  List<Review> reviews=databaseSession.getEntityManager().createNativeQuery("SELECT * FROM reviews " + conditions,Review.class).setParameter("automaticViolation",false).setParameter("manualViolation",true).getResultList();
  for (  Review review : reviews) {
    notifyClosed(resource,review);
  }
  int rowUpdated=databaseSession.createNativeQuery("UPDATE reviews SET status='CLOSED', updated_at=CURRENT_TIMESTAMP" + conditions).setParameter("automaticViolation",false).setParameter("manualViolation",true).executeUpdate();
  if (rowUpdated > 0) {
    LOG.debug("- {} reviews closed on #{}",rowUpdated,resourceId);
  }
  return rowUpdated;
}
