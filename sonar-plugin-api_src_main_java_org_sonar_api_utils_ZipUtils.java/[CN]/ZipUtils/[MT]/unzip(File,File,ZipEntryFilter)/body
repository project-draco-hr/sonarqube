{
  if (!toDir.exists()) {
    FileUtils.forceMkdir(toDir);
  }
  ZipFile zipFile=new ZipFile(zip);
  try {
    Enumeration<? extends ZipEntry> entries=zipFile.entries();
    while (entries.hasMoreElements()) {
      ZipEntry entry=entries.nextElement();
      if (filter.accept(entry)) {
        File to=new File(toDir,entry.getName());
        if (entry.isDirectory()) {
          if (!to.exists() && !to.mkdirs()) {
            throw new IOException(ERROR_CREATING_DIRECTORY + to);
          }
        }
 else {
          File parent=to.getParentFile();
          if (parent != null && !parent.exists() && !parent.mkdirs()) {
            throw new IOException(ERROR_CREATING_DIRECTORY + parent);
          }
          copy(zipFile,entry,to);
        }
      }
    }
    return toDir;
  }
  finally {
    zipFile.close();
  }
}
