{
  checkGlobalAdminUser(userSession);
  String permission=wsRequest.mandatoryParam(PARAM_PERMISSION);
  WsGroupRef group=WsGroupRef.fromPermissionRequest(wsRequest);
  DbSession dbSession=dbClient.openSession(false);
  try {
    validateProjectPermission(permission);
    validateNotAnyoneAndAdminPermission(permission,group.name());
    PermissionTemplateDto template=dependenciesFinder.getTemplate(dbSession,WsTemplateRef.fromRequest(wsRequest));
    GroupDto groupDto=dependenciesFinder.getGroup(dbSession,group);
    if (!groupAlreadyAdded(dbSession,template.getId(),groupDto,permission)) {
      Long groupId=groupDto == null ? null : groupDto.getId();
      dbClient.permissionTemplateDao().insertGroupPermission(dbSession,template.getId(),groupId,permission);
    }
  }
  finally {
    dbClient.closeSession(dbSession);
  }
  wsResponse.noContent();
}
