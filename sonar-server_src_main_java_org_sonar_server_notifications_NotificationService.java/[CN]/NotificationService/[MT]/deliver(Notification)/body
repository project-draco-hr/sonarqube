{
  Logs.INFO.debug("Delivering notification " + notification);
  SetMultimap<String,NotificationChannel> recipients=HashMultimap.create();
  for (  NotificationChannel channel : channels) {
    for (    NotificationDispatcher dispatcher : dispatchers) {
      final Set<String> possibleRecipients=Sets.newHashSet();
      NotificationDispatcher.Context context=new NotificationDispatcher.Context(){
        public void addUser(        String username){
          if (username != null) {
            possibleRecipients.add(username);
          }
        }
      }
;
      try {
        dispatcher.dispatch(notification,context);
      }
 catch (      Exception e) {
        Logs.INFO.warn("Unable to dispatch notification " + notification + " using "+ dispatcher,e);
      }
      for (      String username : possibleRecipients) {
        if (isEnabled(username,channel,dispatcher)) {
          recipients.put(username,channel);
        }
      }
    }
  }
  for (  Map.Entry<String,Collection<NotificationChannel>> entry : recipients.asMap().entrySet()) {
    String username=entry.getKey();
    Collection<NotificationChannel> userChannels=entry.getValue();
    Logs.INFO.debug("For user {} via {}",username,userChannels);
    for (    NotificationChannel channel : userChannels) {
      try {
        channel.deliver(notification,username);
      }
 catch (      Exception e) {
        Logs.INFO.warn("Unable to deliver notification " + notification + " for user "+ username+ " via "+ channel,e);
      }
    }
  }
}
