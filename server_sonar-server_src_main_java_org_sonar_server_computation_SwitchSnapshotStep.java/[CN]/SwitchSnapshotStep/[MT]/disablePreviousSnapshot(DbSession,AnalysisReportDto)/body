{
  SnapshotDto referenceSnapshot;
  try {
    referenceSnapshot=dao.getByKey(session,report.getSnapshotId());
  }
 catch (  Exception exception) {
    throw new IllegalStateException(String.format("Unexpected error while trying to retrieve snapshot of analysis %s",report),exception);
  }
  List<SnapshotDto> snapshots=dao.findSnapshotAndChildrenOfProjectScope(session,referenceSnapshot);
  for (  SnapshotDto snapshot : snapshots) {
    SnapshotDto previousLastSnapshot=dao.getLastSnapshot(session,snapshot);
    if (previousLastSnapshot != null) {
      dao.updateSnapshotAndChildrenLastFlag(session,previousLastSnapshot,false);
      session.commit();
    }
  }
}
