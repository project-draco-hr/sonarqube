{
  Snapshot snapshot=new Snapshot();
  snapshot.setId(100);
  snapshot.setResourceId(200);
  snapshots.put("org/struts/Action.java",snapshot);
  Issue issue=new DefaultIssue().setKey("ABCD").setComponentKey("org/struts/Action.java").setRuleRepositoryKey("squid").setRuleKey("NullDef").setNew(false).setStatus(Issue.STATUS_CLOSED).setSeverity(Issue.SEVERITY_BLOCKER).setCreatedAt(DateUtils.parseDate("2013-05-18")).setUpdatedAt(DateUtils.parseDate("2013-05-23"));
  when(issues.componentIssues("org/struts/Action.java")).thenReturn(newArrayList(issue));
  when(ruleFinder.findByKey("squid","NullDef")).thenReturn(null);
  try {
    persister.persist();
    fail();
  }
 catch (  IllegalStateException e) {
    assertThat(e).hasMessage("Rule not found: squid:NullDef");
  }
}
