{
  Issue issue=new DefaultIssue().setComponentKey("componentKey").setRuleRepositoryKey("repoKey").setRuleKey("ruleKey").setNew(true);
  when(issueCache.issues()).thenReturn(newArrayList(issue));
  Snapshot snapshot=mock(Snapshot.class);
  when(snapshotCache.get("componentKey")).thenReturn(snapshot);
  Rule rule=Rule.create("repoKey","ruleKey");
  when(ruleFinder.findByKey("repoKey","ruleKey")).thenReturn(rule);
  issuePersister.persist();
  verify(dao).insert(any(IssueDto.class));
}
