{
  if (!lifecycle.tryToMoveTo(Lifecycle.State.STARTING)) {
    throw new IllegalStateException("Already started");
  }
  monitored=mp;
  Logger logger=LoggerFactory.getLogger(getClass());
  try {
    logger.info("Starting " + getKey());
    Runtime.getRuntime().addShutdownHook(shutdownHook);
    stopWatcher.start();
    monitored.start();
    boolean up=false;
    while (!up) {
      up=monitored.isUp();
      Thread.sleep(20L);
    }
    String jmxUrl=guessJmxUrl();
    logger.debug("JMX URL is {}",jmxUrl);
    commands.setJmxUrl(jmxUrl);
    commands.setUp();
    if (lifecycle.tryToMoveTo(Lifecycle.State.STARTED)) {
      monitored.awaitStop();
    }
  }
 catch (  Exception e) {
    logger.warn("Fail to start " + getKey(),e);
  }
 finally {
    stop();
  }
}
