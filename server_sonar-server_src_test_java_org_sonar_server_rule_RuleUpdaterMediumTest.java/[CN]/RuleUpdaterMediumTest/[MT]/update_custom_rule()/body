{
  RuleDto templateRule=RuleTesting.newTemplateRule(RuleKey.of("java","S001"));
  ruleDao.insert(dbSession,templateRule);
  RuleParamDto templateRuleParam1=RuleParamDto.createFor(templateRule).setName("regex").setType("STRING").setDescription("Reg ex").setDefaultValue(".*");
  RuleParamDto templateRuleParam2=RuleParamDto.createFor(templateRule).setName("format").setType("STRING").setDescription("Format");
  ruleDao.insertRuleParam(dbSession,templateRule,templateRuleParam1);
  ruleDao.insertRuleParam(dbSession,templateRule,templateRuleParam2);
  RuleDto customRule=RuleTesting.newCustomRule(templateRule).setName("Old name").setDescription("Old description").setSeverity(Severity.MINOR).setStatus(RuleStatus.BETA);
  ruleDao.insert(dbSession,customRule);
  ruleDao.insertRuleParam(dbSession,customRule,templateRuleParam1.setDefaultValue("a.*"));
  ruleDao.insertRuleParam(dbSession,customRule,templateRuleParam2.setDefaultValue(null));
  dbSession.commit();
  RuleUpdate update=RuleUpdate.createForCustomRule(customRule.getKey()).setName("New name").setMarkdownDescription("New description").setSeverity("MAJOR").setStatus(RuleStatus.READY).setParameters(ImmutableMap.of("regex","b.*"));
  underTest.update(update,userSessionRule);
  dbSession.clearCache();
  RuleDto customRuleReloaded=ruleDao.selectOrFailByKey(dbSession,customRule.getKey());
  assertThat(customRuleReloaded).isNotNull();
  assertThat(customRuleReloaded.getName()).isEqualTo("New name");
  assertThat(customRuleReloaded.getDescription()).isEqualTo("New description");
  assertThat(customRuleReloaded.getSeverityString()).isEqualTo("MAJOR");
  assertThat(customRuleReloaded.getStatus()).isEqualTo(RuleStatus.READY);
  List<RuleParamDto> params=ruleDao.selectRuleParamsByRuleKey(dbSession,customRuleReloaded.getKey());
  assertThat(params).hasSize(2);
  assertThat(params.get(0).getDefaultValue()).isEqualTo("b.*");
  assertThat(params.get(1).getDefaultValue()).isNull();
  assertThat(ruleIndex.search(new RuleQuery().setQueryText("New name"),new SearchOptions()).getIds()).containsOnly(customRule.getKey());
  assertThat(ruleIndex.search(new RuleQuery().setQueryText("New description"),new SearchOptions()).getIds()).containsOnly(customRule.getKey());
  assertThat(ruleIndex.search(new RuleQuery().setQueryText("Old name"),new SearchOptions()).getTotal()).isZero();
  assertThat(ruleIndex.search(new RuleQuery().setQueryText("Old description"),new SearchOptions()).getTotal()).isZero();
}
