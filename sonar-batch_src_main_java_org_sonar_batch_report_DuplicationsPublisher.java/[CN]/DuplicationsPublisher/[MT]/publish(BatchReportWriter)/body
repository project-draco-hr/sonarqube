{
  for (  final BatchComponent resource : resourceCache.all()) {
    if (!resource.isFile()) {
      continue;
    }
    Iterable<DefaultDuplication> dups=duplicationCache.byComponent(resource.resource().getEffectiveKey());
    if (dups.iterator().hasNext()) {
      Iterable<org.sonar.batch.protocol.output.BatchReport.Duplication> reportDuplications=Iterables.transform(dups,new Function<DefaultDuplication,BatchReport.Duplication>(){
        private final BatchReport.Duplication.Builder dupBuilder=BatchReport.Duplication.newBuilder();
        private final BatchReport.Duplicate.Builder blockBuilder=BatchReport.Duplicate.newBuilder();
        @Override public BatchReport.Duplication apply(        DefaultDuplication input){
          return toReportDuplication(resource.key(),dupBuilder,blockBuilder,input);
        }
      }
);
      writer.writeComponentDuplications(resource.batchId(),reportDuplications);
    }
  }
}
