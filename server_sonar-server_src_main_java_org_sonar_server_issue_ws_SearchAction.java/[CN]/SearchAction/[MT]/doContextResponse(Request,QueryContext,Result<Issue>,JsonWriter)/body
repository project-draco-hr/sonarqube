{
  List<String> issueKeys=newArrayList();
  Set<RuleKey> ruleKeys=newHashSet();
  Set<String> projectUuids=newHashSet();
  Set<String> componentUuids=newHashSet();
  Set<String> actionPlanKeys=newHashSet();
  List<String> userLogins=newArrayList();
  Map<String,User> usersByLogin=newHashMap();
  Map<String,ComponentDto> componentsByUuid=newHashMap();
  Multimap<String,DefaultIssueComment> commentsByIssues=ArrayListMultimap.create();
  Collection<ComponentDto> componentDtos=newHashSet();
  List<ComponentDto> projectDtos=newArrayList();
  Map<String,ComponentDto> projectsByComponentUuid=newHashMap();
  for (  Issue issue : result.getHits()) {
    IssueDoc issueDoc=(IssueDoc)issue;
    issueKeys.add(issue.key());
    ruleKeys.add(issue.ruleKey());
    projectUuids.add(issueDoc.projectUuid());
    componentUuids.add(issueDoc.componentUuid());
    actionPlanKeys.add(issue.actionPlanKey());
    if (issue.reporter() != null) {
      userLogins.add(issue.reporter());
    }
    if (issue.assignee() != null) {
      userLogins.add(issue.assignee());
    }
  }
  Collection<FacetValue> facetRules=result.getFacetValues(IssueFilterParameters.RULES);
  if (facetRules != null) {
    for (    FacetValue rule : facetRules) {
      ruleKeys.add(RuleKey.parse(rule.getKey()));
    }
  }
  List<String> rulesFromRequest=request.paramAsStrings(IssueFilterParameters.RULES);
  if (rulesFromRequest != null) {
    for (    String ruleKey : rulesFromRequest) {
      ruleKeys.add(RuleKey.parse(ruleKey));
    }
  }
  collectFacetKeys(result,IssueFilterParameters.PROJECT_UUIDS,projectUuids);
  collectParameterValues(request,IssueFilterParameters.PROJECT_UUIDS,projectUuids);
  collectFacetKeys(result,IssueFilterParameters.COMPONENT_UUIDS,componentUuids);
  collectParameterValues(request,IssueFilterParameters.COMPONENT_UUIDS,componentUuids);
  collectParameterValues(request,IssueFilterParameters.COMPONENT_ROOT_UUIDS,componentUuids);
  collectFacetKeys(result,IssueFilterParameters.ASSIGNEES,userLogins);
  collectParameterValues(request,IssueFilterParameters.ASSIGNEES,userLogins);
  collectFacetKeys(result,IssueFilterParameters.REPORTERS,userLogins);
  collectParameterValues(request,IssueFilterParameters.REPORTERS,userLogins);
  collectFacetKeys(result,IssueFilterParameters.ACTION_PLANS,actionPlanKeys);
  collectParameterValues(request,IssueFilterParameters.ACTION_PLANS,actionPlanKeys);
  UserSession userSession=UserSession.get();
  if (userSession.isLoggedIn()) {
    userLogins.add(userSession.login());
  }
  DbSession session=dbClient.openSession(false);
  try {
    List<DefaultIssueComment> comments=issueChangeDao.selectCommentsByIssues(session,issueKeys);
    for (    DefaultIssueComment issueComment : comments) {
      userLogins.add(issueComment.userLogin());
      commentsByIssues.put(issueComment.issueKey(),issueComment);
    }
    usersByLogin=getUsersByLogin(userLogins);
    List<ComponentDto> fileDtos=dbClient.componentDao().getByUuids(session,componentUuids);
    List<ComponentDto> subProjectDtos=dbClient.componentDao().findSubProjectsByComponentUuids(session,componentUuids);
    componentDtos.addAll(fileDtos);
    componentDtos.addAll(subProjectDtos);
    for (    ComponentDto component : componentDtos) {
      projectUuids.add(component.projectUuid());
    }
    projectDtos=dbClient.componentDao().getByUuids(session,projectUuids);
    componentDtos.addAll(projectDtos);
    for (    ComponentDto componentDto : componentDtos) {
      componentsByUuid.put(componentDto.uuid(),componentDto);
    }
    projectsByComponentUuid=getProjectsByComponentUuid(componentDtos,projectDtos);
    writeProjects(json,projectDtos);
    writeComponents(json,componentDtos,projectsByComponentUuid);
  }
  finally {
    session.close();
  }
  Map<String,ActionPlan> actionPlanByKeys=getActionPlanByKeys(actionPlanKeys);
  writeIssues(result,commentsByIssues,usersByLogin,actionPlanByKeys,componentsByUuid,projectsByComponentUuid,request.paramAsStrings(EXTRA_FIELDS_PARAM),json);
  writeRules(json,!request.mandatoryParamAsBoolean(IssueFilterParameters.HIDE_RULES) ? ruleService.getByKeys(ruleKeys) : Collections.<Rule>emptyList());
  writeUsers(json,usersByLogin);
  writeActionPlans(json,actionPlanByKeys.values());
  writeLanguages(json);
  writeLegacyPaging(context,json,result);
}
