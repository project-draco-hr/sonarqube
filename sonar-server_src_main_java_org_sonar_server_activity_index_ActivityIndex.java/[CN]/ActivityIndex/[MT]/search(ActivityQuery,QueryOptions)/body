{
  SearchRequestBuilder esSearch=getClient().prepareSearch(this.getIndexName()).setTypes(this.getIndexType()).setIndices(this.getIndexName());
  AndFilterBuilder filter=FilterBuilders.andFilter();
  OrFilterBuilder typeFilter=FilterBuilders.orFilter();
  for (  Activity.Type type : query.getTypes()) {
    typeFilter.add(FilterBuilders.termFilter(ActivityNormalizer.LogFields.TYPE.field(),type));
  }
  filter.add(typeFilter);
  if (query.getSince() != null || query.getTo() != null) {
    RangeFilterBuilder dateFilter=FilterBuilders.rangeFilter(ActivityNormalizer.LogFields.CREATED_AT.field());
    if (query.getSince() != null) {
      dateFilter.from(query.getSince());
    }
    if (query.getTo() != null) {
      dateFilter.to(query.getTo());
    }
    filter.add(dateFilter);
  }
  esSearch.setQuery(QueryBuilders.filteredQuery(QueryBuilders.matchAllQuery(),filter));
  if (options.isScroll()) {
    esSearch.setSearchType(SearchType.SCAN);
    esSearch.setScroll(TimeValue.timeValueMinutes(3));
  }
  SearchResponse esResult=esSearch.get();
  return new Result<Activity>(this,esResult);
}
