{
  when(project.getAnalysisDate()).thenReturn(DateUtils.parseDate("2013-05-18"));
  when(issueCache.all()).thenReturn(Arrays.asList(new DefaultIssue().setNew(true).setSeverity("MAJOR"),new DefaultIssue().setNew(false).setSeverity("MINOR")));
  SendIssueNotificationsPostJob job=new SendIssueNotificationsPostJob(issueCache,notifications,ruleFinder);
  job.executeOn(project,sensorContext);
  ArgumentCaptor<IssuesBySeverity> argument=ArgumentCaptor.forClass(IssuesBySeverity.class);
  verify(notifications).sendNewIssues(eq(project),argument.capture());
  assertThat(argument.getValue().size()).isEqualTo(1);
}
