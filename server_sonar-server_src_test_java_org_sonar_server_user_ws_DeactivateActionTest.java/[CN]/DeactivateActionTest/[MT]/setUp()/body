{
  dbTester.truncateTables();
  esTester.truncateIndices();
  System2 system2=new System2();
  UserDao userDao=new UserDao(dbTester.myBatis(),system2);
  dbClient=new DbClient(dbTester.database(),dbTester.myBatis(),userDao,new GroupMembershipDao(dbTester.myBatis()));
  session=dbClient.openSession(false);
  session.commit();
  userIndexer=(UserIndexer)new UserIndexer(dbClient,esTester.client()).setEnabled(true);
  index=new UserIndex(esTester.client());
  tester=new WsTester(new UsersWs(new DeactivateAction(index,new UserUpdater(mock(NewUserNotifier.class),settings,dbClient,userIndexer,system2,mock(SecurityRealmFactory.class)),userSessionRule,new UserJsonWriter(userSessionRule),dbClient)));
  controller=tester.controller("api/users");
}
