{
  ComponentDto project=new ComponentDto().setId(1L).setKey("MyProject").setProjectId(1L);
  db.componentDao().insert(session,project);
  tester.get(PermissionFacade.class).insertGroupPermission(project.getId(),DefaultGroups.ANYONE,UserRole.USER,session);
  db.issueAuthorizationDao().synchronizeAfter(session,new Date(0));
  ComponentDto resource=new ComponentDto().setProjectId(1L).setKey("MyComponent").setId(2L);
  db.componentDao().insert(session,resource);
  db.snapshotDao().insert(session,SnapshotTesting.createForComponent(resource));
  RuleDto rule=RuleTesting.newXooX1();
  tester.get(RuleDao.class).insert(session,rule);
  IssueDto issue=new IssueDto().setIssueCreationDate(DateUtils.parseDate("2014-09-04")).setIssueUpdateDate(DateUtils.parseDate("2014-12-04")).setRule(rule).setDebt(10L).setRootComponent(project).setComponent(resource).setStatus("OPEN").setResolution("OPEN").setKee("82fd47d4-b650-4037-80bc-7b112bd4eac2").setSeverity("MAJOR");
  db.issueDao().insert(session,issue);
  session.commit();
  clearIssueIndex();
  assertThat(db.issueDao().getByKey(session,issue.getKey())).isNotNull();
  assertThat(tester.get(IssueIndex.class).getNullableByKey(issue.getKey())).isNull();
  MockUserSession.set().setLogin("john").setGlobalPermissions(GlobalPermissions.SCAN_EXECUTION);
  WsTester.TestRequest request=wsTester.newGetRequest(BatchWs.API_ENDPOINT,UploadReportAction.UPLOAD_REPORT_ACTION);
  request.setParam(UploadReportAction.PARAM_PROJECT,project.key());
  request.execute();
  assertThat(tester.get(IssueIndex.class).getNullableByKey(issue.getKey())).isNotNull();
}
