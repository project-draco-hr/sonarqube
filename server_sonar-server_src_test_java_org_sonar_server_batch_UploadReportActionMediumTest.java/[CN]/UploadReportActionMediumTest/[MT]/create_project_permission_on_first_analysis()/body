{
  tester.get(Platform.class).executeStartupTasks();
  ComponentDto project=new ComponentDto().setId(1L).setKey("MyProject").setProjectId(1L);
  db.componentDao().insert(session,project);
  session.commit();
  MockUserSession.set().setLogin("john").setGlobalPermissions(GlobalPermissions.SCAN_EXECUTION);
  assertThat(tester.get(PermissionFinder.class).findGroupsWithPermission(PermissionQuery.builder().component(project.key()).permission(UserRole.USER).build()).groups().get(0).hasPermission()).isFalse();
  WsTester.TestRequest request=wsTester.newGetRequest(BatchWs.API_ENDPOINT,UploadReportAction.UPLOAD_REPORT_ACTION);
  request.setParam(UploadReportAction.PARAM_PROJECT,project.key());
  request.setParam(UploadReportAction.PARAM_FIRST_ANALYSIS,"true");
  request.execute();
  assertThat(tester.get(PermissionFinder.class).findGroupsWithPermission(PermissionQuery.builder().component(project.key()).permission(UserRole.USER).build()).groups()).hasSize(1);
  assertThat(tester.get(PermissionFinder.class).findGroupsWithPermission(PermissionQuery.builder().component(project.key()).permission(UserRole.USER).build()).groups().get(0).hasPermission()).isTrue();
  assertThat(tester.get(IssueAuthorizationIndex.class).getByKey(project.getKey())).isNotNull();
}
