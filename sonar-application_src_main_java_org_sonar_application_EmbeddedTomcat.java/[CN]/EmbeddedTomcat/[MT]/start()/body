{
  if (tomcat != null || hook != null) {
    throw new IllegalStateException("Server is already started");
  }
  System.setProperty("org.apache.tomcat.util.buf.UDecoder.ALLOW_ENCODED_SLASH","true");
  System.setProperty("org.apache.catalina.startup.EXIT_ON_INIT_FAILURE","true");
  System.setProperty("SONAR_HOME",env.rootDir().getAbsolutePath());
  tomcat=new Tomcat();
  String basedir=env.freshDir(TEMP_RELATIVE_PATH).getCanonicalPath();
  tomcat.setBaseDir(basedir);
  tomcat.getHost().setAppBase(basedir);
  tomcat.getHost().setAutoDeploy(false);
  tomcat.getHost().setCreateDirs(false);
  tomcat.getHost().setDeployOnStartup(true);
  Props props=Props.create(env);
  Logging.configure(tomcat,env,props);
  Connectors.configure(tomcat,props);
  Webapp.configure(tomcat,env,props);
  tomcat.start();
  addShutdownHook();
  ready=true;
  tomcat.getServer().await();
  stop();
}
