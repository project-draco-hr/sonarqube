{
  Multimap<String,FileSourceDb.Test.Builder> testsByName=buildDbTests(context,component);
  Table<String,String,FileSourceDb.Test.CoveredFile.Builder> coveredFilesByName=loadCoverageDetails(component.getRef(),context);
  List<FileSourceDb.Test> tests=addCoveredFilesToTests(testsByName,coveredFilesByName);
  if (checkIfThereAreUnprocessedCoverageDetails(testsByName,coveredFilesByName,component)) {
    context.hasUnprocessedCoverageDetails=true;
  }
  if (tests.isEmpty()) {
    return;
  }
  String componentUuid=context.getUuid(component.getRef());
  FileSourceDto existingDto=context.existingFileSourcesByUuid.get(componentUuid);
  long now=system.now();
  if (existingDto != null) {
    existingDto.setTestData(tests).setUpdatedAt(now);
    dbClient.fileSourceDao().update(context.session,existingDto);
  }
 else {
    FileSourceDto newDto=new FileSourceDto().setTestData(tests).setFileUuid(componentUuid).setProjectUuid(context.getUuid(context.context.getReportMetadata().getRootComponentRef())).setDataType(Type.TEST).setCreatedAt(now).setUpdatedAt(now);
    dbClient.fileSourceDao().insert(context.session,newDto);
  }
}
