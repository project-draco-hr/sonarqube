{
  userSessionRule.setGlobalPermissions(GlobalPermissions.SCAN_EXECUTION);
  AnalysisReportDto dto=mock(AnalysisReportDto.class);
  when(dto.getId()).thenReturn(42L);
  when(queue.add(any(String.class),any(String.class),any(InputStream.class))).thenReturn(new ReportQueue.Item(dto,null));
  WsTester.TestRequest request=wsTester.newPostRequest(ComputationWs.ENDPOINT,"submit_report").setParam(SubmitReportAction.PARAM_PROJECT_KEY,"P1").setParam(SubmitReportAction.PARAM_PROJECT_NAME,"Project 1").setParam(SubmitReportAction.PARAM_REPORT_DATA,null);
  WsTester.Result response=request.execute();
  verify(queue).add(eq("P1"),eq("Project 1"),any(InputStream.class));
  verify(workerLauncher).startAnalysisTaskNow();
  verify(queueStatus).addReceived();
  assertThat(response.outputAsString()).isEqualTo("{\"key\":\"42\"}");
}
