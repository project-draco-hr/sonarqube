{
  RuleDto rule=newRule();
  ComponentDto project=newProject();
  ComponentDto file=newFile(project);
  MockUserSession.set().setLogin("john").addProjectPermissions(UserRole.USER,project.key());
  IssueDto issue=saveIssue(IssueTesting.newDto(rule,file,project));
  String actionPlanKey="EFGH";
  db.actionPlanDao().save(new ActionPlanDto().setKey(actionPlanKey).setProjectId(project.getId()));
  session.commit();
  index();
  assertThat(IssueIndex.getByKey(issue.getKey()).actionPlanKey()).isNull();
  service.plan(issue.getKey(),actionPlanKey);
  assertThat(IssueIndex.getByKey(issue.getKey()).actionPlanKey()).isEqualTo(actionPlanKey);
}
