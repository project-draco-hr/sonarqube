{
  RuleDto rule=RuleTesting.newXooX1();
  tester.get(RuleDao.class).insert(dbSession,rule);
  ComponentDto project=ComponentTesting.newProjectDto();
  tester.get(ComponentDao.class).insert(dbSession,project);
  dbSession.commit();
  MockUserSession.set().setLogin("admin").setGlobalPermissions(GlobalPermissions.SYSTEM_ADMIN);
  tester.get(InternalPermissionService.class).addPermission(new PermissionChange().setComponentKey(project.getKey()).setGroup(DefaultGroups.ANYONE).setPermission(UserRole.USER));
  ComponentDto file=ComponentTesting.newFileDto(project);
  tester.get(ComponentDao.class).insert(dbSession,file);
  IssueDto issue=IssueTesting.newDto(rule,file,project).setIssueAttributes(KeyValueFormat.format(ImmutableMap.of("key","value")));
  dbClient.issueDao().insert(dbSession,issue);
  dbSession.commit();
  assertThat(indexClient.get(IssueIndex.class).countAll()).isEqualTo(1);
  Issue issueDoc=indexClient.get(IssueIndex.class).getByKey(issue.getKey());
  assertThat(issueDoc.actionPlanKey()).isEqualTo(issue.getActionPlanKey());
  assertThat(issueDoc.assignee()).isEqualTo(issue.getAssignee());
  assertThat(issueDoc.authorLogin()).isEqualTo(issue.getAuthorLogin());
  assertThat(issueDoc.closeDate()).isEqualTo(issue.getIssueCloseDate());
  assertThat(issueDoc.effortToFix()).isEqualTo(issue.getEffortToFix());
  assertThat(issueDoc.resolution()).isEqualTo(issue.getResolution());
  assertThat(issueDoc.ruleKey()).isEqualTo(RuleKey.of(issue.getRuleRepo(),issue.getRule()));
  assertThat(issueDoc.line()).isEqualTo(issue.getLine());
  assertThat(issueDoc.message()).isEqualTo(issue.getMessage());
  assertThat(issueDoc.reporter()).isEqualTo(issue.getReporter());
  assertThat(issueDoc.key()).isEqualTo(issue.getKey());
  assertThat(issueDoc.updateDate()).isEqualTo(issue.getIssueUpdateDate());
  assertThat(issueDoc.status()).isEqualTo(issue.getStatus());
  assertThat(issueDoc.severity()).isEqualTo(issue.getSeverity());
  assertThat(issueDoc.attributes()).isEqualTo(KeyValueFormat.parse(issue.getIssueAttributes()));
  assertThat(issueDoc.attribute("key")).isEqualTo("value");
}
