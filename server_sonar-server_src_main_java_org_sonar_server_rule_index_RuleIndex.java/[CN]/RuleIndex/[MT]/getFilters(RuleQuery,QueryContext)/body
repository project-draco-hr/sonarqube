{
  Map<String,FilterBuilder> filters=new HashMap<>();
  filters.put(RuleNormalizer.RuleField.STATUS.field(),FilterBuilders.boolFilter().mustNot(FilterBuilders.termFilter(RuleNormalizer.RuleField.STATUS.field(),RuleStatus.REMOVED.toString())));
  if (!StringUtils.isEmpty(query.getInternalKey())) {
    filters.put(RuleNormalizer.RuleField.INTERNAL_KEY.field(),FilterBuilders.termFilter(RuleNormalizer.RuleField.INTERNAL_KEY.field(),query.getInternalKey()));
  }
  if (!StringUtils.isEmpty(query.getRuleKey())) {
    filters.put(RuleNormalizer.RuleField.RULE_KEY.field(),FilterBuilders.termFilter(RuleNormalizer.RuleField.RULE_KEY.field(),query.getRuleKey()));
  }
  if (!CollectionUtils.isEmpty(query.getLanguages())) {
    filters.put(RuleNormalizer.RuleField.LANGUAGE.field(),FilterBuilders.termsFilter(RuleNormalizer.RuleField.LANGUAGE.field(),query.getLanguages()));
  }
  if (!CollectionUtils.isEmpty(query.getRepositories())) {
    filters.put(RuleNormalizer.RuleField.REPOSITORY.field(),FilterBuilders.termsFilter(RuleNormalizer.RuleField.REPOSITORY.field(),query.getRepositories()));
  }
  if (!CollectionUtils.isEmpty(query.getSeverities())) {
    filters.put(RuleNormalizer.RuleField.SEVERITY.field(),FilterBuilders.termsFilter(RuleNormalizer.RuleField.SEVERITY.field(),query.getSeverities()));
  }
  if (!StringUtils.isEmpty(query.getKey())) {
    filters.put(RuleNormalizer.RuleField.KEY.field(),FilterBuilders.termFilter(RuleNormalizer.RuleField.KEY.field(),query.getKey()));
  }
  if (!CollectionUtils.isEmpty(query.getTags())) {
    filters.put(RuleNormalizer.RuleField.ALL_TAGS.field(),FilterBuilders.termsFilter(RuleNormalizer.RuleField.ALL_TAGS.field(),query.getTags()));
  }
  Collection<String> debtCharacteristics=query.getDebtCharacteristics();
  if (debtCharacteristics != null && !debtCharacteristics.isEmpty()) {
    filters.put(FILTER_DEBT_CHARACTERISTICS,FilterBuilders.boolFilter().must(FilterBuilders.orFilter(FilterBuilders.andFilter(FilterBuilders.notFilter(FilterBuilders.termsFilter(RuleNormalizer.RuleField.SUB_CHARACTERISTIC.field(),DebtCharacteristic.NONE)),FilterBuilders.orFilter(FilterBuilders.termsFilter(RuleNormalizer.RuleField.SUB_CHARACTERISTIC.field(),debtCharacteristics),FilterBuilders.termsFilter(RuleNormalizer.RuleField.CHARACTERISTIC.field(),debtCharacteristics))))));
  }
  Boolean hasDebtCharacteristic=query.getHasDebtCharacteristic();
  if (hasDebtCharacteristic != null) {
    if (hasDebtCharacteristic) {
      filters.put(FILTER_HAS_DEBT_CHARACTERISTICS,FilterBuilders.boolFilter().mustNot(FilterBuilders.termsFilter(RuleNormalizer.RuleField.SUB_CHARACTERISTIC.field(),DebtCharacteristic.NONE)).should(FilterBuilders.existsFilter(RuleNormalizer.RuleField.SUB_CHARACTERISTIC.field())).should(FilterBuilders.existsFilter(RuleNormalizer.RuleField.DEFAULT_SUB_CHARACTERISTIC.field())));
    }
 else {
      filters.put(FILTER_HAS_DEBT_CHARACTERISTICS,FilterBuilders.orFilter(FilterBuilders.termsFilter(RuleNormalizer.RuleField.SUB_CHARACTERISTIC.field(),DebtCharacteristic.NONE),FilterBuilders.andFilter(FilterBuilders.missingFilter(RuleNormalizer.RuleField.SUB_CHARACTERISTIC.field()),FilterBuilders.missingFilter(RuleNormalizer.RuleField.DEFAULT_SUB_CHARACTERISTIC.field()))));
    }
  }
  if (query.getAvailableSince() != null) {
    filters.put("availableSince",FilterBuilders.rangeFilter(RuleNormalizer.RuleField.CREATED_AT.field()).gte(query.getAvailableSince()));
  }
  Collection<RuleStatus> statusValues=query.getStatuses();
  if (statusValues != null && !statusValues.isEmpty()) {
    Collection<String> stringStatus=new ArrayList<>();
    for (    RuleStatus status : statusValues) {
      stringStatus.add(status.name());
    }
    filters.put(RuleNormalizer.RuleField.STATUS.field(),FilterBuilders.termsFilter(RuleNormalizer.RuleField.STATUS.field(),stringStatus));
  }
  Boolean isTemplate=query.isTemplate();
  if (isTemplate != null) {
    filters.put(RuleNormalizer.RuleField.IS_TEMPLATE.field(),FilterBuilders.termFilter(RuleNormalizer.RuleField.IS_TEMPLATE.field(),Boolean.toString(isTemplate)));
  }
  String template=query.templateKey();
  if (template != null) {
    filters.put(RuleNormalizer.RuleField.TEMPLATE_KEY.field(),FilterBuilders.termFilter(RuleNormalizer.RuleField.TEMPLATE_KEY.field(),template));
  }
  BoolFilterBuilder childrenFilter=FilterBuilders.boolFilter();
  this.addTermFilter(childrenFilter,ActiveRuleNormalizer.ActiveRuleField.PROFILE_KEY.field(),query.getQProfileKey());
  this.addTermFilter(childrenFilter,ActiveRuleNormalizer.ActiveRuleField.INHERITANCE.field(),query.getInheritance());
  this.addTermFilter(childrenFilter,ActiveRuleNormalizer.ActiveRuleField.SEVERITY.field(),query.getActiveSeverities());
  FilterBuilder childQuery;
  if (childrenFilter.hasClauses()) {
    childQuery=childrenFilter;
  }
 else {
    childQuery=FilterBuilders.matchAllFilter();
  }
  if (Boolean.TRUE.equals(query.getActivation())) {
    filters.put("activation",FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),childQuery));
  }
 else   if (Boolean.FALSE.equals(query.getActivation())) {
    filters.put("activation",FilterBuilders.boolFilter().mustNot(FilterBuilders.hasChildFilter(IndexDefinition.ACTIVE_RULE.getIndexType(),childQuery)));
  }
  return filters;
}
