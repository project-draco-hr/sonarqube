{
  Map<String,AggregationBuilder> aggregations=new HashMap<String,AggregationBuilder>();
  StickyFacetBuilder stickyFacetBuilder=stickyFacetBuilder(queryBuilder,filters);
  if (options.facets().contains("languages") || options.facets().contains("true")) {
    Collection<String> languages=query.getLanguages();
    aggregations.put(FACET_LANGUAGES,stickyFacetBuilder.buildStickyFacet(RuleNormalizer.RuleField.LANGUAGE.field(),FACET_LANGUAGES,languages == null ? new String[0] : languages.toArray()));
  }
  if (options.facets().contains("tags") || options.facets().contains("true")) {
    Collection<String> tags=query.getTags();
    aggregations.put(FACET_TAGS,stickyFacetBuilder.buildStickyFacet(RuleNormalizer.RuleField.ALL_TAGS.field(),FACET_TAGS,tags == null ? new String[0] : tags.toArray()));
  }
  if (options.facets().contains("repositories") || options.facets().contains("true")) {
    Collection<String> repositories=query.getRepositories();
    aggregations.put(FACET_REPOSITORIES,stickyFacetBuilder.buildStickyFacet(RuleNormalizer.RuleField.REPOSITORY.field(),FACET_REPOSITORIES,repositories == null ? new String[0] : repositories.toArray()));
  }
  return aggregations;
}
