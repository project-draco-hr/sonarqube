{
  SqlSession session=myBatis.openSession();
  try {
    removeAllPermissions(resourceId,session);
    PermissionTemplateDto permissionTemplate=getPermissionTemplate(templateKey);
    List<PermissionTemplateUserDto> usersPermissions=permissionTemplate.getUsersPermissions();
    if (usersPermissions != null) {
      for (      PermissionTemplateUserDto userPermission : usersPermissions) {
        addUserPermission(resourceId,userPermission.getUserLogin(),userPermission.getPermission(),session);
      }
    }
    List<PermissionTemplateGroupDto> groupsPermissions=permissionTemplate.getGroupsPermissions();
    if (groupsPermissions != null) {
      for (      PermissionTemplateGroupDto groupPermission : groupsPermissions) {
        String groupName=groupPermission.getGroupName() == null ? DefaultGroups.ANYONE : groupPermission.getGroupName();
        addGroupPermission(resourceId,groupName,groupPermission.getPermission(),session);
      }
    }
    session.commit();
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
