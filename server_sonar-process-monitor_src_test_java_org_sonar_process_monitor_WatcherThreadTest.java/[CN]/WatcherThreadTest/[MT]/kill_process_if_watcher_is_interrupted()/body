{
  ProcessRef ref=mock(ProcessRef.class,Mockito.RETURNS_DEEP_STUBS);
  final AtomicBoolean waiting=new AtomicBoolean(false);
  when(ref.getProcess().waitFor()).thenAnswer(new Answer<Object>(){
    @Override public Object answer(    InvocationOnMock invocationOnMock) throws Throwable {
      waiting.set(true);
      Thread.sleep(Long.MAX_VALUE);
      return 0;
    }
  }
);
  Monitor monitor=mock(Monitor.class);
  WatcherThread watcher=new WatcherThread(ref,monitor);
  watcher.start();
  while (!waiting.get()) {
    Thread.sleep(50L);
  }
  watcher.interrupt();
  verify(ref).hardKill();
}
