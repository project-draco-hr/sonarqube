{
  LOGGER.info(String.format("Create index %s",index.getName()));
  ImmutableSettings.Builder settings=ImmutableSettings.builder();
  settings.put(index.getSettings());
  settings.put(SETTING_HASH,new IndexHash().of(index));
  CreateIndexResponse indexResponse=client.prepareCreate(index.getName()).setSettings(settings).get();
  if (!indexResponse.isAcknowledged()) {
    throw new IllegalStateException("Failed to create index " + index.getName());
  }
  client.prepareHealth().setWaitForEvents(Priority.LANGUID).setWaitForGreenStatus().get();
  for (  Map.Entry<String,IndexRegistry.IndexType> entry : index.getTypes().entrySet()) {
    LOGGER.info(String.format("Create type %s/%s",index.getName(),entry.getKey()));
    PutMappingResponse mappingResponse=client.preparePutMapping(index.getName()).setType(entry.getKey()).setIgnoreConflicts(false).setSource(entry.getValue().getAttributes()).get();
    if (!mappingResponse.isAcknowledged()) {
      throw new IllegalStateException("Failed to create type " + entry.getKey());
    }
  }
}
