{
  ComponentDto project1=ComponentTesting.newProjectDto().setKey("project1");
  ComponentDto project2=ComponentTesting.newProjectDto().setKey("project2");
  ComponentDto project3=ComponentTesting.newProjectDto().setKey("project3");
  ComponentDto file1=ComponentTesting.newFileDto(project1).setKey("file1");
  ComponentDto file2=ComponentTesting.newFileDto(project1).setKey("file2");
  ComponentDto file3=ComponentTesting.newFileDto(project1).setKey("file3");
  tester.get(ComponentDao.class).insert(session,project1,project2,project3,file1,file2,file3);
  GroupDto userGroup=new GroupDto().setName("sonar-users");
  db.groupDao().insert(session,userGroup);
  GroupDto adminGroup=new GroupDto().setName("sonar-admins");
  db.groupDao().insert(session,adminGroup);
  session.commit();
  MockUserSession.set().setLogin("admin").setGlobalPermissions(GlobalPermissions.SYSTEM_ADMIN);
  tester.get(InternalPermissionService.class).addPermission(new PermissionChange().setComponentKey(project1.getKey()).setGroup(userGroup.getName()).setPermission(UserRole.USER));
  tester.get(InternalPermissionService.class).addPermission(new PermissionChange().setComponentKey(project2.getKey()).setGroup(adminGroup.getName()).setPermission(UserRole.USER));
  db.issueDao().insert(session,IssueTesting.newDto(rule,file1,project1),IssueTesting.newDto(rule,file2,project2),IssueTesting.newDto(rule,file3,project3));
  session.commit();
  session.clearCache();
  index();
  IssueQuery.Builder query=IssueQuery.builder();
  MockUserSession.set().setUserGroups("sonar-users");
  assertThat(index.search(query.build(),new QueryContext()).getHits()).hasSize(1);
  MockUserSession.set().setUserGroups("sonar-admins");
  assertThat(index.search(query.build(),new QueryContext()).getHits()).hasSize(1);
  MockUserSession.set().setUserGroups("sonar-users","sonar-admins");
  assertThat(index.search(query.build(),new QueryContext()).getHits()).hasSize(2);
  MockUserSession.set().setUserGroups("another group");
  assertThat(index.search(query.build(),new QueryContext()).getHits()).hasSize(0);
  MockUserSession.set().setUserGroups("sonar-users","sonar-admins");
  assertThat(index.search(query.componentRootUuids(newArrayList(project3.key())).build(),new QueryContext()).getHits()).hasSize(0);
}
