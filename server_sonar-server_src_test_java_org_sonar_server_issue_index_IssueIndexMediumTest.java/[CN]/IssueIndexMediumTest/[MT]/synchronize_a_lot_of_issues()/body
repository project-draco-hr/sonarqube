{
  Integer numberOfIssues=1000;
  List<String> issueKeys=newArrayList();
  for (int i=0; i < numberOfIssues; i++) {
    IssueDto issue=IssueTesting.newDto(rule,file,project);
    tester.get(IssueDao.class).insert(session,issue);
    issueKeys.add(issue.getKey());
  }
  session.commit();
  assertThat(db.issueDao().findAfterDate(session,new Date(0))).hasSize(numberOfIssues);
  assertThat(index.countAll()).isEqualTo(numberOfIssues);
  tester.get(BackendCleanup.class).clearIndex(IndexDefinition.ISSUES);
  tester.clearIndexes();
  assertThat(index.countAll()).isEqualTo(0);
  DbSession newSession=db.openSession(true);
  try {
    db.issueDao().synchronizeAfter(newSession,index.getLastSynchronization());
    newSession.commit();
  }
  finally {
    newSession.close();
  }
  assertThat(index.countAll()).isEqualTo(numberOfIssues);
}
