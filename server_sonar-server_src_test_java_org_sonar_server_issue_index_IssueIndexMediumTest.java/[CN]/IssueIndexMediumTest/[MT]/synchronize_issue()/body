{
  IssueDto issue=IssueTesting.newDto(rule,file,project);
  tester.get(IssueDao.class).insert(session,issue);
  session.commit();
  assertThat(db.issueDao().findAfterDate(session,new Date(0))).hasSize(1);
  assertThat(index.countAll()).isEqualTo(1);
  tester.get(BackendCleanup.class).clearIndex(IndexDefinition.ISSUES);
  tester.clearIndexes();
  assertThat(index.countAll()).isEqualTo(0);
  DbSession newSession=db.openSession(true);
  try {
    db.issueDao().synchronizeAfter(newSession,index.getLastSynchronization());
    newSession.commit();
  }
  finally {
    newSession.close();
  }
  assertThat(index.countAll()).isEqualTo(1);
}
