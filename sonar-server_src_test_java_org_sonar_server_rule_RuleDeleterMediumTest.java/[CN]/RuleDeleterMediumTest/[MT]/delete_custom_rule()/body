{
  RuleDto templateRule=RuleTesting.newTemplateRule(RuleKey.of("java","S001")).setLanguage("xoo");
  dao.insert(dbSession,templateRule);
  RuleDto customRule=RuleTesting.newCustomRule(templateRule).setLanguage("xoo");
  dao.insert(dbSession,customRule);
  QualityProfileDto profileDto=QualityProfileDto.createFor(QualityProfileKey.of("P1","xoo"));
  db.qualityProfileDao().insert(dbSession,profileDto);
  dbSession.commit();
  tester.get(RuleActivator.class).activate(new RuleActivation(ActiveRuleKey.of(profileDto.getKey(),customRule.getKey())).setSeverity(Severity.BLOCKER));
  deleter.delete(customRule.getKey());
  Rule customRuleReloaded=index.getByKey(customRule.getKey());
  assertThat(customRuleReloaded).isNotNull();
  assertThat(customRuleReloaded.status()).isEqualTo(RuleStatus.REMOVED);
  List<ActiveRule> activeRules=tester.get(ActiveRuleIndex.class).findByProfile(profileDto.getKey());
  assertThat(activeRules).isEmpty();
}
