{
  List<String[]> rows=select(connection,"select table_name, column_name, collation_name " + "from information_schema.columns " + "where table_schema='public' "+ "and udt_name='varchar' "+ "order by table_name, column_name",new SqlExecutor.StringsConverter(3));
  boolean mustCheckGlobalCollation=false;
  List<String> errors=new ArrayList<>();
  for (  String[] row : rows) {
    if (StringUtils.isBlank(row[2])) {
      mustCheckGlobalCollation=true;
    }
 else     if (!containsIgnoreCase(row[2],UTF8)) {
      errors.add(format("%s.%s",row[0],row[1]));
    }
  }
  if (mustCheckGlobalCollation) {
    String charset=selectSingleString(connection,"SELECT pg_encoding_to_char(encoding) FROM pg_database WHERE datname = current_database()");
    if (!containsIgnoreCase(charset,UTF8)) {
      throw MessageException.of(format("Database collation is %s. It must support UTF8.",charset));
    }
  }
  if (!errors.isEmpty()) {
    throw MessageException.of(format("Database columns [%s] must support UTF8 collation.",Joiner.on(", ").join(errors)));
  }
}
