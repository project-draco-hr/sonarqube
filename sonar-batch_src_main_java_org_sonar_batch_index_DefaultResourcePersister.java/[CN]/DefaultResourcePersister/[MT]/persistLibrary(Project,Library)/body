{
  ResourceModel model=findOrCreateModel(library);
  model=session.save(model);
  library.setId(model.getId());
  library.setEffectiveKey(library.getKey());
  Snapshot snapshot=findLibrarySnapshot(model.getId(),library.getVersion());
  if (snapshot == null) {
    snapshot=new Snapshot(model,null);
    snapshot.setCreatedAt(project.getAnalysisDate());
    snapshot.setBuildDate(new Date());
    snapshot.setVersion(library.getVersion());
    snapshot.setStatus(Snapshot.STATUS_PROCESSED);
    snapshot.setQualifier(Qualifiers.LIBRARY);
    snapshot=session.save(snapshot);
  }
  session.commit();
  return snapshot;
}
