{
  ResourceModel model;
  try {
    model=session.getSingleResult(ResourceModel.class,"key",resource.getEffectiveKey());
    if (model == null && !StringUtils.equals(resource.getEffectiveKey(),resource.getDeprecatedEffectiveKey())) {
      model=session.getSingleResult(ResourceModel.class,"key",resource.getDeprecatedEffectiveKey(),"deprecatedKey",null);
    }
    if (model == null) {
      if (StringUtils.isBlank(resource.getEffectiveKey())) {
        throw new SonarException("Unable to persist resource " + resource.toString() + ". Resource effective key is blank. This may be caused by an outdated plugin.");
      }
      model=createModel(resource);
    }
 else {
      mergeModel(model,resource);
    }
    return model;
  }
 catch (  NonUniqueResultException e) {
    throw new SonarException("The resource '" + resource.getEffectiveKey() + "' is duplicated in database.",e);
  }
}
