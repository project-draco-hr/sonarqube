{
  ResourceModel model;
  try {
    if (rootModuleId != null && StringUtils.isNotBlank(resource.getPath())) {
      model=session.getSingleResult(ResourceModel.class,"rootId",rootModuleId,"path",resource.getPath());
    }
 else {
      model=session.getSingleResult(ResourceModel.class,"key",resource.getEffectiveKey());
    }
    if (model == null) {
      model=createModel(resource);
    }
 else {
      mergeModel(model,resource);
    }
    return model;
  }
 catch (  NonUniqueResultException e) {
    throw new SonarException("The resource '" + resource.getEffectiveKey() + "' is duplicated in database.",e);
  }
}
