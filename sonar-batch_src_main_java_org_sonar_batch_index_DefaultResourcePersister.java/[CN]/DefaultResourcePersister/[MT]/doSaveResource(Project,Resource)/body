{
  String databaseKey=getDatabaseKey(project,resource);
  ResourceModel model=findOrCreateModel(resource,databaseKey);
  Snapshot projectSnapshot=snapshotsByResource.get(project);
  model.setRootId(projectSnapshot.getResourceId());
  model=session.save(model);
  resource.setId(model.getId());
  resource.setEffectiveKey(databaseKey);
  Snapshot parentSnapshot=(Snapshot)ObjectUtils.defaultIfNull(getSnapshot(resource.getParent()),projectSnapshot);
  Snapshot snapshot=new Snapshot(model,parentSnapshot);
  snapshot=session.save(snapshot);
  session.commit();
  snapshotsByResource.put(resource,snapshot);
  return snapshot;
}
