{
  checkPermission(userSession);
  SonarSession session=myBatis.openSession();
  try {
    rule.setStatus(Rule.STATUS_REMOVED).setUpdatedAt(new Date(system.now()));
    ruleDao.update(rule,session);
    session.commit();
    reindexRule(rule,session);
    List<ActiveRuleDto> activeRules=activeRuleDao.selectByRuleId(rule.getId());
    for (    ActiveRuleDto activeRule : activeRules) {
      activeRuleDao.deleteParameters(activeRule.getId(),session);
    }
    activeRuleDao.deleteFromRule(rule.getId(),session);
    session.commit();
    esActiveRule.deleteActiveRules(newArrayList(Iterables.transform(activeRules,new Function<ActiveRuleDto,Integer>(){
      @Override public Integer apply(      ActiveRuleDto input){
        return input.getId();
      }
    }
)));
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
