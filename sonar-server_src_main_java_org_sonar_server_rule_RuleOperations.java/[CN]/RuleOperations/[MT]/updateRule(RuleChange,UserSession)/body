{
  checkPermission(userSession);
  SqlSession session=myBatis.openSession();
  try {
    boolean updated=false;
    RuleDto ruleDto=ruleDao.selectByKey(ruleChange.ruleKey(),session);
    if (ruleDto == null) {
      throw new NotFoundException(String.format("Unknown rule '%s'",ruleChange.ruleKey()));
    }
    String subCharacteristicKey=ruleChange.debtCharacteristicKey();
    if (!Strings.isNullOrEmpty(subCharacteristicKey)) {
      CharacteristicDto subCharacteristic=characteristicDao.selectByKey(subCharacteristicKey,session);
      if (subCharacteristic == null) {
        throw new NotFoundException(String.format("Unknown sub characteristic '%s'",ruleChange.debtCharacteristicKey()));
      }
      if (!subCharacteristic.getId().equals(ruleDto.getSubCharacteristicId()) && !subCharacteristic.getId().equals(ruleDto.getDefaultSubCharacteristicId())) {
        ruleDto.setSubCharacteristicId(subCharacteristic.getId());
        updated=true;
      }
      if (!isSameRemediationFunction(ruleChange,ruleDto.getRemediationFunction(),ruleDto.getRemediationCoefficient(),ruleDto.getRemediationOffset()) && !isSameRemediationFunction(ruleChange,ruleDto.getDefaultRemediationFunction(),ruleDto.getDefaultRemediationCoefficient(),ruleDto.getDefaultRemediationOffset())) {
        DefaultDebtRemediationFunction debtRemediationFunction=new DefaultDebtRemediationFunction(DebtRemediationFunction.Type.valueOf(ruleChange.debtRemediationFunction()),ruleChange.debtRemediationCoefficient(),ruleChange.debtRemediationOffset());
        ruleDto.setRemediationFunction(debtRemediationFunction.type().name());
        ruleDto.setRemediationCoefficient(debtRemediationFunction.coefficient());
        ruleDto.setRemediationOffset(debtRemediationFunction.offset());
        updated=true;
      }
    }
 else {
      if (!ruleDto.getSubCharacteristicId().equals(RuleDto.DISABLED_CHARACTERISTIC_ID)) {
        ruleDto.setSubCharacteristicId(RuleDto.DISABLED_CHARACTERISTIC_ID);
        ruleDto.setRemediationFunction(null);
        ruleDto.setRemediationCoefficient(null);
        ruleDto.setRemediationOffset(null);
        updated=true;
      }
    }
    if (updated) {
      ruleDto.setUpdatedAt(new Date(system.now()));
      ruleDao.update(ruleDto,session);
      session.commit();
      reindexRule(ruleDto,session);
    }
  }
 catch (  IllegalArgumentException e) {
    throw BadRequestException.of(e.getMessage());
  }
 finally {
    MyBatis.closeQuietly(session);
  }
}
