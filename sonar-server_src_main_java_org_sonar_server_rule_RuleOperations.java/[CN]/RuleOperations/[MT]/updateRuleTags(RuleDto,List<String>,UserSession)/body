{
  checkPermission(userSession);
  DbSession session=myBatis.openSession(false);
  try {
    Map<String,Long> neededTagIds=validateAndGetTagIds(newTags,session);
    final Integer ruleId=rule.getId();
    boolean ruleChanged=synchronizeTags(ruleId,newTags,neededTagIds,session);
    if (ruleChanged) {
      rule.setUpdatedAt(new Date(system.now()));
      ruleDao.update(rule,session);
      session.commit();
      reindexRule(rule,session);
    }
  }
  finally {
    MyBatis.closeQuietly(session);
  }
}
