{
  String componentUuid=wsRequest.param(PARAM_COMPONENT_UUID);
  DbSession dbSession=dbClient.openSession(false);
  try {
    List<CeQueueDto> dtos;
    if (componentUuid == null) {
      userSession.checkGlobalPermission(UserRole.ADMIN);
      dtos=dbClient.ceQueueDao().selectAllInAscOrder(dbSession);
    }
 else {
      if (userSession.hasGlobalPermission(GlobalPermissions.SYSTEM_ADMIN) || userSession.hasComponentUuidPermission(UserRole.ADMIN,componentUuid)) {
        dtos=dbClient.ceQueueDao().selectByComponentUuid(dbSession,componentUuid);
      }
 else {
        throw new ForbiddenException("Requires system administration permission");
      }
    }
    WsCe.QueueResponse.Builder wsResponseBuilder=WsCe.QueueResponse.newBuilder();
    wsResponseBuilder.addAllTasks(formatter.formatQueue(dbSession,dtos));
    WsUtils.writeProtobuf(wsResponseBuilder.build(),wsRequest,wsResponse);
  }
  finally {
    dbClient.closeSession(dbSession);
  }
}
