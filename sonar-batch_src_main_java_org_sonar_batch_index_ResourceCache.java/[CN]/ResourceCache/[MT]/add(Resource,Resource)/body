{
  String componentKey=resource.getEffectiveKey();
  Preconditions.checkState(!Strings.isNullOrEmpty(componentKey),"Missing resource effective key");
  BatchResource parent=parentResource != null ? get(parentResource.getEffectiveKey()) : null;
  BatchResource batchResource=new BatchResource(resources.size() + 1,resource,parent);
  if (!(resource instanceof Library)) {
    resources.put(componentKey,batchResource);
    if (parent == null) {
      root=batchResource;
    }
  }
 else {
    libraries.put((Library)resource,batchResource);
  }
  if (scanGraph != null && ResourceUtils.isPersistable(batchResource.resource())) {
    scanGraph.addComponent(batchResource.resource());
  }
  return batchResource;
}
