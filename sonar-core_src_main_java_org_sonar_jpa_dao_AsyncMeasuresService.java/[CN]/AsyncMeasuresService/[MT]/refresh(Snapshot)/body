{
  AsyncMeasuresDao dao=new AsyncMeasuresDao(session);
  Snapshot previousSnapshot=dao.getPreviousSnapshot(snapshot);
  Date datePreviousSnapshot=(previousSnapshot != null ? previousSnapshot.getCreatedAt() : null);
  List<AsyncMeasureSnapshot> previousAsyncMeasureSnapshots=dao.getPreviousAsyncMeasureSnapshots(snapshot.getResourceId(),datePreviousSnapshot,snapshot.getCreatedAt());
  if (previousSnapshot != null) {
    previousAsyncMeasureSnapshots.addAll(dao.getAsyncMeasureSnapshotsFromSnapshotId(previousSnapshot.getId(),getMetricIds(previousAsyncMeasureSnapshots)));
  }
  for (  AsyncMeasureSnapshot asyncMeasureSnapshot : purge(previousAsyncMeasureSnapshots)) {
    if (asyncMeasureSnapshot.getSnapshotId() == null) {
      dao.updateAsyncMeasureSnapshot(asyncMeasureSnapshot,snapshot);
    }
 else {
      dao.createAsyncMeasureSnapshot(asyncMeasureSnapshot.getMeasureId(),snapshot.getId(),asyncMeasureSnapshot.getMeasureDate(),snapshot.getCreatedAt(),asyncMeasureSnapshot.getMetricId(),asyncMeasureSnapshot.getProjectId());
    }
  }
  session.commit();
}
