{
  AsyncMeasureSnapshot nextAsyncMeasureSnapshot=dao.getNextAsyncMeasureSnapshot(measure.getProjectId(),measure.getMetricId(),measure.getMeasureDate());
  Date dateNextAsyncMeasure=(nextAsyncMeasureSnapshot != null) ? nextAsyncMeasureSnapshot.getMeasureDate() : null;
  List<AsyncMeasureSnapshot> nextAsyncMeasureSnapshots=dao.getNextAsyncMeasureSnapshotsUntilDate(measure,dateNextAsyncMeasure);
  if (!nextAsyncMeasureSnapshots.isEmpty()) {
    for (    AsyncMeasureSnapshot asyncMeasureSnapshot : nextAsyncMeasureSnapshots) {
      dao.createAsyncMeasureSnapshot(measure.getId(),asyncMeasureSnapshot.getSnapshotId(),measure.getMeasureDate(),asyncMeasureSnapshot.getSnapshotDate(),measure.getMetricId(),measure.getProjectId());
      dao.removeSnapshotFromAsyncMeasureSnapshot(asyncMeasureSnapshot);
    }
  }
 else {
    List<Snapshot> nextSnapshotsUntilDate=dao.getNextSnapshotsUntilDate(measure,dateNextAsyncMeasure);
    if (!nextSnapshotsUntilDate.isEmpty()) {
      for (      Snapshot nextSnapshot : nextSnapshotsUntilDate) {
        dao.createAsyncMeasureSnapshot(measure.getId(),nextSnapshot.getId(),measure.getMeasureDate(),nextSnapshot.getCreatedAt(),measure.getMetricId(),measure.getProjectId());
      }
    }
 else {
      dao.createAsyncMeasureSnapshot(measure.getId(),null,measure.getMeasureDate(),null,measure.getMetricId(),measure.getProjectId());
    }
  }
}
