{
  File fromResource=(File)resourceCache.get(dep.fromKey()).resource();
  File toResource=(File)resourceCache.get(dep.toKey()).resource();
  if (sonarIndex.getEdge(fromResource,toResource) != null) {
    throw new IllegalStateException("Dependency between " + dep.fromKey() + " and "+ dep.toKey()+ " was already saved.");
  }
  Directory fromParent=fromResource.getParent();
  Directory toParent=toResource.getParent();
  Dependency parentDep=null;
  if (!fromParent.equals(toParent)) {
    parentDep=sonarIndex.getEdge(fromParent,toParent);
    if (parentDep != null) {
      parentDep.setWeight(parentDep.getWeight() + 1);
    }
 else {
      parentDep=new Dependency(fromParent,toParent).setUsage(USES).setWeight(1);
      parentDep=sonarIndex.addDependency(parentDep);
    }
  }
  sonarIndex.addDependency(new Dependency(fromResource,toResource).setUsage(USES).setWeight(dep.weight()).setParent(parentDep));
}
