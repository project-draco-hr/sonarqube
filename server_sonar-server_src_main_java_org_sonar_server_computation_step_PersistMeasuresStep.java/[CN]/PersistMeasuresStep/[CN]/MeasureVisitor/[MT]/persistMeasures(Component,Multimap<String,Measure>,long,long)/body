{
  for (  Map.Entry<String,Collection<Measure>> measures : batchReportMeasures.asMap().entrySet()) {
    String metricKey=measures.getKey();
    if (FORBIDDEN_METRIC_KEYS.contains(metricKey)) {
      throw new IllegalStateException(String.format("Measures on metric '%s' cannot be send in the report",metricKey));
    }
    Metric metric=metricRepository.getByKey(metricKey);
    Predicate<Measure> notBestValueOptimization=Predicates.not(BestValueOptimization.from(metric,component));
    for (    Measure measure : from(measures.getValue()).filter(notBestValueOptimization)) {
      MeasureDto measureDto=MeasureToMeasureDto.INSTANCE.toMeasureDto(measure,metric,componentId,snapshotId);
      dbClient.measureDao().insert(session,measureDto);
    }
  }
}
