{
  File dir=temp.newFolder();
  BatchOutputWriter writer=new BatchOutputWriter(dir);
  writer.writeMetadata(BatchReport.Metadata.newBuilder().setRootComponentRef(1).setProjectKey("PROJECT_KEY").setAnalysisDate(150000000L).build());
  writer.writeComponent(BatchReport.Component.newBuilder().setRef(1).setType(Constants.ComponentType.PROJECT).setUuid("PROJECT_UUID").addChildRefs(2).addChildRefs(3).build());
  writer.writeComponent(BatchReport.Component.newBuilder().setRef(2).setType(Constants.ComponentType.FILE).setUuid("FILE1_UUID").build());
  writer.writeComponent(BatchReport.Component.newBuilder().setRef(3).setType(Constants.ComponentType.FILE).setUuid("FILE2_UUID").build());
  File zipFile=temp.newFile();
  ZipUtils.zipDir(dir,zipFile);
  AnalysisReportDto dto=new AnalysisReportDto();
  DbSession dbSession=dbTester.myBatis().openSession(false);
  try {
    dto.setProjectKey("PROJECT_KEY");
    dto.setCreatedAt(System.currentTimeMillis());
    dto.setSnapshotId(1L);
    dto.setStatus(AnalysisReportDto.Status.PENDING);
    FileInputStream inputStream=new FileInputStream(zipFile);
    dto.setData(inputStream);
    AnalysisReportDao dao=new AnalysisReportDao();
    dao.insert(dbSession,dto);
    inputStream.close();
    dbSession.commit();
    return dao.selectByProjectKey(dbSession,"PROJECT_KEY").get(0);
  }
  finally {
    dbSession.close();
  }
}
